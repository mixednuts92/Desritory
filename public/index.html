<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desritory V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #7c4dff;
            --primary-dim: rgba(124,77,255,0.15);
            --primary-glow: rgba(124,77,255,0.3);
            --bg: #0d0d10;
            --bg2: #111116;
            --bg3: #16161d;
            --surface: rgba(255,255,255,0.04);
            --surface-hover: rgba(255,255,255,0.07);
            --border: rgba(255,255,255,0.07);
            --border-hover: rgba(255,255,255,0.14);
            --text: rgba(255,255,255,0.9);
            --text-dim: rgba(255,255,255,0.45);
            --text-faint: rgba(255,255,255,0.22);
            --sidebar-w: 72px;
            --statusbar-h: 36px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }


        #layout {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: 1fr var(--statusbar-h);
            height: 100vh;
        }

        #sidebar {
            grid-row: 1 / 3;
            background: var(--bg2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 0;
            gap: 2px;
            z-index: 100;
        }

        .sidebar-logo {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 10px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .sidebar-logo:hover { transform: scale(1.1); }

        .sidebar-divider {
            width: 32px;
            height: 1px;
            background: var(--border);
            margin: 6px 0;
            flex-shrink: 0;
        }

        .nav-item {
            width: 52px;
            height: 52px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            border-radius: 10px;
            border: 1px solid transparent;
            transition: all 0.18s;
            position: relative;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .nav-item:hover {
            background: var(--surface-hover);
            border-color: var(--border-hover);
            color: var(--text);
        }

        .nav-item.active {
            background: var(--primary-dim);
            border-color: rgba(124,77,255,0.3);
            color: var(--primary);
        }

        .nav-item i {
            font-size: 17px;
            line-height: 1;
        }

        .nav-item span {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            line-height: 1;
        }

        .nav-item::after {
            content: attr(data-tip);
            position: absolute;
            left: calc(100% + 10px);
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            color: var(--text);
            font-size: 11px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transform: translateX(-4px);
            transition: all 0.15s;
            z-index: 9999;
        }

        .nav-item:hover::after {
            opacity: 1;
            transform: translateX(0);
        }

        .nav-badge {
            position: absolute;
            top: 6px; right: 6px;
            min-width: 16px; height: 16px;
            background: #ef4444;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            color: white;
            border: 1.5px solid var(--bg2);
        }

        .nav-badge.show { display: flex; }

        .sidebar-spacer { flex: 1; }

        #main {
            grid-column: 2;
            grid-row: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg);
        }

        #statusbar {
            grid-column: 2;
            grid-row: 2;
            background: var(--bg2);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
            font-size: 12px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.4} }

        .status-sep {
            color: var(--text-faint);
        }

        .status-spacer { flex: 1; }

        .status-time {
            font-weight: 600;
            color: var(--text);
        }

        #homeScreen {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 0;
            background: transparent;
            position: relative;
        }

        /* Sticker on the left */
        .home-sticker {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 170px;
            pointer-events: none;
        }

        .home-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .home-wordmark {
            font-size: clamp(36px, 5vw, 64px);
            font-weight: 700;
            letter-spacing: -1px;
            color: var(--text);
            margin-bottom: 4px;
        }

        .home-wordmark span { color: var(--primary); }

        .home-sub {
            font-size: 13px;
            color: var(--text-faint);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .home-cards {
            display: flex;
            gap: 10px;
        }

        .home-card {
            width: 100px;
            height: 90px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.18s;
            color: var(--text-dim);
        }

        .home-card:hover {
            background: var(--surface-hover);
            border-color: var(--border-hover);
            color: var(--text);
            transform: translateY(-2px);
        }

        .home-card i { font-size: 22px; }
        .home-card span { font-size: 11px; font-weight: 600; }

        .panel {
            display: none;
            flex-direction: column;
            height: 100%;
            animation: panelIn 0.2s ease;
        }

        .panel.active { display: flex; }

        @keyframes panelIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            height: 52px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
            flex-shrink: 0;
            background: var(--bg);
        }

        .panel-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }

        .panel-search {
            flex: 1;
            max-width: 300px;
            padding: 7px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text);
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: all 0.18s;
            margin-left: auto;
        }

        .panel-search:focus {
            border-color: var(--primary);
            background: var(--primary-dim);
        }

        .panel-search::placeholder { color: var(--text-faint); }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: transparent;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 14px;
        }

        .game-card {
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.22s cubic-bezier(0.34, 1.3, 0.64, 1);
            overflow: hidden;
            position: relative;
        }

        .game-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), transparent 60%);
            opacity: 0;
            transition: opacity 0.22s;
            z-index: 0;
            pointer-events: none;
        }

        .game-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0,0,0,0.5), 0 0 0 1px var(--primary);
        }

        .game-card:hover::before { opacity: 0.07; }

        .game-card-thumb {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
            background: var(--bg3);
        }

        .game-card-info {
            padding: 10px 12px 12px;
            position: relative;
            z-index: 1;
        }

        .game-card-icon {
            display: none;
        }

        .game-card-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-card-cat {
            font-size: 11px;
            color: var(--text-faint);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .proxy-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            height: 100%;
            background: transparent;
        }

        .proxy-search-row {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 500px;
        }

        .proxy-input {
            flex: 1;
            padding: 11px 15px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: all 0.18s;
        }

        .proxy-input:focus { border-color: var(--primary); background: var(--primary-dim); }
        .proxy-input::placeholder { color: var(--text-faint); }

        .proxy-go {
            padding: 11px 22px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }

        .proxy-go:hover { opacity: 0.82; }

        .proxy-quick {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 500px;
        }

        .proxy-quick-link {
            padding: 11px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 9px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.18s;
        }

        .proxy-quick-link:hover { background: var(--surface-hover); border-color: var(--border-hover); transform: translateY(-1px); }
        .proxy-quick-link span:first-child { font-size: 20px; }
        .proxy-quick-link span:last-child { font-size: 11px; color: var(--text-dim); font-weight: 500; }

        .proxy-iframe { width: 100%; height: 100%; border: none; display: none; }

        .chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-setup-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            height: 100%;
            padding: 40px 24px;
        }

        .chat-setup-title {
            font-size: 20px;
            font-weight: 700;
        }

        .chat-setup-sub {
            font-size: 12px;
            color: var(--text-faint);
            margin-top: -8px;
        }

        .setup-input {
            width: 100%;
            max-width: 280px;
            padding: 11px 15px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            text-align: center;
            transition: all 0.18s;
        }

        .setup-input:focus { border-color: var(--primary); }
        .setup-input::placeholder { color: var(--text-faint); }

        .setup-btn {
            padding: 11px 36px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }

        .setup-btn:hover { opacity: 0.82; }

        .chat-status {
            padding: 7px 16px;
            font-size: 11px;
            color: var(--text-faint);
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
        }

        .chat-status.connected { color: #22c55e; }
        .chat-status.error { color: #ef4444; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-msg {
            padding: 9px 12px;
            background: var(--surface);
            border: 1px solid transparent;
            border-radius: 8px;
            animation: msgIn 0.18s ease;
            position: relative;
            transition: all 0.15s;
        }

        .chat-msg:hover {
            background: var(--surface-hover);
            border-color: var(--border);
        }

        .chat-msg:hover .msg-actions { opacity: 1; }
        .chat-msg:hover .msg-time { opacity: 1; }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-actions {
            position: absolute;
            top: 6px; right: 8px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .msg-reply-btn {
            background: var(--surface-hover);
            border: 1px solid var(--border-hover);
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 10px;
            color: var(--text);
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.15s;
        }

        .msg-reply-btn:hover { background: var(--primary-dim); border-color: var(--primary); color: var(--primary); }

        .msg-reply-bar {
            background: var(--primary-dim);
            border-left: 2px solid var(--primary);
            padding: 4px 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 11px;
            color: var(--text-faint);
        }

        .msg-reply-bar strong { color: var(--primary); }

        .msg-username {
            font-size: 11px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2px;
        }

        .msg-text { font-size: 13px; color: var(--text); word-break: break-word; }
        .msg-image { max-width: 100%; max-height: 180px; border-radius: 6px; margin-top: 6px; cursor: pointer; }

        .msg-time {
            font-size: 10px;
            color: var(--text-faint);
            margin-top: 3px;
            opacity: 0;
            transition: opacity 0.15s;
            font-family: 'JetBrains Mono', monospace;
        }

        .typing-bar {
            padding: 5px 16px;
            font-size: 11px;
            color: var(--text-faint);
            display: none;
        }

        .typing-bar.on { display: block; }

        .typing-dots span {
            display: inline-block;
            width: 3px; height: 3px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 1px;
            animation: td 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes td { 0%,60%,100%{opacity:0.2;transform:translateY(0)} 30%{opacity:1;transform:translateY(-3px)} }

        .reply-bar {
            display: none;
            background: var(--primary-dim);
            border-left: 2px solid var(--primary);
            padding: 6px 12px;
            margin: 0 12px 4px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-faint);
            flex-shrink: 0;
            position: relative;
        }

        .reply-bar.on { display: block; }

        .cancel-reply {
            position: absolute;
            right: 8px; top: 50%;
            transform: translateY(-50%);
            background: none; border: none;
            color: var(--text-faint); cursor: pointer;
            font-size: 14px; transition: color 0.15s;
        }

        .cancel-reply:hover { color: var(--text); }

        .img-preview-wrap { padding: 0 12px 6px; }

        .img-preview { display: none; max-width: 100px; max-height: 70px; border-radius: 6px; }
        .img-preview.on { display: block; }

        .chat-input-row {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .img-btn {
            width: 34px; height: 34px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-faint);
            font-size: 13px;
            transition: all 0.18s;
        }

        .img-btn:hover { background: var(--surface-hover); border-color: var(--border-hover); color: var(--text); }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text);
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: border-color 0.18s;
        }

        .chat-input:focus { border-color: var(--primary); }
        .chat-input::placeholder { color: var(--text-faint); }

        .send-btn {
            padding: 8px 16px;
            background: var(--primary);
            border: none;
            border-radius: 7px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }

        .send-btn:hover { opacity: 0.82; }

        .settings-body { padding: 20px; }

        .s-section { margin-bottom: 24px; }

        .s-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-faint);
            margin-bottom: 10px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 7px;
        }

        .theme-swatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 9px 5px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 9px;
            cursor: pointer;
            transition: all 0.18s;
        }

        .theme-swatch:hover { background: var(--surface-hover); border-color: var(--border-hover); transform: translateY(-1px); }
        .theme-swatch.active { border-color: var(--primary); background: var(--primary-dim); }

        .swatch-dot {
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.12);
        }

        .swatch-name { font-size: 9px; color: var(--text-faint); font-weight: 600; }
        .theme-swatch.active .swatch-name { color: var(--text); }

        .se-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 7px;
        }

        .se-btn {
            padding: 9px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.18s;
            text-align: center;
            font-weight: 500;
        }

        .se-btn:hover { background: var(--surface-hover); color: var(--text); }
        .se-btn.active { background: var(--primary-dim); border-color: rgba(124,77,255,0.3); color: var(--primary); }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 11px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.18s;
        }

        .toggle-row:hover { background: var(--surface-hover); }
        .toggle-row-label { font-size: 13px; color: var(--text); }

        .toggle {
            width: 40px; height: 22px;
            background: rgba(255,255,255,0.12);
            border-radius: 11px;
            position: relative;
            transition: background 0.25s;
            flex-shrink: 0;
        }

        .toggle.on { background: var(--primary); }

        .toggle-knob {
            position: absolute;
            top: 3px; left: 3px;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.25s;
        }

        .toggle.on .toggle-knob { transform: translateX(18px); }

        .update-body { padding: 24px; }

        .update-ver {
            font-size: 38px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .update-sub { font-size: 13px; color: var(--text-faint); margin-bottom: 18px; }

        .update-notes {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            font-size: 13px;
            color: var(--text-dim);
            line-height: 1.9;
        }

        #fullscreenOverlay {
            position: fixed;
            top: 0; left: var(--sidebar-w); right: 0; bottom: var(--statusbar-h);
            background: var(--bg);
            z-index: 9000;
            display: none;
            flex-direction: column;
        }

        #fullscreenOverlay.active { display: flex; }

        .fs-bar {
            height: 44px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            flex-shrink: 0;
            background: var(--bg2);
        }

        .fs-back {
            padding: 6px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.18s;
        }

        .fs-back:hover { background: var(--surface-hover); color: var(--text); }

        .fs-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dim);
        }

        #fullscreenIframe { width: 100%; flex: 1; border: none; }

        #loadingScreen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(13,13,16,0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        #loadingScreen.on { display: flex; }

        .loader-ring {
            width: 44px; height: 44px;
            border: 2px solid var(--surface-hover);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 14px;
            color: var(--text-dim);
            font-weight: 500;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(6px);
            z-index: 12000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.on { display: flex; }

        .modal-box {
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            border-radius: 14px;
            padding: 28px;
            max-width: 380px;
            width: 90%;
            text-align: center;
        }

        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .modal-text { font-size: 13px; color: var(--text-dim); margin-bottom: 22px; line-height: 1.6; }
        .modal-text strong { color: var(--primary); }

        .modal-btns { display: flex; gap: 8px; justify-content: center; }

        .modal-btn {
            padding: 9px 24px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.18s;
        }

        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.primary:hover { opacity: 0.82; }
        .modal-btn.secondary { background: var(--surface-hover); color: var(--text-dim); border: 1px solid var(--border); }
        .modal-btn.secondary:hover { border-color: #ef4444; color: #ef4444; }

        .spinner {
            width: 40px; height: 40px;
            border: 2px solid var(--surface-hover);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin: 0 auto 16px;
        }

        .floating-warn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.92);
            border-radius: 12px;
            padding: 22px 30px;
            z-index: 14000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.25s;
            text-align: center;
        }

        .floating-warn.on { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all; }

        #spamWarn { background: rgba(239,68,68,0.97); border: 1.5px solid #dc2626; }
        #spamWarnText { font-size: 16px; font-weight: 700; color: white; }

        #slurWarn {
            background: var(--bg3);
            border: 1.5px solid var(--primary);
            box-shadow: 0 0 40px var(--primary-glow);
        }

        #slurWarn .sw-icon { font-size: 32px; margin-bottom: 10px; }
        #slurWarn .sw-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        #slurWarn .sw-text { font-size: 13px; color: var(--text-dim); margin-bottom: 10px; }
        #slurWarn .sw-timer { font-size: 28px; font-weight: 900; color: var(--primary); font-family: 'JetBrains Mono', monospace; }

        #bgCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0;
            display: block;
        }

        #layout { position: relative; z-index: 1; background: transparent; }
        #sidebar { background: rgba(17,17,22,0.88) !important; backdrop-filter: blur(14px); }
        #main { background: transparent !important; }
        #statusbar { background: rgba(17,17,22,0.88) !important; backdrop-filter: blur(14px); }
        .panel-header { background: rgba(13,13,16,0.6) !important; backdrop-filter: blur(8px); }
        .panel { background: transparent; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 2px; }

        .nav-item.stealth-on {
            background: rgba(124,77,255,0.1);
            border-color: rgba(124,77,255,0.2);
            color: var(--primary);
        }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div id="layout">

    <nav id="sidebar">
        <div class="sidebar-logo" onclick="showPanel('home')" title="Desritory">üõ°</div>

        <div class="nav-item active" id="nav-home" onclick="showPanel('home')" data-tip="Home">
            <i class="fas fa-house"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" id="nav-proxy" onclick="showPanel('proxy')" data-tip="Proxy">
            <i class="fas fa-shield-halved"></i>
            <span>Proxy</span>
        </div>
        <div class="nav-item" id="nav-games" onclick="showPanel('games')" data-tip="Games">
            <i class="fas fa-gamepad"></i>
            <span>Games</span>
        </div>
        <div class="nav-item" id="nav-apps" onclick="showPanel('apps')" data-tip="Apps">
            <i class="fas fa-grid-2"></i>
            <span>Apps</span>
        </div>

        <div class="sidebar-divider"></div>

        <div class="nav-item" id="nav-chat" onclick="showPanel('chat')" data-tip="Chat">
            <i class="fas fa-comments"></i>
            <span>Chat</span>
            <div class="nav-badge" id="chatBadge">0</div>
        </div>

        <div class="sidebar-spacer"></div>

        <div class="nav-item" id="nav-stealth" onclick="toggleStealth()" data-tip="Stealth Mode">
            <i class="fas fa-user-secret"></i>
            <span>Stealth</span>
        </div>
        <div class="nav-item" id="nav-updates" onclick="showPanel('updates')" data-tip="Updates">
            <i class="fas fa-bell"></i>
            <span>Updates</span>
        </div>
        <div class="nav-item" id="nav-settings" onclick="showPanel('settings')" data-tip="Settings">
            <i class="fas fa-gear"></i>
            <span>Settings</span>
        </div>
    </nav>

    <main id="main">

        <div class="panel active" id="panel-home">
            <div id="homeScreen">
               
                <div class="home-center">
                    <div class="home-wordmark">DESRIT<span>O</span>RY <span style="font-size:0.45em;font-weight:600;color:var(--text-faint);letter-spacing:1px;vertical-align:middle;border:1.5px solid var(--border-hover);border-radius:6px;padding:2px 8px;position:relative;top:-4px;">V4</span></div>
                    <div class="home-sub" id="homeSub">Welcome back</div>
                    <div class="home-cards">
                        <div class="home-card" onclick="showPanel('proxy')">
                            <i class="fas fa-shield-halved"></i>
                            <span>Proxy</span>
                        </div>
                        <div class="home-card" onclick="showPanel('games')">
                            <i class="fas fa-gamepad"></i>
                            <span>Games</span>
                        </div>
                        <div class="home-card" onclick="showPanel('chat')">
                            <i class="fas fa-comments"></i>
                            <span>Chat</span>
                        </div>
                        <div class="home-card" onclick="showPanel('settings')">
                            <i class="fas fa-gear"></i>
                            <span>Settings</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" id="panel-proxy">
            <div class="panel-header">
                <div class="panel-title">Proxy</div>
                <span style="font-size:11px;color:var(--text-faint);margin-left:auto;font-family:'JetBrains Mono',monospace;">Powered by Scramjet</span>
            </div>
            <div id="proxyHome" style="flex:1;overflow:hidden;">
                <div class="proxy-home">
                    <div style="font-size:13px;color:var(--text-faint);">Browse freely. No restrictions.</div>
                    <div class="proxy-search-row">
                        <input id="proxyInput" class="proxy-input" type="text" placeholder="Search or enter a URL..." onkeypress="if(e.key==='Enter')launchProxy()">
                        <button class="proxy-go" onclick="launchProxy()">Go</button>
                    </div>
                    <div class="proxy-quick">
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://google.com')"><span>üîç</span><span>Google</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://youtube.com')"><span>‚ñ∂Ô∏è</span><span>YouTube</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://discord.com')"><span>üí¨</span><span>Discord</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://github.com')"><span>ü§ñ</span><span>Github</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://spotify.com')"><span>üéµ</span><span>Spotify</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://twitter.com')"><span>üê¶</span><span>Twitter/X</span></div>
                    </div>
                </div>
            </div>
            <iframe id="proxyIframe" class="proxy-iframe"></iframe>
        </div>

        <div class="panel" id="panel-games">
            <div class="panel-header">
                <div class="panel-title">Games</div>
                <input class="panel-search" placeholder="Search games..." oninput="renderGames(this.value)" id="gamesSearch">
            </div>
            <div class="panel-body">
                <div class="games-grid" id="gamesList"></div>
            </div>
        </div>

        <div class="panel" id="panel-apps">
            <div class="panel-header">
                <div class="panel-title">Apps</div>
                <input class="panel-search" placeholder="Search apps..." oninput="renderApps(this.value)">
            </div>
            <div class="panel-body">
                <div class="games-grid" id="appsList"></div>
            </div>
        </div>

        <div class="panel" id="panel-chat">
            <div class="panel-header">
                <div class="panel-title">Chat Room</div>
                <div id="chatUserLabel" style="margin-left:auto;font-size:11px;color:var(--text-faint);font-family:'JetBrains Mono',monospace;"></div>
            </div>
            <div class="window-content" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
                <div class="chat-setup-screen" id="chatSetup" style="display:none;">
                    <div style="font-size:40px;">üí¨</div>
                    <div class="chat-setup-title">Join the Chat</div>
                    <div class="chat-setup-sub">Pick a username to get started</div>
                    <input type="text" id="chatSetupInput" class="setup-input" placeholder="Your username..." maxlength="20" onkeypress="if(event.key==='Enter')submitUsername()">
                    <button class="setup-btn" onclick="submitUsername()">Join ‚Üí</button>
                </div>
                <div class="chat-body" id="chatBody" style="display:none;">
                    <div class="chat-status" id="chatStatus">Connecting...</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="typing-bar" id="typingBar">
                        <span id="typingUsers"></span>
                        <span class="typing-dots"><span></span><span></span><span></span></span>
                    </div>
                    <div class="reply-bar" id="replyBar">
                        Replying to <strong id="replyToUser"></strong>
                        <button class="cancel-reply" onclick="cancelReply()">√ó</button>
                    </div>
                    <div class="img-preview-wrap">
                        <div style="position:relative;display:inline-block;">
                            <img id="imgPreview" class="img-preview">
                            <button onclick="removeImage()" id="removeImgBtn" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--primary);border:none;border-radius:50%;width:16px;height:16px;color:white;cursor:pointer;font-size:10px;align-items:center;justify-content:center;">√ó</button>
                        </div>
                    </div>
                    <div class="chat-input-row">
                        <label for="imageInput" class="img-btn" title="Upload image"><i class="fas fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Message... (try :heart: :fire: :skull:)" onkeypress="handleChatKey(event)" oninput="handleTyping()">
                        <button class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" id="panel-settings">
            <div class="panel-header">
                <div class="panel-title">Settings</div>
            </div>
            <div class="panel-body">
                <div class="settings-body">
                    <div class="s-section">
                        <div class="s-label">Theme</div>
                        <div class="theme-grid" id="themeGrid"></div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Search Engine</div>
                        <div class="se-row">
                            <button class="se-btn active" id="se-google" onclick="setSE('google',this)">Google</button>
                            <button class="se-btn" id="se-bing" onclick="setSE('bing',this)">Bing</button>
                            <button class="se-btn" id="se-ddg" onclick="setSE('ddg',this)">DuckDuckGo</button>
                            <button class="se-btn" id="se-yahoo" onclick="setSE('yahoo',this)">Yahoo</button>
                            <button class="se-btn" id="se-brave" onclick="setSE('brave',this)">Brave</button>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Options</div>
                        <div class="toggle-row" onclick="toggleCloak()">
    <span class="toggle-row-label">Tab Cloaking</span>
    <div class="toggle" id="cloakToggle"><div class="toggle-knob"></div></div>
</div>
<div id="cloakPresetRow" style="display:none;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;gap:10px;align-items:center;flex-wrap:wrap;">
    <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Cloak Preset</span>
    <select id="cloakPresetSelect" onchange="applyCloakPreset(this.value)" style="flex:1;padding:7px 10px;background:var(--bg3);border:1px solid var(--border-hover);border-radius:7px;color:var(--text);font-size:12px;font-family:'Outfit',sans-serif;outline:none;cursor:pointer;">
        <option value="google">Google</option>
        <option value="docs">Google Docs</option>
        <option value="canvas">Canvas</option>
        <option value="khan">Khan Academy</option>
        <option value="classroom">Google Classroom</option>
        <option value="desmos">Desmos</option>
        <option value="wikipedia">Wikipedia</option>
        <option value="schoology">Schoology</option>
    </select>
</div>
                        <div class="toggle-row" onclick="togglePanic()">
    <span class="toggle-row-label">Panic Key</span>
    <div class="toggle" id="panicToggle"><div class="toggle-knob"></div></div>
</div>
<div id="panicKeyRow" style="display:none;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;gap:10px;align-items:center;">
    <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Key to press</span>
    <input id="panicKeyInput" readonly placeholder="Click then press a key..."
        style="flex:1;padding:7px 10px;background:var(--bg3);border:1px solid var(--border-hover);border-radius:7px;color:var(--primary);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;cursor:pointer;text-align:center;"
        onclick="startKeyCapture()"
    >
</div>
                        <div class="toggle-row" onclick="toggleParticles()">
                            <span class="toggle-row-label">Show Particles</span>
                            <div class="toggle on" id="particlesToggle"><div class="toggle-knob"></div></div>
                        </div>
                        <div class="toggle-row" onclick="toggleSounds()">
                            <span class="toggle-row-label">Notification Sounds</span>
                            <div class="toggle" id="soundToggle"><div class="toggle-knob"></div></div>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Account</div>
                        <div class="toggle-row" onclick="changeUsername()">
                            <span class="toggle-row-label">Change Username <span id="usernameDisplay" style="color:var(--primary);font-size:11px;"></span></span>
                            <span style="color:var(--text-faint);font-size:12px;">‚Üí</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" id="panel-updates">
            <div class="panel-header">
                <div class="panel-title">Updates</div>
            </div>
            <div class="panel-body">
                <div class="update-body">
                    <div class="update-ver">v4.0.0</div>
                    <div class="update-sub">What's new in this update</div>
                    <div class="update-notes">
                        ‚Ä¢ Welcome to V3!!<br>
                        ‚Ä¢ New sidebar navigation ‚Äî Selenite-style layout<br>
                        ‚Ä¢ Status bar with live stats at the bottom<br>
                        ‚Ä¢ Panels replace floating windows ‚Äî cleaner UX<br>
                        ‚Ä¢ CHAT UPDATES:<br>
                        ‚Ä¢ Inline "Join the Chat" ‚Äî no more popups!<br>
                        ‚Ä¢ Timestamps hidden by default, shows on hover<br>
                        ‚Ä¢ Change your username anytime from Settings<br>
                        ‚Ä¢ SETTINGS UPDATES:<br>
                        ‚Ä¢ Theme picker now color swatches<br>
                        ‚Ä¢ Notification sounds toggle<br>
                        ‚Ä¢ Particle system saves battery when idle<br>
                        ‚Ä¢ that's all, enjoy V3!
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="statusbar">
        <div class="status-item">
            <div class="status-dot"></div>
            <span>Online</span>
        </div>
        <span class="status-sep">|</span>
        <div class="status-item">
            <i class="fas fa-users" style="font-size:10px;"></i>
            <span id="onlineCount">--</span> online
        </div>
        <span class="status-sep">|</span>
        <div class="status-item" id="stealthStatusBar" style="display:none;">
            <i class="fas fa-user-secret" style="font-size:10px;color:var(--primary);"></i>
            <span style="color:var(--primary);">Stealth</span>
        </div>
        <div class="status-spacer"></div>
        <div class="status-item">
            <span class="status-time" id="timeDisplay">12:00 AM</span>
        </div>
    </div>
</div>

<div id="fullscreenOverlay">
    <div class="fs-bar">
        <button class="fs-back" onclick="closeFullscreen()">‚Üê Back</button>
        <span class="fs-title" id="fsTitle"></span>
    </div>
    <iframe id="fullscreenIframe"></iframe>
</div>

<div id="loadingScreen">
    <div class="loader-ring"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<div class="modal-overlay" id="nameRequestModal">
    <div class="modal-box">
        <div class="modal-title">Name Request</div>
        <div class="modal-text"><strong id="nameRequesterDisplay">Someone</strong> wants to use the name <strong id="nameRequestedDisplay"></strong>. Allow this?</div>
        <div class="modal-btns">
            <button class="modal-btn primary" onclick="respondToNameRequest(true)">Allow</button>
            <button class="modal-btn secondary" onclick="respondToNameRequest(false)">Deny</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="nameWaitingModal">
    <div class="modal-box">
        <div class="spinner"></div>
        <div class="modal-title">Waiting for approval...</div>
        <div class="modal-text" id="nameWaitingText">The user with that name has been notified.</div>
    </div>
</div>

<div class="floating-warn" id="spamWarn">
    <div id="spamWarnText">Hey, stop spamming!!</div>
</div>

<div class="floating-warn" id="slurWarn">
    <div class="sw-icon">üö´</div>
    <div class="sw-title">Not allowed.</div>
    <div class="sw-text">That's not cool. Cooldown:</div>
    <div class="sw-timer" id="slurTimer">10</div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, push, onChildAdded, onChildChanged, onChildRemoved, limitToLast, query, remove, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCtWJWMhHL3ZZ8cyG6oYLJLLWRpqLHrdA",
        authDomain: "desritory-chat.firebaseapp.com",
        databaseURL: "https://desritory-chat-default-rtdb.firebaseio.com",
        projectId: "desritory-chat",
        storageBucket: "desritory-chat.firebasestorage.app",
        messagingSenderId: "799268069839",
        appId: "1:799268069839:web:4bcbfa0389603054bf32ba"
    };

    let db = null, isInit = false;
    let messagesRef, typingRef, presenceRef, activeNamesRef, nameRequestsRef;

    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        messagesRef = ref(db, 'messages');
        typingRef = ref(db, 'typing');
        presenceRef = ref(db, 'presence');
        activeNamesRef = ref(db, 'activeNames');
        nameRequestsRef = ref(db, 'nameRequests');
        isInit = true;
        const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const pRef = ref(db, `presence/${uid}`);
        set(pRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {});
        onDisconnect(pRef).remove();
        setInterval(() => { if (isInit) set(pRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {}); }, 30000);
        onValue(ref(db, 'presence'), (snap) => {
            const d = snap.val();
            const el = document.getElementById('onlineCount');
            if (el) el.textContent = d ? Object.keys(d).length : 0;
        });
    } catch (e) {
        console.error('Firebase error:', e);
        setChatStatus('error', 'üî¥ Firebase not configured');
    }

    window.firebaseChat = {
        sendMessage: (u, t, img=null, reply=null) => {
            if (!isInit) return Promise.reject();
            const d = { username: u, text: t, timestamp: serverTimestamp() };
            if (img) d.imageUrl = img;
            if (reply) d.replyTo = reply;
            return push(messagesRef, d);
        },
        listenToMessages: (cb) => {
            if (!isInit) return;
            onChildAdded(query(messagesRef, limitToLast(50)), (snap) => {
                const m = snap.val(); m.id = snap.key; cb(m);
            });
        },
        setTyping: (u, on) => {
            if (!isInit) return Promise.reject();
            const r = ref(db, `typing/${u.replace(/[.#$[\]]/g, '_')}`);
            return on ? set(r, { username: u, timestamp: serverTimestamp() }) : remove(r);
        },
        listenToTyping: (cb) => {
            if (!isInit) return;
            onChildAdded(typingRef, s => { const d = s.val(); if(d) cb(d.username, true); });
            onChildChanged(typingRef, s => { const d = s.val(); if(d) cb(d.username, true); });
            onChildRemoved(typingRef, s => { const d = s.val(); if(d) cb(d.username, false); });
        },
        isInitialized: () => isInit,
        checkNameAvailable: async (name) => {
            if (!isInit) return { available: true };
            const safe = name.replace(/[.#$[\]]/g, '_').toLowerCase();
            const snap = await get(ref(db, `activeNames/${safe}`));
            if (!snap.exists()) return { available: true };
            const d = snap.val();
            if (Date.now() - d.lastSeen > 120000) { await remove(ref(db, `activeNames/${safe}`)); return { available: true }; }
            return { available: false, ownerId: d.ownerId };
        },
        claimName: (name, oid) => {
            if (!isInit) return Promise.resolve();
            const safe = name.replace(/[.#$[\]]/g, '_').toLowerCase();
            const r = ref(db, `activeNames/${safe}`);
            onDisconnect(r).remove();
            return set(r, { ownerId: oid, lastSeen: serverTimestamp(), displayName: name });
        },
        keepNameAlive: (name, oid) => {
            if (!isInit) return;
            set(ref(db, `activeNames/${name.replace(/[.#$[\]]/g,'_').toLowerCase()}`), { ownerId: oid, lastSeen: serverTimestamp(), displayName: name }).catch(() => {});
        },
        releaseName: (name) => {
            if (!isInit) return;
            remove(ref(db, `activeNames/${name.replace(/[.#$[\]]/g,'_').toLowerCase()}`)).catch(() => {});
        },
        sendNameRequest: (rid, reqTemp, desired, targetOid) => {
            if (!isInit) return Promise.reject();
            return set(ref(db, `nameRequests/${rid}`), { requesterTemp: reqTemp, desiredName: desired, targetOwnerId: targetOid, status: 'pending', timestamp: serverTimestamp() });
        },
        listenNameRequest: (rid, cb) => {
            if (!isInit) return;
            onValue(ref(db, `nameRequests/${rid}`), s => { if (s.exists()) cb(s.val()); });
        },
        listenForIncomingNameRequests: (oid, cb) => {
            if (!isInit) return;
            const seen = new Set();
            onValue(nameRequestsRef, snap => {
                snap.forEach(child => {
                    const d = child.val();
                    if (d && d.targetOwnerId === oid && d.status === 'pending' && !seen.has(child.key)) {
                        seen.add(child.key);
                        cb(child.key, d);
                    }
                });
            });
        },
        respondToNameRequest: (rid, approved) => {
            if (!isInit) return Promise.reject();
            return set(ref(db, `nameRequests/${rid}`), { status: approved ? 'approved' : 'denied', timestamp: serverTimestamp() });
        },
        cleanupNameRequest: (rid) => {
            if (!isInit) return;
            remove(ref(db, `nameRequests/${rid}`)).catch(() => {});
        }
    };

    if (isInit) setChatStatus('connected', 'üü¢ Connected ‚Äî Real-time chat active');

    function setChatStatus(cls, txt) {
        const el = document.getElementById('chatStatus');
        if (el) { el.className = 'chat-status ' + cls; el.textContent = txt; }
    }
</script>

<script>
    const EMOJI_MAP = {
        ':sob:':'üò≠',':cry:':'üò¢',':smile:':'üòä',':laugh:':'üòÇ',':lol:':'üòÇ',
        ':rofl:':'ü§£',':heart:':'‚ù§Ô∏è',':broken_heart:':'üíî',':fire:':'üî•',
        ':100:':'üíØ',':thumbsup:':'üëç',':thumbsdown:':'üëé',':ok:':'üëå',
        ':wave:':'üëã',':clap:':'üëè',':pray:':'üôè',':skull:':'üíÄ',':eyes:':'üëÄ',
        ':thinking:':'ü§î',':shrug:':'ü§∑',':facepalm:':'ü§¶',':wink:':'üòâ',
        ':sunglasses:':'üòé',':cool:':'üòé',':angry:':'üò†',':rage:':'üò§',
        ':sad:':'üòû',':pensive:':'üòî',':shocked:':'üò±',':scream:':'üò±',
        ':sweat:':'üòÖ',':nervous:':'üò¨',':smirk:':'üòè',':tongue:':'üòõ',
        ':kiss:':'üòò',':love:':'ü•∞',':sparkles:':'‚ú®',':star:':'‚≠ê',
        ':rainbow:':'üåà',':sun:':'‚òÄÔ∏è',':moon:':'üåô',':snowflake:':'‚ùÑÔ∏è',
        ':pizza:':'üçï',':burger:':'üçî',':taco:':'üåÆ',':cat:':'üê±',
        ':dog:':'üê∂',':penguin:':'üêß',':frog:':'üê∏',':ghost:':'üëª',
        ':alien:':'üëΩ',':robot:':'ü§ñ',':poop:':'üí©',':clown:':'ü§°',
        ':crown:':'üëë',':gem:':'üíé',':rocket:':'üöÄ',':boom:':'üí•',
        ':party:':'üéâ',':tada:':'üéâ',':music:':'üéµ',':headphones:':'üéß',
        ':coffee:':'‚òï',':gaming:':'üéÆ',':sus:':'üìÆ',':pepe:':'üê∏',
        ':nerd:':'ü§ì',':monocle:':'üßê',':dead:':'üíÄ',':based:':'üòé',
        ':goat:':'üêê',':real:':'üíØ',':cap:':'üß¢',':nocap:':'üíØ',
    };

    const SLUR_PATTERNS = [
        /\bn[i!1|]+[g9]+[e3]+r/gi,/\bn[i!1|]+g{2,}/gi,/\bn[i!1|]gg[ae3]/gi,
        /\bf[a@]+g{2,}[o0]t/gi,/\bf[a@]+g[s$]/gi,/\bfagg?[o0]t/gi,/\bfag\b/gi,
        /\bk[i!1]+k[e3]/gi,/\bsp[i!1]+c/gi,/\bch[i!1]+nk/gi,
        /\bw[e3]+tb[a@]+ck/gi,/\bcr[a@]+ck[e3]+r/gi,/\br[e3]+t[a@]+rd/gi,
        /\bc[o0]+[o0]+n/gi,/\bj[i!1]+gg[a@]+b[o0]+[o0]/gi,
        /\bn1gger/gi,/\bn1gg3r/gi,/\br3gg1n\b/gi,
        /[a-z0-9]nigger/gi,/[a-z0-9]n1gger/gi,/[a-z0-9]n1gg3r/gi,
    ];

    const SEARCH_ENGINES = {
        google: 'https://www.google.com/search?q=%s',
        bing: 'https://www.bing.com/search?q=%s',
        ddg: 'https://duckduckgo.com/?q=%s',
        yahoo: 'https://search.yahoo.com/search?p=%s',
        brave: 'https://search.brave.com/search?q=%s',
    };

    const SCRAMJET_URL = 'https://scramjet-app-production-a204.up.railway.app';

    const IMAGES = {
        jhbetr:'https://i.imgur.com/IZ0wJQb.jpeg',minecraft:'https://i.imgur.com/ppi20I9.png',
        gd:'https://i.imgur.com/fpc76U0.jpeg',lacey:'https://i.imgur.com/KEYn8gZ.png',
        ultrakill:'https://i.imgur.com/wgmTwWM.jpeg',epstein:'https://i.imgur.com/OiAiMSl.png',
        fnaf1:'https://i.imgur.com/11OJGXJ.jpeg',fnaf2:'https://i.imgur.com/OfpGVct.jpeg',
        fnaf3:'https://i.imgur.com/ZcwnBE4.png',fnaf4:'https://i.imgur.com/Ew1nrVj.png',
        hollow:'https://i.imgur.com/iaSgADM.jpeg',fnaf4h:'https://i.imgur.com/MvYx18h.png',
        fnafsister:'https://i.imgur.com/bLD2AQ1.png',fnafpizza:'https://i.imgur.com/xU4nL4x.png',
        fnafucn:'https://i.imgur.com/uIPUty9.png',people:'https://i.imgur.com/BgcqQ1w.png',
        gtag:'https://i.imgur.com/LziGRnF.png',bendy:'https://i.imgur.com/N63N7D7.png',
        alien:'https://i.imgur.com/e0IXj6f.png',sans:'https://i.imgur.com/396NH6D.png',
        happy:'https://i.imgur.com/0ocMSU3.png',undertale:'https://i.imgur.com/vOKZyyK.png',
        class:'https://i.imgur.com/4ofYraf.png',
    };

    const games = [
        {name:'Subway Surfers NY',icon:'https://playernation.graphicon.org/resources/semag/subway-surfers-ny/NewYorkIcon.png',url:'https://playernation.graphicon.org/resources/semag/subway-surfers-ny/index.html',category:'Runner'},
        {name:'GTA Vice City',icon:'https://i.imgur.com/Zli9nme.png',url:'https://playernation.graphicon.org/resources/semag/gtavc/index.html',category:'Action'},
        {name:'Doki Doki Literature Club',icon:'https://playernation.graphicon.org/resources/semag/ddlc/icons/web-icon.png',url:'https://playernation.graphicon.org/resources/semag/ddlc/index.html',category:'Visual Novel'},
        {name:'DDLC Plus',icon:'https://i.imgur.com/b8DhT4P.jpeg',url:'https://playernation.graphicon.org/resources/semag/ddlcplus/index.html',category:'Visual Novel'},
        {name:'JHBETR',icon:IMAGES.jhbetr,url:'https://jhbetr.github.io/',category:'amazing game play it'},
        {name:'Minecraft',icon:IMAGES.minecraft,url:'/games/minecraft.html',category:'minecraft'},
        {name:'Geometry Dash',icon:IMAGES.gd,url:'/games/gdlite/index.html',category:'BROKEN AUDIO'},
        {name:'Lacey Games',icon:IMAGES.lacey,url:'/games/laceygames/index.html',category:'lacey games'},
        {name:'ULTRAKILL',icon:IMAGES.ultrakill,url:'/games/ultrakill/index.html',category:'ultrakill'},
        {name:'Five Nights at Epsteins',icon:IMAGES.epstein,url:'/games/epstein.html',category:'Survive Epstein'},
        {name:'FNaF 1',icon:IMAGES.fnaf1,url:'/games/fnaf.html',category:'Fnaf 1'},
        {name:'FNaF 2',icon:IMAGES.fnaf2,url:'/games/fnaf2.html',category:'fnaf 2'},
        {name:'FNaF 3',icon:IMAGES.fnaf3,url:'/games/fnaf3.html',category:'fnaf 3'},
        {name:'FNaF 4',icon:IMAGES.fnaf4,url:'/games/fnaf4.html',category:'fnaf 4'},
        {name:'FNaF 4 Halloween',icon:IMAGES.fnaf4h,url:'/games/fnaf4h.html',category:'fnaf 4 scarier'},
        {name:'Sister Location',icon:IMAGES.fnafsister,url:'/games/fnafsister.html',category:'scarier fnaf'},
        {name:'FNaF Pizza',icon:IMAGES.fnafpizza,url:'/games/fnafpizza.html',category:'pizza scary'},
        {name:'UCN',icon:IMAGES.fnafucn,url:'/games/fnafucn.html',category:'ultimate custom night'},
        {name:'Class of 09',icon:IMAGES.class,url:'/games/classof09.html',category:'very fun'},
        {name:'Undertale',icon:IMAGES.undertale,url:'/games/UNDERTALE.html',category:'fun game'},
        {name:'Hollow Knight',icon:IMAGES.hollow,url:'/games/hollowknight.html',category:'fire game'},
        {name:'People Playground',icon:IMAGES.people,url:'/games/peopleplayground.html',category:'fun'},
        {name:'Gorilla Tag',icon:IMAGES.gtag,url:'/games/gorillatag.html',category:'gorilla'},
        {name:'Bendy and the Ink Machine',icon:IMAGES.bendy,url:'/games/bendy.html',category:'scary'},
        {name:'Alien Hominid',icon:IMAGES.alien,url:'/games/alienhominid.html',category:'alien game'},
        {name:'Bad Time Simulator',icon:IMAGES.sans,url:'/games/badtimesimulator.html',category:'bad time'},
        {name:'Happy Wheels',icon:IMAGES.happy,url:'/games/happywheels.html',category:'gorey'},
    ];

    const apps = [
        {name:'ZIP file unzipper',icon: '',url:'/games/zipfile.html',category:'Unzip any file on your chromebook'},
    ];

    const themes = {
        purple:{primary:'#7c4dff',bg:'#0d0d10',p1:'rgba(124,77,255,0.8)',p2:'rgba(168,85,247,0.6)'},
        green:{primary:'#10b981',bg:'#040f0a',p1:'rgba(16,185,129,0.8)',p2:'rgba(52,211,153,0.6)'},
        blue:{primary:'#3b82f6',bg:'#040a14',p1:'rgba(59,130,246,0.8)',p2:'rgba(96,165,250,0.6)'},
        red:{primary:'#ef4444',bg:'#100606',p1:'rgba(239,68,68,0.8)',p2:'rgba(248,113,113,0.6)'},
        pink:{primary:'#ec4899',bg:'#100610',p1:'rgba(236,72,153,0.8)',p2:'rgba(244,114,182,0.6)'},
        spooky:{primary:'#ff6b00',bg:'#0e0600',p1:'rgba(255,107,0,0.8)',p2:'rgba(255,140,0,0.6)'},
        sky:{primary:'#38bdf8',bg:'#04101a',p1:'rgba(56,189,248,0.8)',p2:'rgba(125,211,252,0.6)'},
        yellow:{primary:'#eab308',bg:'#100d00',p1:'rgba(234,179,8,0.8)',p2:'rgba(250,204,21,0.6)'},
        galaxy:{primary:'#9333ea',bg:'#050410',p1:'rgba(147,51,234,0.8)',p2:'rgba(168,85,247,0.6)'},
        slate:{primary:'#888',bg:'#0d0d10',p1:'rgba(136,136,136,0.8)',p2:'rgba(170,170,170,0.6)'},
    };

    const themeNames = {purple:'Purple',green:'Green',blue:'Blue',red:'Red',pink:'Pink',spooky:'Spooky',sky:'Sky',yellow:'Yellow',galaxy:'Galaxy',slate:'Slate'};

    let currentPanel = 'home';

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const panel = document.getElementById('panel-' + id);
        if (panel) panel.classList.add('active');
        const nav = document.getElementById('nav-' + id);
        if (nav) nav.classList.add('active');
        currentPanel = id;

        if (id === 'chat') {
            openChat();
        }
    }

    function updateTime() {
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        document.getElementById('timeDisplay').textContent = `${h}:${String(m).padStart(2,'0')} ${ampm}`;
    }
    updateTime();
    setInterval(updateTime, 1000);

    function setHomeSub() {
        const h = new Date().getHours();
        let phrases;
        if (h >= 0 && h < 5) phrases = ["you're up late", "hi night owl", "go to sleep.", "why are you awake"];
        else if (h >= 7 && h < 9) phrases = ["you're up early", "good morning", "wow it's morning"];
        else phrases = ["browse games", "have fun!", "welcome to freedom.", "haiiiii :333"];
        document.getElementById('homeSub').textContent = phrases[Math.floor(Math.random() * phrases.length)];
    }
    setHomeSub();

    function launchProxy() {
        const inp = document.getElementById('proxyInput');
        if (inp) launchProxyUrl(inp.value.trim());
    }

    function launchProxyUrl(url) {
        if (!url) return;
        let finalUrl = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            if (url.includes('.') && !url.includes(' ')) finalUrl = 'https://' + url;
            else finalUrl = getSE().replace('%s', encodeURIComponent(url));
        }
        const iframe = document.getElementById('proxyIframe');
        iframe.src = `${SCRAMJET_URL}#${encodeURIComponent(finalUrl)}`;
        iframe.style.display = 'block';
        document.getElementById('proxyHome').style.display = 'none';
        showPanel('proxy');
    }

    document.getElementById('proxyInput').addEventListener('keypress', e => { if (e.key === 'Enter') launchProxy(); });

    const proxyIframe = document.getElementById('proxyIframe');
    proxyIframe.src = SCRAMJET_URL;
    proxyIframe.style.display = 'block';
    document.getElementById('proxyHome').style.display = 'none';

    function getSE() {
        return SEARCH_ENGINES[localStorage.getItem('desritory-se') || 'google'] || SEARCH_ENGINES.google;
    }

    function renderGames(filter = '') {
        const list = document.getElementById('gamesList');
        list.innerHTML = '';
        games.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()) || g.category.toLowerCase().includes(filter.toLowerCase()))
            .forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <img class="game-card-thumb" src="${game.icon}" alt="${game.name}" onerror="this.style.background='var(--bg3)'">
                    <div class="game-card-info">
                        <div class="game-card-name">${game.name}</div>
                        <div class="game-card-cat">${game.category}</div>
                    </div>`;
                card.onclick = () => openFullscreen(game.name, game.url);
                list.appendChild(card);
            });
    }

    function renderApps(filter = '') {
        const list = document.getElementById('appsList');
        list.innerHTML = '';
        const filtered = apps.filter(a => a.name.toLowerCase().includes(filter.toLowerCase()));
        if (!filtered.length) {
            list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-faint);">No apps yet.</div>';
            return;
        }
        filtered.forEach(app => {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.innerHTML = `
                <img class="game-card-thumb" src="${app.icon}" alt="${app.name}" onerror="this.style.background='var(--bg3)'">
                <div class="game-card-info">
                    <div class="game-card-name">${app.name}</div>
                    <div class="game-card-cat">${app.category}</div>
                </div>`;
            card.onclick = () => openFullscreen(app.name, app.url);
            list.appendChild(card);
        });
    }

    function openFullscreen(name, url) {
        const ls = document.getElementById('loadingScreen');
        document.getElementById('loadingText').textContent = `Loading ${name}...`;
        ls.classList.add('on');
        setTimeout(() => {
            ls.classList.remove('on');
            document.getElementById('fsTitle').textContent = name;
            document.getElementById('fullscreenIframe').src = url;
            document.getElementById('fullscreenOverlay').classList.add('active');
        }, 600);
    }

    function closeFullscreen() {
        document.getElementById('fullscreenOverlay').classList.remove('active');
        document.getElementById('fullscreenIframe').src = '';
    }

    function toggleStealth() {
        const cur = localStorage.getItem('desritory-stealth') === 'true';
        const nv = !cur;
        localStorage.setItem('desritory-stealth', nv);
        applyStealth(nv);
        const nav = document.getElementById('nav-stealth');
        nav.classList.toggle('stealth-on', nv);
    }

    function applyStealth(on) {
        const bar = document.getElementById('stealthStatusBar');
        if (on) {
            document.title = 'Google';
            let fav = document.querySelector("link[rel*='icon']") || document.createElement('link');
            fav.rel = 'shortcut icon'; fav.href = 'https://www.google.com/favicon.ico';
            document.head.appendChild(fav);
            if (bar) bar.style.display = 'flex';
        } else {
            document.title = 'Desritory V3';
            const fav = document.querySelector("link[rel*='icon']");
            if (fav) fav.href = '';
            if (bar) bar.style.display = 'none';
        }
    }

    function buildThemeGrid() {
        const grid = document.getElementById('themeGrid');
        grid.innerHTML = '';
        const saved = localStorage.getItem('desritory-theme') || 'slate';
        Object.entries(themes).forEach(([key, theme]) => {
            const el = document.createElement('div');
            el.className = 'theme-swatch' + (key === saved ? ' active' : '');
            el.dataset.theme = key;
            el.innerHTML = `<div class="swatch-dot" style="background:${theme.primary};box-shadow:0 0 8px ${theme.primary}66;"></div><div class="swatch-name">${themeNames[key]}</div>`;
            el.onclick = () => {
                document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                applyTheme(key);
            };
            grid.appendChild(el);
        });
    }

    function applyTheme(key) {
        const t = themes[key];
        if (!t) return;
        localStorage.setItem('desritory-theme', key);
        document.documentElement.style.setProperty('--primary', t.primary);
        document.documentElement.style.setProperty('--primary-dim', t.primary + '20');
        document.documentElement.style.setProperty('--primary-glow', t.primary + '44');
        document.body.style.background = t.bg;
        document.documentElement.style.setProperty('--bg', t.bg);
        document.querySelectorAll('.theme-swatch').forEach(s => s.classList.toggle('active', s.dataset.theme === key));
    }

    function setSE(key, btn) {
        localStorage.setItem('desritory-se', key);
        document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

   const CLOAK_PRESETS = {
    google:    { title: 'Google',          favicon: 'https://www.google.com/favicon.ico' },
    docs:      { title: 'Google Docs',     favicon: 'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico' },
    canvas:    { title: 'Canvas',          favicon: 'https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico' },
    khan:      { title: 'Khan Academy',    favicon: 'https://cdn.kastatic.org/images/favicon.ico' },
    classroom: { title: 'Google Classroom',favicon: 'https://ssl.gstatic.com/classroom/favicon.png' },
    desmos:    { title: 'Desmos',          favicon: 'https://www.desmos.com/favicon.ico' },
    wikipedia: { title: 'Wikipedia',       favicon: 'https://en.wikipedia.org/favicon.ico' },
    schoology: { title: 'Schoology',       favicon: 'https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico' },
};

function toggleCloak() {
    const t = document.getElementById('cloakToggle');
    t.classList.toggle('on');
    const on = t.classList.contains('on');
    localStorage.setItem('desritory-cloak', on);
    const presetRow = document.getElementById('cloakPresetRow');
    if (presetRow) presetRow.style.display = on ? 'flex' : 'none';
    if (on) {
        const saved = localStorage.getItem('desritory-cloak-preset') || 'google';
        document.getElementById('cloakPresetSelect').value = saved;
        applyCloakPreset(saved);
    } else {
        document.title = 'Desritory V4';
        const fav = document.querySelector("link[rel*='icon']");
        if (fav) fav.href = '';
    }
}

function applyCloakPreset(key) {
    const preset = CLOAK_PRESETS[key];
    if (!preset) return;
    localStorage.setItem('desritory-cloak-preset', key);
    document.title = preset.title;
    let fav = document.querySelector("link[rel*='icon']") || document.createElement('link');
    fav.rel = 'shortcut icon';
    fav.href = preset.favicon;
    document.head.appendChild(fav);
}

  function togglePanic() {
    const t = document.getElementById('panicToggle');
    t.classList.toggle('on');
    const on = t.classList.contains('on');
    localStorage.setItem('desritory-panic', on);
    const row = document.getElementById('panicKeyRow');
    if (row) row.style.display = on ? 'flex' : 'none';
}

function startKeyCapture() {
    const inp = document.getElementById('panicKeyInput');
    inp.value = '...';
    inp.style.borderColor = 'var(--primary)';
    inp.style.color = 'var(--text-faint)';

    function onKey(e) {
        e.preventDefault();
        const key = e.key;
        // ignore modifier-only presses
        if (['Control','Shift','Alt','Meta'].includes(key)) return;
        localStorage.setItem('desritory-panic-key', key);
        inp.value = key === ' ' ? 'Space' : key;
        inp.style.borderColor = 'var(--border-hover)';
        inp.style.color = 'var(--primary)';
        window.removeEventListener('keydown', onKey, true);
    }

    window.addEventListener('keydown', onKey, true);
}

    function toggleParticles() {
        const t = document.getElementById('particlesToggle');
        t.classList.toggle('on');
        const on = t.classList.contains('on');
        localStorage.setItem('desritory-particles', on);
        document.getElementById('bgCanvas').style.display = on ? 'block' : 'none';
    }

    function toggleSounds() {
        const t = document.getElementById('soundToggle');
        t.classList.toggle('on');
        localStorage.setItem('desritory-sounds', t.classList.contains('on'));
    }

    function changeUsername() {
        if (username && window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.releaseName(username);
        username = '';
        localStorage.removeItem('desritory-username');
        updateUsernameDisplay();
        showPanel('chat');
    }

    function updateUsernameDisplay() {
        const el = document.getElementById('usernameDisplay');
        if (el) el.textContent = username ? `(${username})` : '';
        const label = document.getElementById('chatUserLabel');
        if (label) label.textContent = username ? `@${username}` : '';
    }

    let username = localStorage.getItem('desritory-username') || '';
    let myOwnerId = localStorage.getItem('desritory-ownerid') || ('owner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
    localStorage.setItem('desritory-ownerid', myOwnerId);

    let isChatOpen = false, messageIds = new Set(), messagesCache = {};
    let replyingToMessage = null, selectedImageBase64 = null;
    let typingTimeout = null, currentlyTypingUsers = new Set();
    let unreadCount = 0, lastReadTimestamp = Date.now();
    let msgHistory = [], spamWarnCount = 0, spamWarnTimeout = null;
    let slurTO = null, slurInterval = null;
    let nameKeepAlive = null, pendingNameRequestResolve = null, pendingNameRequestId = null;
    let chatListenersAttached = false, bufferedMessages = [], pendingIncomingId = null;

    function openChat() {
        isChatOpen = true;
        unreadCount = 0;
        lastReadTimestamp = Date.now();
        updateBadge();
        updateUsernameDisplay();

        if (!username) {
            document.getElementById('chatSetup').style.display = 'flex';
            document.getElementById('chatBody').style.display = 'none';
            setTimeout(() => document.getElementById('chatSetupInput')?.focus(), 150);
        } else {
            document.getElementById('chatSetup').style.display = 'none';
            document.getElementById('chatBody').style.display = 'flex';
            initChatListeners();
        }
    }

    function submitUsername() {
        let desired = document.getElementById('chatSetupInput').value.trim() || ('Anon' + Math.floor(Math.random() * 1000));
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            resolveUsername(desired).then(resolved => {
                username = resolved;
                localStorage.setItem('desritory-username', username);
                updateUsernameDisplay();
                startNameKeepAlive();
                listenForNameRequests();
                document.getElementById('chatSetup').style.display = 'none';
                document.getElementById('chatBody').style.display = 'flex';
                initChatListeners();
            }).catch(() => {
                username = desired;
                localStorage.setItem('desritory-username', username);
                updateUsernameDisplay();
                document.getElementById('chatSetup').style.display = 'none';
                document.getElementById('chatBody').style.display = 'flex';
                initChatListeners();
            });
        } else {
            username = desired;
            localStorage.setItem('desritory-username', username);
            updateUsernameDisplay();
            document.getElementById('chatSetup').style.display = 'none';
            document.getElementById('chatBody').style.display = 'flex';
            initChatListeners();
        }
    }

    function initChatListeners() {
        if (chatListenersAttached) { flushBuffered(); return; }
        chatListenersAttached = true;
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            window.firebaseChat.listenToMessages(msg => {
                bufferedMessages.push(msg);
                if (isChatOpen) flushBuffered();
            });
            window.firebaseChat.listenToTyping(handleTypingUpdate);
        }
        setTimeout(() => { const m = document.getElementById('chatMessages'); if (m) m.scrollTop = m.scrollHeight; }, 100);
    }

    function flushBuffered() {
        const msgs = bufferedMessages.slice(); bufferedMessages = [];
        msgs.forEach(displayMessage);
    }

    async function resolveUsername(name) {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return name;
        let result;
        try { result = await window.firebaseChat.checkNameAvailable(name); } catch { return name; }
        if (result.available) { await window.firebaseChat.claimName(name, myOwnerId); return name; }
        if (result.ownerId === myOwnerId) return name;
        return new Promise(resolve => {
            pendingNameRequestResolve = resolve;
            const rid = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
            pendingNameRequestId = rid;
            document.getElementById('nameWaitingModal').classList.add('on');
            document.getElementById('nameWaitingText').textContent = `Waiting for holder of "${name}" to respond...`;
            window.firebaseChat.sendNameRequest(rid, myOwnerId, name, result.ownerId);
            window.firebaseChat.listenNameRequest(rid, data => {
                if (data.status === 'approved') {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.claimName(name, myOwnerId);
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    resolve(name);
                } else if (data.status === 'denied') {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = name + Math.floor(Math.random() * 9000 + 1000);
                    alert(`Denied. You'll be assigned "${alt}".`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            });
            setTimeout(() => {
                if (pendingNameRequestResolve) {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = name + Math.floor(Math.random() * 9000 + 1000);
                    alert(`No response. You'll be assigned "${alt}".`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            }, 30000);
        });
    }

    function startNameKeepAlive() {
        if (nameKeepAlive) clearInterval(nameKeepAlive);
        nameKeepAlive = setInterval(() => {
            if (window.firebaseChat && window.firebaseChat.isInitialized() && username)
                window.firebaseChat.keepNameAlive(username, myOwnerId);
        }, 60000);
    }

    function listenForNameRequests() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return;
        window.firebaseChat.listenForIncomingNameRequests(myOwnerId, (rid, data) => {
            if (pendingIncomingId) return;
            pendingIncomingId = rid;
            document.getElementById('nameRequesterDisplay').textContent = 'Someone';
            document.getElementById('nameRequestedDisplay').textContent = data.desiredName;
            document.getElementById('nameRequestModal').classList.add('on');
        });
    }

    function respondToNameRequest(approved) {
        document.getElementById('nameRequestModal').classList.remove('on');
        if (pendingIncomingId) { window.firebaseChat.respondToNameRequest(pendingIncomingId, approved); pendingIncomingId = null; }
    }

    function updateBadge() {
        const badge = document.getElementById('chatBadge');
        if (unreadCount > 0) { badge.textContent = unreadCount > 99 ? '99+' : unreadCount; badge.classList.add('show'); }
        else badge.classList.remove('show');
    }

    function displayMessage(message) {
        if (messageIds.has(message.id)) return;
        messageIds.add(message.id);
        messagesCache[message.id] = message;
        if (!isChatOpen && message.username !== username && message.timestamp > lastReadTimestamp) {
            unreadCount++;
            updateBadge();
            playNotif();
            return;
        }
        if (!isChatOpen) return;
        const area = document.getElementById('chatMessages');
        if (!area) return;
        const shouldScroll = area.scrollHeight - area.scrollTop - area.clientHeight < 100;
        const div = document.createElement('div');
        div.className = 'chat-msg';
        let replyHtml = '';
        if (message.replyTo) replyHtml = `<div class="msg-reply-bar"><strong>@${esc(message.replyTo.username)}</strong>: ${esc((message.replyTo.text||'').substring(0,50))}</div>`;
        let imgHtml = '';
        if (message.imageUrl) imgHtml = `<img src="${message.imageUrl}" class="msg-image" onclick="window.open('${message.imageUrl}','_blank')">`;
        div.innerHTML = `
            <div class="msg-actions"><button class="msg-reply-btn" onclick="replyTo('${message.id}','${esc(message.username)}')">‚Ü© Reply</button></div>
            ${replyHtml}
            <div class="msg-username">${esc(message.username)}</div>
            <div class="msg-text">${esc(message.text||'')}</div>
            ${imgHtml}
            <div class="msg-time">${fmtTime(message.timestamp)}</div>
        `;
        area.appendChild(div);
        while (area.children.length > 100) area.removeChild(area.firstChild);
        if (shouldScroll) area.scrollTop = area.scrollHeight;
    }

    function replyTo(id, user) {
        replyingToMessage = { id, username: user };
        document.getElementById('replyBar').classList.add('on');
        document.getElementById('replyToUser').textContent = user;
        document.getElementById('chatInput').focus();
    }

    function cancelReply() {
        replyingToMessage = null;
        document.getElementById('replyBar').classList.remove('on');
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = e => {
                selectedImageBase64 = e.target.result;
                const p = document.getElementById('imgPreview');
                p.src = selectedImageBase64; p.classList.add('on');
                document.getElementById('removeImgBtn').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeImage() {
        selectedImageBase64 = null;
        const p = document.getElementById('imgPreview');
        p.classList.remove('on'); p.src = '';
        document.getElementById('removeImgBtn').style.display = 'none';
        document.getElementById('imageInput').value = '';
    }

    function handleTyping() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        const inp = document.getElementById('chatInput');
        if (typingTimeout) clearTimeout(typingTimeout);
        if (inp.value.trim().length > 0) {
            window.firebaseChat.setTyping(username, true);
            typingTimeout = setTimeout(() => window.firebaseChat.setTyping(username, false), 3000);
        } else {
            window.firebaseChat.setTyping(username, false);
        }
    }

    function handleTypingUpdate(u, on) {
        if (u === username) return;
        if (on) currentlyTypingUsers.add(u); else currentlyTypingUsers.delete(u);
        const bar = document.getElementById('typingBar');
        const el = document.getElementById('typingUsers');
        if (!currentlyTypingUsers.size) { bar.classList.remove('on'); return; }
        bar.classList.add('on');
        const arr = Array.from(currentlyTypingUsers);
        if (arr.length === 1) el.textContent = `${arr[0]} is typing`;
        else if (arr.length === 2) el.textContent = `${arr[0]} and ${arr[1]} are typing`;
        else el.textContent = `${arr[0]}, ${arr[1]}, and ${arr.length - 2} more are typing`;
    }

    function handleChatKey(e) { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } }

    function containsSlur(t) { return SLUR_PATTERNS.some(p => p.test(t)); }

    function applyEmoji(t) {
        let r = t;
        for (const [s, e] of Object.entries(EMOJI_MAP)) r = r.replace(new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), e);
        return r;
    }

    function checkSpam(msg) {
        const now = Date.now();
        const trimmed = msg.trim().toLowerCase();
        msgHistory.push({ text: trimmed, timestamp: now });
        msgHistory = msgHistory.filter(m => now - m.timestamp < 3000);
        if (msgHistory.filter(m => m.text === trimmed).length >= 5) { showSpamWarn(); return true; }
        return false;
    }

    function showSpamWarn() {
        const el = document.getElementById('spamWarn');
        const txt = document.getElementById('spamWarnText');
        const inp = document.getElementById('chatInput');
        const btn = document.querySelector('.send-btn');
        if (inp) inp.disabled = true;
        if (btn) btn.disabled = true;
        spamWarnCount++;
        txt.textContent = spamWarnCount === 1 ? "Can you please not spam?" : spamWarnCount === 2 ? "you're very annoying" : "what is wrong with you";
        el.classList.add('on');
        if (spamWarnTimeout) clearTimeout(spamWarnTimeout);
        spamWarnTimeout = setTimeout(() => {
            el.classList.remove('on');
            if (inp) inp.disabled = false;
            if (btn) btn.disabled = false;
        }, 5000);
    }

    function showSlurWarn() {
        const el = document.getElementById('slurWarn');
        const timerEl = document.getElementById('slurTimer');
        const inp = document.getElementById('chatInput');
        const btn = document.querySelector('.send-btn');
        if (inp) { inp.value = ''; inp.disabled = true; }
        if (btn) btn.disabled = true;
        let sec = 10;
        timerEl.textContent = sec;
        el.classList.add('on');
        if (slurInterval) clearInterval(slurInterval);
        if (slurTO) clearTimeout(slurTO);
        slurInterval = setInterval(() => { sec--; timerEl.textContent = sec; if (sec <= 0) clearInterval(slurInterval); }, 1000);
        slurTO = setTimeout(() => {
            el.classList.remove('on');
            if (inp) inp.disabled = false;
            if (btn) btn.disabled = false;
        }, 10000);
    }

    function playNotif() {
        if (localStorage.getItem('desritory-sounds') !== 'true') return;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.value = 880; o.type = 'sine';
            g.gain.setValueAtTime(0.1, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            o.start(); o.stop(ctx.currentTime + 0.3);
        } catch(e) {}
    }

    function sendMessage() {
        const inp = document.getElementById('chatInput');
        let msg = inp.value.trim();
        if (!msg && !selectedImageBase64) return;
        if (msg && containsSlur(msg)) { showSlurWarn(); return; }
        if (msg) msg = applyEmoji(msg);
        if (msg && checkSpam(msg)) return;
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            const reply = replyingToMessage ? { id: replyingToMessage.id, username: replyingToMessage.username, text: messagesCache[replyingToMessage.id]?.text || '' } : null;
            window.firebaseChat.setTyping(username, false);
            if (typingTimeout) clearTimeout(typingTimeout);
            window.firebaseChat.sendMessage(username, msg, selectedImageBase64, reply)
                .then(() => { inp.value = ''; cancelReply(); removeImage(); })
                .catch(() => alert('Failed to send.'));
        } else {
            alert('Chat not connected.');
        }
    }

    function esc(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }
    function fmtTime(ts) { if (!ts) return ''; try { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } catch { return ''; } }

    function initBackground() {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', () => {
            resize();
            particles.forEach(p => {
                if (p.x > canvas.width) p.x = Math.random() * canvas.width;
                if (p.y > canvas.height) p.y = Math.random() * canvas.height;
            });
        });

        const CONFIG = {
            count: 80,
            minR: 2,
            maxR: 4,
            speed: 0.6,
            linkDist: 150,
            mouseDist: 180,
            dotOpacity: 0.75,
            lineOpacity: 0.25,
            mouseLineOpacity: 0.5,
        };

        const mouse = { x: -9999, y: -9999, active: false };
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
        window.addEventListener('mouseleave', () => { mouse.active = false; mouse.x = -9999; mouse.y = -9999; });

        function getPrimaryRGB() {
            const hex = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#7c4dff';
            const m = hex.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
            if (m) return [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)];
            return [124, 77, 255];
        }

        function makeParticle() {
            const angle = Math.random() * Math.PI * 2;
            const speed = (Math.random() * 0.5 + 0.2) * CONFIG.speed;
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: Math.random() * (CONFIG.maxR - CONFIG.minR) + CONFIG.minR,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                opacity: Math.random() * 0.3 + CONFIG.dotOpacity,
            };
        }

        const particles = Array.from({ length: CONFIG.count }, makeParticle);

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const [r, g, b] = getPrimaryRGB();
            const W = canvas.width, H = canvas.height;

            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                if (p.x < 0) p.x = W;
                if (p.x > W) p.x = 0;
                if (p.y < 0) p.y = H;
                if (p.y > H) p.y = 0;
            });

            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < CONFIG.linkDist) {
                        const alpha = CONFIG.lineOpacity * (1 - dist / CONFIG.linkDist);
                        ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
                        ctx.lineWidth = 0.8;
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }

            if (mouse.active) {
                particles.forEach(p => {
                    const dx = p.x - mouse.x;
                    const dy = p.y - mouse.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < CONFIG.mouseDist) {
                        const alpha = CONFIG.mouseLineOpacity * (1 - dist / CONFIG.mouseDist);
                        ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        ctx.lineTo(mouse.x, mouse.y);
                        ctx.stroke();
                    }
                });
            }

            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255,255,255,${p.opacity})`;
                ctx.fill();
            });

            requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
    }

    document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeFullscreen();
    if (localStorage.getItem('desritory-panic') === 'true') {
        const panicKey = localStorage.getItem('desritory-panic-key') || "'";
        if (e.key === panicKey) window.location.href = 'https://google.com';
    }
});

if (localStorage.getItem('desritory-panic') === 'true') {
    document.getElementById('panicToggle').classList.add('on');
    const row = document.getElementById('panicKeyRow');
    const inp = document.getElementById('panicKeyInput');
    if (row) row.style.display = 'flex';
    if (inp) inp.value = localStorage.getItem('desritory-panic-key') || "'";
}
    initBackground();
    renderGames();
    renderApps();
    buildThemeGrid();
    updateUsernameDisplay();

    const CURRENT_VERSION = '4.0.0';
    const savedVersion = localStorage.getItem('desritory-version');
    if (savedVersion !== CURRENT_VERSION) {
        const su = localStorage.getItem('desritory-username');
        const so = localStorage.getItem('desritory-ownerid');
        localStorage.clear();
        if (su) localStorage.setItem('desritory-username', su);
        if (so) localStorage.setItem('desritory-ownerid', so);
        localStorage.setItem('desritory-version', CURRENT_VERSION);
    }

    applyTheme(localStorage.getItem('desritory-theme') || 'slate');

    if (localStorage.getItem('desritory-stealth') === 'true') {
        applyStealth(true);
        document.getElementById('nav-stealth').classList.add('stealth-on');
    }

    const savedSE = localStorage.getItem('desritory-se') || 'google';
    const seBtn = document.getElementById('se-' + savedSE);
    if (seBtn) { document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active')); seBtn.classList.add('active'); }

   if (localStorage.getItem('desritory-cloak') === 'true') {
    document.getElementById('cloakToggle').classList.add('on');
    const savedPreset = localStorage.getItem('desritory-cloak-preset') || 'google';
    const presetRow = document.getElementById('cloakPresetRow');
    const presetSelect = document.getElementById('cloakPresetSelect');
    if (presetRow) presetRow.style.display = 'flex';
    if (presetSelect) presetSelect.value = savedPreset;
    applyCloakPreset(savedPreset);
}

    window.addEventListener('beforeunload', () => {
        if (username && window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.releaseName(username);
    });

    document.addEventListener('visibilitychange', () => {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        if (document.visibilityState === 'hidden') window.firebaseChat.releaseName(username);
        if (document.visibilityState === 'visible') window.firebaseChat.claimName(username, myOwnerId);
    });
</script>
</body>
</html>
