<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desritory V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #7c4dff;
            --secondary: #9333ea;
            --accent: #a855f7;
            --light: #c084fc;
            --glow: rgba(120, 70, 220, 0.4);
            --bg: #0f1520;
            --bg2: #141b2d;
            --glass: rgba(255,255,255,0.05);
            --glass-border: rgba(255,255,255,0.1);
            --particle-color-1: rgba(124, 77, 255, 0.8);
            --particle-color-2: rgba(168, 85, 247, 0.6);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        #particleCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        #desktop {
            position: fixed;
            top: 0; left: 0; right: 0;
            bottom: 52px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .desktop-logo {
            font-family: 'Syne', sans-serif;
            font-size: clamp(42px, 6vw, 80px);
            font-weight: 800;
            letter-spacing: 6px;
            background: linear-gradient(135deg, var(--light) 0%, var(--primary) 30%, var(--accent) 60%, var(--secondary) 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 8s ease infinite, floatLogo 5s ease-in-out infinite;
            margin-bottom: 8px;
            text-align: center;
        }

        .desktop-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.3);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 48px;
            text-align: center;
            font-weight: 500;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes floatLogo {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(5, 100px);
            gap: 24px 32px;
            justify-content: center;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }

        .app-icon-box {
            width: 72px;
            height: 72px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(12px);
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .app-icon:hover .app-icon-box {
            transform: scale(1.12) translateY(-4px);
            background: rgba(255,255,255,0.1);
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 0 20px var(--glow);
        }

        .app-icon:active .app-icon-box {
            transform: scale(0.95);
        }

        .app-icon-label {
            font-size: 12px;
            color: rgba(255,255,255,0.75);
            font-weight: 500;
            text-align: center;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            letter-spacing: 0.3px;
        }

        .app-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ff3b30, #ff453a);
            border: 2px solid var(--bg);
            border-radius: 10px;
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            animation: notificationPulse 2s ease-in-out infinite;
        }

        .app-badge.active { display: flex; }

        @keyframes notificationPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        #taskbar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 52px;
            background: rgba(10, 13, 22, 0.92);
            backdrop-filter: blur(24px);
            border-top: 1px solid rgba(255,255,255,0.08);
            z-index: 9000;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
        }

        .taskbar-start {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 12px var(--glow);
        }

        .taskbar-start:hover { transform: scale(1.08); opacity: 0.9; }

        .taskbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            margin: 0 4px;
            flex-shrink: 0;
        }

        .taskbar-apps {
            display: flex;
            gap: 4px;
            flex: 1;
            overflow: hidden;
        }

        .taskbar-app-btn {
            height: 36px;
            padding: 0 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: rgba(255,255,255,0.75);
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .taskbar-app-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .taskbar-app-btn.active { background: rgba(124,77,255,0.25); border-color: var(--primary); color: white; }
        .taskbar-app-btn .tb-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--primary); }

        .taskbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .taskbar-time {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            letter-spacing: 0.5px;
            cursor: default;
        }

        .taskbar-icon-btn {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            position: relative;
        }

        .taskbar-icon-btn:hover { background: rgba(255,255,255,0.12); color: white; border-color: rgba(255,255,255,0.15); }

        .os-window {
            position: fixed;
            background: rgba(14, 18, 30, 0.96);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04);
            z-index: 5000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
            min-width: 300px;
            min-height: 200px;
            animation: windowOpen 0.2s cubic-bezier(0.34, 1.4, 0.64, 1);
        }

        .os-window.visible { display: flex; }

        @keyframes windowOpen {
            from { opacity: 0; transform: scale(0.92) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .window-titlebar {
            height: 42px;
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            padding: 0 14px;
            gap: 10px;
            cursor: move;
            flex-shrink: 0;
        }

        .window-controls {
            display: flex;
            gap: 4px;
        }

        .wc-btn {
            width: 32px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wc-btn:hover { background: rgba(255,255,255,0.12); color: white; border-color: rgba(255,255,255,0.2); }
        .wc-close:hover { background: rgba(239,68,68,0.7); border-color: #ef4444; color: white; }
        .wc-min:hover { background: rgba(234,179,8,0.5); border-color: #eab308; }
        .wc-max:hover { background: rgba(40,200,64,0.4); border-color: #28c840; }

        .window-title {
            font-family: 'Syne', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            flex: 1;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .window-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .settings-content {
            padding: 24px;
        }

        .settings-section { margin-bottom: 24px; }

        .settings-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.4);
            margin-bottom: 12px;
        }

        .theme-selector {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .theme-selector:hover, .theme-selector:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        .theme-selector option { background: #1e2837; }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.07);
        }

        .toggle-row-label { font-size: 14px; color: rgba(255,255,255,0.8); }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active { background: var(--primary); }

        .toggle-slider {
            position: absolute;
            top: 3px; left: 3px;
            width: 18px; height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider { transform: translateX(20px); }

        .se-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .se-btn {
            padding: 9px 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 9px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .se-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .se-btn.active { background: var(--primary); border-color: var(--primary); color: white; }

        .games-window-header {
            padding: 14px 16px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
        }

        .games-search-input {
            flex: 1;
            padding: 9px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: all 0.2s;
        }

        .games-search-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        .games-search-input::placeholder { color: rgba(255,255,255,0.3); }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 14px;
        }

        .game-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-card:hover { background: rgba(255,255,255,0.09); border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }

        .game-card-icon { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }

        .game-card-info { flex: 1; min-width: 0; }
        .game-card-name { font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .game-card-cat { font-size: 11px; color: rgba(255,255,255,0.4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-status-bar {
            padding: 8px 14px;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }

        .chat-status-bar.connected { color: #10b981; }
        .chat-status-bar.error { color: #ef4444; }

        .chat-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-msg {
            padding: 10px 13px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            animation: msgSlide 0.2s ease;
            position: relative;
            transition: background 0.2s;
        }

        .chat-msg:hover { background: rgba(255,255,255,0.08); }
        .chat-msg:hover .chat-msg-actions { opacity: 1; }

        @keyframes msgSlide {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-msg-actions { position: absolute; top: 6px; right: 8px; opacity: 0; transition: opacity 0.15s; }

        .chat-action-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 5px;
            padding: 3px 7px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'DM Sans', sans-serif;
        }

        .chat-action-btn:hover { background: var(--primary); }

        .chat-reply-indicator {
            background: rgba(124,77,255,0.15);
            border-left: 2px solid var(--primary);
            padding: 4px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
        }

        .chat-reply-indicator strong { color: var(--primary); }

        .chat-msg-username { font-weight: 600; color: var(--primary); font-size: 12px; margin-bottom: 3px; }
        .chat-msg-text { font-size: 13px; color: rgba(255,255,255,0.88); word-wrap: break-word; }
        .chat-msg-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; transition: transform 0.15s; }
        .chat-msg-image:hover { transform: scale(1.02); }
        .chat-msg-time { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 4px; }

        .typing-indicator {
            display: none;
            padding: 6px 14px;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            font-style: italic;
        }

        .typing-indicator.active { display: block; }

        .typing-dots span {
            display: inline-block;
            width: 3px; height: 3px;
            margin: 0 2px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-3px); }
        }

        .replying-to-bar {
            display: none;
            background: rgba(124,77,255,0.12);
            border-left: 2px solid var(--primary);
            padding: 6px 12px;
            margin: 0 12px 6px;
            border-radius: 5px;
            font-size: 12px;
            position: relative;
            flex-shrink: 0;
        }

        .replying-to-bar.active { display: block; }

        .cancel-reply {
            position: absolute;
            right: 8px; top: 50%;
            transform: translateY(-50%);
            background: none; border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer; font-size: 14px;
            transition: color 0.15s;
        }

        .cancel-reply:hover { color: white; }

        .image-preview-bar {
            padding: 0 12px 8px;
            flex-shrink: 0;
        }

        .image-preview {
            display: none;
            max-width: 120px;
            max-height: 80px;
            border-radius: 8px;
        }

        .image-preview.active { display: block; }

        .chat-input-bar {
            padding: 10px 12px;
            border-top: 1px solid rgba(255,255,255,0.07);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-text-input {
            flex: 1;
            padding: 9px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-text-input:focus { border-color: var(--primary); }
        .chat-text-input::placeholder { color: rgba(255,255,255,0.3); }

        .chat-send-btn {
            padding: 9px 18px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .chat-send-btn:hover { opacity: 0.85; }

        .img-upload-btn {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: rgba(255,255,255,0.6);
            font-size: 14px;
        }

        .img-upload-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--primary); }

        .proxy-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 30px 24px;
            height: 100%;
        }

        .proxy-title {
            font-family: 'Syne', sans-serif;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--light), var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .proxy-search-row {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 520px;
        }

        .proxy-search-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: all 0.2s;
        }

        .proxy-search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--glow); }
        .proxy-search-input::placeholder { color: rgba(255,255,255,0.3); }

        .proxy-go-btn {
            padding: 12px 22px;
            background: var(--primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .proxy-go-btn:hover { opacity: 0.85; }

        .proxy-quick-links {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 520px;
        }

        .proxy-quick-link {
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .proxy-quick-link:hover { background: rgba(255,255,255,0.09); border-color: var(--primary); transform: translateY(-2px); }
        .proxy-quick-link span:first-child { font-size: 22px; }
        .proxy-quick-link span:last-child { font-size: 11px; color: rgba(255,255,255,0.6); font-weight: 500; }

        .proxy-browser-bar {
            display: none;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .proxy-browser-bar.visible { display: flex; }

        .proxy-nav-btn {
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 7px;
            color: rgba(255,255,255,0.7);
            cursor: pointer; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s; flex-shrink: 0;
        }

        .proxy-nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        .proxy-url-input {
            flex: 1;
            padding: 7px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 7px;
            color: white;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
        }

        .proxy-url-input:focus { border-color: var(--primary); }

        .proxy-iframe { width: 100%; height: 100%; border: none; display: none; }

        .update-content {
            padding: 24px;
        }

        .update-version {
            font-family: 'Syne', sans-serif;
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .update-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 20px;
        }

        .update-notes {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 16px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            line-height: 1.8;
        }

        #fullscreenOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 8000;
            display: none;
            flex-direction: column;
        }

        #fullscreenOverlay.active { display: flex; }

        .fullscreen-bar {
            height: 48px;
            background: rgba(10,13,22,0.95);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 10px;
            flex-shrink: 0;
        }

        .fullscreen-back-btn {
            padding: 7px 16px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 7px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }

        .fullscreen-back-btn:hover { background: rgba(255,255,255,0.12); color: white; }

        .fullscreen-title {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
        }

        #fullscreenIframe { width: 100%; flex: 1; border: none; }

        .overlay-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 15000;
            align-items: center;
            justify-content: center;
        }

        .overlay-modal.active { display: flex; }

        .overlay-modal-box {
            background: rgba(14,18,30,0.98);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 18px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }

        .overlay-modal-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 12px; }
        .overlay-modal-text { font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 24px; line-height: 1.6; }
        .overlay-modal-text strong { color: var(--primary); }

        .modal-btn-row { display: flex; gap: 10px; justify-content: center; }

        .modal-btn {
            padding: 10px 28px;
            border-radius: 9px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }

        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.primary:hover { opacity: 0.85; }
        .modal-btn.secondary { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.15); }
        .modal-btn.secondary:hover { background: rgba(239,68,68,0.25); border-color: #ef4444; }

        .waiting-spinner {
            width: 44px; height: 44px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .floating-warning {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            border-radius: 14px;
            padding: 28px 36px;
            z-index: 16000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            text-align: center;
        }

        .floating-warning.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all; }

        #spamWarning { background: rgba(239,68,68,0.95); border: 2px solid #dc2626; }
        #spamWarningText { font-size: 18px; font-weight: 700; color: white; }

        #slurWarning {
            background: rgba(14,18,30,0.98);
            border: 2px solid var(--primary);
            box-shadow: 0 10px 50px var(--glow);
        }

        #slurWarning .slur-icon { font-size: 36px; margin-bottom: 12px; }
        #slurWarning .slur-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        #slurWarning .slur-text { font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 12px; }
        #slurWarning .slur-timer { font-size: 30px; font-weight: 900; color: var(--primary); font-family: 'Syne', monospace; }

        #loadingScreen {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(14,18,30,0.97);
            z-index: 12000;
            align-items: center; justify-content: center;
            flex-direction: column; gap: 20px;
        }

        #loadingScreen.active { display: flex; }

        .loader { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-text { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; color: rgba(255,255,255,0.85); }

        #systemTray {
            position: fixed;
            bottom: 60px;
            right: 16px;
            width: 260px;
            background: rgba(14,18,30,0.97);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            padding: 18px;
            z-index: 9500;
            display: none;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
        }

        #systemTray.visible { display: block; }

        .tray-header {
            font-family: 'Syne', sans-serif;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.35);
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }

        .tray-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .tray-stat-label { color: rgba(255,255,255,0.5); }
        .tray-stat-value { font-weight: 600; font-family: 'Syne', sans-serif; }
        .tray-stat-value.green { color: #10b981; }
        .tray-stat-value.purple { color: var(--accent); }
        .tray-stat-value.blue { color: #60a5fa; }
        .tray-stat-value.yellow { color: #fbbf24; }

        .status-dot {
            display: inline-block;
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #10b981;
            margin-right: 5px;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 8px #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<canvas id="particleCanvas"></canvas>

<div id="desktop">
    <div class="desktop-logo" id="desktopLogo">DESRITORY V2</div>
    <div class="desktop-subtitle" id="desktopSubtitle">Welcome back</div>

    <div class="app-grid">
        <div class="app-icon" ondblclick="openWindow('proxyWindow')" onclick="selectIcon(this)">
            <div class="app-icon-box">üõ°Ô∏è</div>
            <span class="app-icon-label">Proxy</span>
        </div>
        <div class="app-icon" ondblclick="openGamesWindow()" onclick="selectIcon(this)">
            <div class="app-icon-box">üéÆ</div>
            <span class="app-icon-label">Games</span>
        </div>
        <div class="app-icon" ondblclick="openAppsWindow()" onclick="selectIcon(this)">
            <div class="app-icon-box">üì±</div>
            <span class="app-icon-label">Apps</span>
        </div>
        <div class="app-icon" ondblclick="openChat()" onclick="selectIcon(this)">
            <div class="app-icon-box" id="chatIconBox">
                üí¨
                <span class="app-badge" id="chatNotificationBadge">0</span>
            </div>
            <span class="app-icon-label">Chat</span>
        </div>
        <div class="app-icon" ondblclick="openWindow('settingsWindow')" onclick="selectIcon(this)">
            <div class="app-icon-box">‚öôÔ∏è</div>
            <span class="app-icon-label">Settings</span>
        </div>
        <div class="app-icon" ondblclick="openWindow('updateWindow')" onclick="selectIcon(this)">
            <div class="app-icon-box">üîî</div>
            <span class="app-icon-label">Updates</span>
        </div>
        <div class="app-icon" ondblclick="toggleStealthMode()" onclick="selectIcon(this)">
            <div class="app-icon-box" id="stealthIconBox">üïµÔ∏è</div>
            <span class="app-icon-label" id="stealthIconLabel">Stealth</span>
        </div>
    </div>
</div>

<div id="taskbar">
    <div class="taskbar-start" onclick="toggleSystemTray()" title="System Info">
        <i class="fas fa-layer-group"></i>
    </div>
    <div class="taskbar-divider"></div>
    <div class="taskbar-apps" id="taskbarApps"></div>
    <div class="taskbar-right">
        <div class="taskbar-icon-btn" onclick="openChat()" title="Chat">
            <i class="fas fa-comments"></i>
        </div>
        <div class="taskbar-icon-btn" onclick="toggleStealthMode()" title="Stealth Mode" id="tbStealthBtn">
            <i class="fas fa-user-secret"></i>
        </div>
        <div class="taskbar-time" id="timeDisplay">12:00 AM</div>
    </div>
</div>

<div id="systemTray">
    <div class="tray-header">System Panel</div>
    <div class="tray-stat">
        <span class="tray-stat-label">Status</span>
        <span class="tray-stat-value green"><span class="status-dot"></span>Online</span>
    </div>
    <div class="tray-stat">
        <span class="tray-stat-label">Users Active</span>
        <span class="tray-stat-value purple" id="usersActive">--</span>
    </div>
    <div class="tray-stat">
        <span class="tray-stat-label">Stealth</span>
        <span class="tray-stat-value purple" id="stealthStatus">Disabled</span>
    </div>
    <div class="tray-stat">
        <span class="tray-stat-label">Theme</span>
        <span class="tray-stat-value blue" id="currentTheme">Slate</span>
    </div>
    <div class="tray-stat">
        <span class="tray-stat-label">Version</span>
        <span class="tray-stat-value blue">2.5.0</span>
    </div>
    <div class="tray-stat">
        <span class="tray-stat-label">Uptime</span>
        <span class="tray-stat-value yellow" id="uptimeDisplay">00:00:00</span>
    </div>
</div>

<div class="os-window" id="proxyWindow" style="width:780px;height:560px;top:60px;left:50%;transform:translateX(-50%);">
    <div class="window-titlebar" id="proxyWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeWindow('proxyWindow')">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('proxyWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('proxyWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Desritory Proxy</div>
        <div style="width:40px;"></div>
    </div>
    <div class="window-content">
        <div class="proxy-home" id="proxyHome">
            <div class="proxy-title">Desritory Proxy</div>
            <p style="font-size:14px;color:rgba(255,255,255,0.4);">Welcome to Freedom.</p>
            <div class="proxy-search-row">
                <input id="proxySearchInput" class="proxy-search-input" type="text" placeholder="Search or enter a URL..." onkeypress="handleProxySearch(event)">
                <button class="proxy-go-btn" onclick="launchProxy()">Go</button>
            </div>
            <div class="proxy-quick-links">
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://google.com')"><span>üîç</span><span>Google</span></div>
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://youtube.com')"><span>‚ñ∂Ô∏è</span><span>YouTube</span></div>
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://discord.com')"><span>üí¨</span><span>Discord</span></div>
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://github.com')"><span>ü§ñ</span><span>Github</span></div>
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://spotify.com')"><span>üéµ</span><span>Spotify</span></div>
                <div class="proxy-quick-link" onclick="launchProxyUrl('https://twitter.com')"><span>üê¶</span><span>Twitter/X</span></div>
            </div>
            <p style="font-size:11px;color:rgba(255,255,255,0.2);margin-top:8px;">Powered by Scramjet</p>
        </div>
        <iframe id="proxyIframe" class="proxy-iframe"></iframe>
    </div>
</div>

<div class="os-window" id="gamesWindow" style="width:680px;height:480px;top:80px;left:80px;">
    <div class="window-titlebar" id="gamesWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeWindow('gamesWindow')">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('gamesWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('gamesWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Games</div>
        <div style="width:40px;"></div>
    </div>
    <div class="games-window-header">
        <input type="text" class="games-search-input" id="gamesSearch" placeholder="üîç  Search games..." oninput="renderGames(this.value)">
    </div>
    <div class="window-content">
        <div class="games-grid" id="gamesList"></div>
    </div>
</div>

<div class="os-window" id="appsWindow" style="width:680px;height:480px;top:80px;left:120px;">
    <div class="window-titlebar" id="appsWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeWindow('appsWindow')">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('appsWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('appsWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Apps</div>
        <div style="width:40px;"></div>
    </div>
    <div class="games-window-header">
        <input type="text" class="games-search-input" id="appsSearch" placeholder="üîç  Search apps..." oninput="renderApps(this.value)">
    </div>
    <div class="window-content">
        <div class="games-grid" id="appsList"></div>
    </div>
</div>

<div class="os-window" id="chatWindow" style="width:480px;height:560px;top:60px;right:60px;">
    <div class="window-titlebar" id="chatWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeChat()">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('chatWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('chatWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Chat Room</div>
        <div style="width:40px;"></div>
    </div>
    <div class="window-content">
        <div class="chat-body">
            <div class="chat-status-bar" id="chatStatus">Connecting...</div>
            <div class="chat-messages-area" id="chatMessages"></div>
            <div class="typing-indicator" id="typingIndicator">
                <span id="typingUsers"></span>
                <span class="typing-dots"><span></span><span></span><span></span></span>
            </div>
            <div class="replying-to-bar" id="replyingToBar">
                Replying to <strong id="replyingToUser"></strong>
                <button class="cancel-reply" onclick="cancelReply()">√ó</button>
            </div>
            <div class="image-preview-bar">
                <div style="position:relative;display:inline-block;">
                    <img id="imagePreview" class="image-preview">
                    <button onclick="removeImage()" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--primary);border:none;border-radius:50%;width:18px;height:18px;color:white;cursor:pointer;font-size:11px;display:none;align-items:center;justify-content:center;" class="remove-image">√ó</button>
                </div>
            </div>
            <div class="chat-input-bar">
                <label for="imageInput" class="img-upload-btn" title="Upload image"><i class="fas fa-image"></i></label>
                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                <input type="text" id="chatInput" class="chat-text-input" placeholder="Type a message... (try :sob: or :heart:)" onkeypress="handleChatKeyPress(event)" oninput="handleTyping()">
                <button class="chat-send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<div class="os-window" id="settingsWindow" style="width:440px;height:560px;top:80px;left:50%;transform:translateX(-50%);">
    <div class="window-titlebar" id="settingsWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeWindow('settingsWindow')">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('settingsWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('settingsWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Settings</div>
        <div style="width:40px;"></div>
    </div>
    <div class="window-content">
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-label">Theme</div>
                <select class="theme-selector" id="themeSelector" onchange="changeTheme(this.value)">
                    <option value="purple">Purple</option>
                    <option value="green">Green</option>
                    <option value="blue">Blue</option>
                    <option value="red">Red</option>
                    <option value="pink">Pink</option>
                    <option value="spooky">Spooky</option>
                    <option value="sky">Sky</option>
                    <option value="yellow">Yellow</option>
                    <option value="galaxy">Galaxy</option>
                    <option value="blackwhite">Slate</option>
                </select>
            </div>
            <div class="settings-section">
                <div class="settings-label">Search Engine</div>
                <div class="se-grid">
                    <button class="se-btn active" id="se-google" onclick="setSearchEngine('google',this)">Google</button>
                    <button class="se-btn" id="se-bing" onclick="setSearchEngine('bing',this)">Bing</button>
                    <button class="se-btn" id="se-ddg" onclick="setSearchEngine('ddg',this)">DuckDuckGo</button>
                    <button class="se-btn" id="se-yahoo" onclick="setSearchEngine('yahoo',this)">Yahoo</button>
                    <button class="se-btn" id="se-brave" onclick="setSearchEngine('brave',this)">Brave</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-label">Options</div>
                <div class="toggle-row">
                    <span class="toggle-row-label">Tab Cloaking</span>
                    <div class="toggle-switch" id="cloakToggle" onclick="toggleCloak()"><div class="toggle-slider"></div></div>
                </div>
                <div class="toggle-row">
                    <span class="toggle-row-label">Panic Key (' key)</span>
                    <div class="toggle-switch" id="panicToggle" onclick="togglePanic()"><div class="toggle-slider"></div></div>
                </div>
                <div class="toggle-row">
                    <span class="toggle-row-label">Show Particles</span>
                    <div class="toggle-switch active" id="particlesToggle" onclick="toggleParticles()"><div class="toggle-slider"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="os-window" id="updateWindow" style="width:400px;height:360px;top:120px;left:50%;transform:translateX(-50%);">
    <div class="window-titlebar" id="updateWindowBar">
        <div class="window-controls">
            <button class="wc-btn wc-close" title="Close" onclick="closeWindow('updateWindow')">‚úï</button>
            <button class="wc-btn wc-min" title="Minimize" onclick="minimizeWindow('updateWindow')">‚îÄ</button>
            <button class="wc-btn wc-max" title="Maximize" onclick="maximizeWindow('updateWindow')">‚ñ°</button>
        </div>
        <div class="window-title">Latest Update</div>
        <div style="width:40px;"></div>
    </div>
    <div class="window-content">
        <div class="update-content">
            <div class="update-version">v2.5.0</div>
            <div class="update-subtitle">What's new in this update</div>
            <div class="update-notes">
                ‚Ä¢ yayy v2<br>
                ‚Ä¢ Finally added a working proxy!!<br>
                ‚Ä¢ To access it, just double-click Proxy!<br>
                ‚Ä¢ CHAT UPDATES:<br>
                ‚Ä¢ Added a filter (only for slurs)<br>
                ‚Ä¢ Added emoji shortcuts (like :sob:)<br>
                ‚Ä¢ Completely redesigned UI!<br>
                ‚Ä¢ thats all, enjoy!
            </div>
        </div>
    </div>
</div>

<div id="fullscreenOverlay">
    <div class="fullscreen-bar">
        <button class="fullscreen-back-btn" id="fullscreenBackBtn" onclick="closeFullscreen()">‚Üê Back</button>
        <span class="fullscreen-title" id="fullscreenTitle"></span>
    </div>
    <iframe id="fullscreenIframe"></iframe>
</div>

<div id="loadingScreen">
    <div class="loader"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<div class="overlay-modal" id="nameRequestModal">
    <div class="overlay-modal-box">
        <div class="overlay-modal-title">Someone wants your name</div>
        <div class="overlay-modal-text">
            <strong id="nameRequesterDisplay">Someone</strong> wants to use the name <strong id="nameRequestedDisplay"></strong>. Allow this?
        </div>
        <div class="modal-btn-row">
            <button class="modal-btn primary" onclick="respondToNameRequest(true)">Allow</button>
            <button class="modal-btn secondary" onclick="respondToNameRequest(false)">Deny</button>
        </div>
    </div>
</div>

<div class="overlay-modal" id="nameWaitingOverlay">
    <div class="overlay-modal-box">
        <div class="waiting-spinner"></div>
        <div class="overlay-modal-title">Waiting for approval...</div>
        <div class="overlay-modal-text" id="nameWaitingText">The user with that name has been notified.</div>
    </div>
</div>

<div class="floating-warning" id="spamWarning">
    <div id="spamWarningText">Hey, stop spamming!!</div>
</div>

<div class="floating-warning" id="slurWarning">
    <div class="slur-icon">üö´</div>
    <div class="slur-title">Not allowed.</div>
    <div class="slur-text">Sorry, this isn't allowed.</div>
    <div class="slur-timer" id="slurTimer">10</div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, push, onChildAdded, onChildChanged, onChildRemoved, limitToLast, query, remove, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCtWJWMhHL3ZZ8cyG6oYLJLLWRpqLHrdA",
        authDomain: "desritory-chat.firebaseapp.com",
        databaseURL: "https://desritory-chat-default-rtdb.firebaseio.com",
        projectId: "desritory-chat",
        storageBucket: "desritory-chat.firebasestorage.app",
        messagingSenderId: "799268069839",
        appId: "1:799268069839:web:4bcbfa0389603054bf32ba"
    };

    let isFirebaseInitialized = false;
    let database = null;
    let messagesRef, typingRef, presenceRef, activeNamesRef, nameRequestsRef;

    try {
        const app = initializeApp(firebaseConfig);
        database = getDatabase(app);
        messagesRef = ref(database, 'messages');
        typingRef = ref(database, 'typing');
        presenceRef = ref(database, 'presence');
        activeNamesRef = ref(database, 'activeNames');
        nameRequestsRef = ref(database, 'nameRequests');
        isFirebaseInitialized = true;
        initializePresence();
    } catch (error) {
        console.error('Firebase error:', error);
        updateChatStatus('error', 'Firebase not configured');
    }

    function initializePresence() {
        if (!isFirebaseInitialized) return;
        const currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userPresenceRef = ref(database, `presence/${currentUserId}`);
        set(userPresenceRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {});
        onDisconnect(userPresenceRef).remove();
        setInterval(() => {
            if (isFirebaseInitialized) set(userPresenceRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {});
        }, 30000);
        onValue(ref(database, 'presence'), (snapshot) => {
            const d = snapshot.val();
            const el = document.getElementById('usersActive');
            if (el) el.textContent = d ? Object.keys(d).length : 0;
        });
    }

    window.firebaseChat = {
        sendMessage: (username, text, imageUrl = null, replyTo = null) => {
            if (!isFirebaseInitialized) return Promise.reject('Firebase not initialized');
            const messageData = { username, text, timestamp: serverTimestamp() };
            if (imageUrl) messageData.imageUrl = imageUrl;
            if (replyTo) messageData.replyTo = replyTo;
            return push(messagesRef, messageData);
        },
        listenToMessages: (callback) => {
            if (!isFirebaseInitialized) return;
            onChildAdded(query(messagesRef, limitToLast(50)), (snapshot) => {
                const message = snapshot.val();
                message.id = snapshot.key;
                callback(message);
            });
        },
        setTyping: (username, isTyping) => {
            if (!isFirebaseInitialized) return Promise.reject();
            const userTypingRef = ref(database, `typing/${username.replace(/[.#$[\]]/g, '_')}`);
            return isTyping ? set(userTypingRef, { username, timestamp: serverTimestamp() }) : remove(userTypingRef);
        },
        listenToTyping: (callback) => {
            if (!isFirebaseInitialized) return;
            onChildAdded(typingRef, (s) => { const d = s.val(); if (d) callback(d.username, true); });
            onChildChanged(typingRef, (s) => { const d = s.val(); if (d) callback(d.username, true); });
            onChildRemoved(typingRef, (s) => { const d = s.val(); if (d) callback(d.username, false); });
        },
        isInitialized: () => isFirebaseInitialized,
        checkNameAvailable: async (name) => {
            if (!isFirebaseInitialized) return { available: true };
            const safeName = name.replace(/[.#$[\]]/g, '_').toLowerCase();
            const nameRef = ref(database, `activeNames/${safeName}`);
            const snapshot = await get(nameRef);
            if (!snapshot.exists()) return { available: true };
            const data = snapshot.val();
            if (Date.now() - data.lastSeen > 120000) { await remove(nameRef); return { available: true }; }
            return { available: false, ownerId: data.ownerId };
        },
        claimName: (name, ownerId) => {
            if (!isFirebaseInitialized) return Promise.resolve();
            const safeName = name.replace(/[.#$[\]]/g, '_').toLowerCase();
            const nameRef = ref(database, `activeNames/${safeName}`);
            onDisconnect(nameRef).remove();
            return set(nameRef, { ownerId, lastSeen: serverTimestamp(), displayName: name });
        },
        keepNameAlive: (name, ownerId) => {
            if (!isFirebaseInitialized) return;
            const safeName = name.replace(/[.#$[\]]/g, '_').toLowerCase();
            set(ref(database, `activeNames/${safeName}`), { ownerId, lastSeen: serverTimestamp(), displayName: name }).catch(() => {});
        },
        releaseName: (name) => {
            if (!isFirebaseInitialized) return;
            remove(ref(database, `activeNames/${name.replace(/[.#$[\]]/g, '_').toLowerCase()}`)).catch(() => {});
        },
        sendNameRequest: (requestId, requesterTemp, desiredName, targetOwnerId) => {
            if (!isFirebaseInitialized) return Promise.reject();
            return set(ref(database, `nameRequests/${requestId}`), { requesterTemp, desiredName, targetOwnerId, status: 'pending', timestamp: serverTimestamp() });
        },
        listenNameRequest: (requestId, callback) => {
            if (!isFirebaseInitialized) return;
            onValue(ref(database, `nameRequests/${requestId}`), (s) => { if (s.exists()) callback(s.val()); });
        },
        listenForIncomingNameRequests: (ownerId, callback) => {
            if (!isFirebaseInitialized) return;
            const seenRequests = new Set();
            onValue(nameRequestsRef, (snapshot) => {
                snapshot.forEach((child) => {
                    const data = child.val();
                    if (data && data.targetOwnerId === ownerId && data.status === 'pending' && !seenRequests.has(child.key)) {
                        seenRequests.add(child.key);
                        callback(child.key, data);
                    }
                });
            });
        },
        respondToNameRequest: (requestId, approved) => {
            if (!isFirebaseInitialized) return Promise.reject();
            return set(ref(database, `nameRequests/${requestId}`), { status: approved ? 'approved' : 'denied', timestamp: serverTimestamp() });
        },
        cleanupNameRequest: (requestId) => {
            if (!isFirebaseInitialized) return;
            remove(ref(database, `nameRequests/${requestId}`)).catch(() => {});
        }
    };

    function updateChatStatus(status, text) {
        const el = document.getElementById('chatStatus');
        if (el) { el.className = 'chat-status-bar ' + status; el.textContent = text; }
    }

    if (isFirebaseInitialized) updateChatStatus('connected', 'üü¢ Connected ‚Äî Real-time chat active');

    const startTime = Date.now();
    setInterval(() => {
        const ms = Date.now() - startTime;
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        const el = document.getElementById('uptimeDisplay');
        if (el) el.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }, 1000);

    window.updateActiveUsersCount = (count) => {
        const el = document.getElementById('usersActive');
        if (el) el.textContent = count;
    };
</script>

<script>
    const EMOJI_SHORTCUTS = {
        ':sob:':'üò≠',':cry:':'üò¢',':smile:':'üòä',':laugh:':'üòÇ',':lol:':'üòÇ',
        ':rofl:':'ü§£',':heart:':'‚ù§Ô∏è',':broken_heart:':'üíî',':fire:':'üî•',
        ':100:':'üíØ',':thumbsup:':'üëç',':thumbsdown:':'üëé',':ok:':'üëå',
        ':wave:':'üëã',':clap:':'üëè',':pray:':'üôè',':skull:':'üíÄ',':eyes:':'üëÄ',
        ':thinking:':'ü§î',':shrug:':'ü§∑',':facepalm:':'ü§¶',':wink:':'üòâ',
        ':sunglasses:':'üòé',':cool:':'üòé',':angry:':'üò†',':rage:':'üò§',
        ':sad:':'üòû',':pensive:':'üòî',':shocked:':'üò±',':scream:':'üò±',
        ':sweat:':'üòÖ',':nervous:':'üò¨',':smirk:':'üòè',':tongue:':'üòõ',
        ':kiss:':'üòò',':love:':'ü•∞',':sparkles:':'‚ú®',':star:':'‚≠ê',
        ':rainbow:':'üåà',':sun:':'‚òÄÔ∏è',':moon:':'üåô',':snowflake:':'‚ùÑÔ∏è',
        ':pizza:':'üçï',':burger:':'üçî',':taco:':'üåÆ',':cat:':'üê±',
        ':dog:':'üê∂',':penguin:':'üêß',':frog:':'üê∏',':ghost:':'üëª',
        ':alien:':'üëΩ',':robot:':'ü§ñ',':poop:':'üí©',':clown:':'ü§°',
        ':crown:':'üëë',':gem:':'üíé',':rocket:':'üöÄ',':boom:':'üí•',
        ':party:':'üéâ',':tada:':'üéâ',':music:':'üéµ',':headphones:':'üéß',
        ':coffee:':'‚òï',':gaming:':'üéÆ',':sus:':'üìÆ',':pepe:':'üê∏',
        ':nerd:':'ü§ì',':monocle:':'üßê',':dead:':'üíÄ',':based:':'üòé',
        ':goat:':'üêê',':real:':'üíØ',':cap:':'üß¢',':nocap:':'üíØ',
    };

    const SLUR_PATTERNS = [
        /\bn[i!1|]+[g9]+[e3]+r/gi,/\bn[i!1|]+g{2,}/gi,/\bn[i!1|]gg[ae3]/gi,
        /\bf[a@]+g{2,}[o0]t/gi,/\bf[a@]+g[s$]/gi,/\bfagg?[o0]t/gi,/\bfag\b/gi,
        /\bk[i!1]+k[e3]/gi,/\bsp[i!1]+c/gi,/\bch[i!1]+nk/gi,
        /\bw[e3]+tb[a@]+ck/gi,/\bcr[a@]+ck[e3]+r/gi,/\br[e3]+t[a@]+rd/gi,
        /\bc[o0]+[o0]+n/gi,/\bj[i!1]+gg[a@]+b[o0]+[o0]/gi,
        /\bs[a@]+ndN[i!1]+gg[e3]+r/gi,/\btr[a@]+nn[yi]/gi,/\bsh[e3]m[a@]+l[e3]/gi,
        /\bn1gger/gi,/\bn1gg3r/gi,/\br3gg1n\b/gi,
        /[a-z0-9]nigger/gi,/[a-z0-9]n1gger/gi,/[a-z0-9]n1gg3r/gi,
    ];

    const SEARCH_ENGINES = {
        google:'https://www.google.com/search?q=%s',
        bing:'https://www.bing.com/search?q=%s',
        ddg:'https://duckduckgo.com/?q=%s',
        yahoo:'https://search.yahoo.com/search?p=%s',
        brave:'https://search.brave.com/search?q=%s',
    };

    const SCRAMJET_URL = 'https://scramjet-app-production-a204.up.railway.app';

    const IMAGES = {
        jhbetr:'https://i.imgur.com/IZ0wJQb.jpeg',minecraft:'https://i.imgur.com/ppi20I9.png',
        gd:'https://i.imgur.com/fpc76U0.jpeg',lacey:'https://i.imgur.com/KEYn8gZ.png',
        ultrakill:'https://i.imgur.com/wgmTwWM.jpeg',epstein:'https://i.imgur.com/OiAiMSl.png',
        fnaf1:'https://i.imgur.com/11OJGXJ.jpeg',fnaf2:'https://i.imgur.com/OfpGVct.jpeg',
        fnaf3:'https://i.imgur.com/ZcwnBE4.png',fnaf4:'https://i.imgur.com/Ew1nrVj.png',
        hollow:'https://i.imgur.com/iaSgADM.jpeg',fnaf4h:'https://i.imgur.com/MvYx18h.png',
        fnafsister:'https://i.imgur.com/bLD2AQ1.png',fnafpizza:'https://i.imgur.com/xU4nL4x.png',
        fnafucn:'https://i.imgur.com/uIPUty9.png',people:'https://i.imgur.com/BgcqQ1w.png',
        gtag:'https://i.imgur.com/LziGRnF.png',bendy:'https://i.imgur.com/N63N7D7.png',
        alien:'https://i.imgur.com/e0IXj6f.png',sans:'https://i.imgur.com/396NH6D.png',
        happy:'https://i.imgur.com/0ocMSU3.png',undertale:'https://i.imgur.com/vOKZyyK.png',
        class:'https://i.imgur.com/4ofYraf.png',
    };

    const games = [
        {name:'JHBETR',icon:IMAGES.jhbetr,url:'https://jhbetr.github.io/',category:'amazing game play it'},
        {name:'Minecraft',icon:IMAGES.minecraft,url:'/games/minecraft.html',category:'minecraft'},
        {name:'Geometry Dash',icon:IMAGES.gd,url:'/games/gdlite/index.html',category:'BROKEN AUDIO'},
        {name:'Lacey Games',icon:IMAGES.lacey,url:'/games/laceygames/index.html',category:'lacey games'},
        {name:'ULTRAKILL',icon:IMAGES.ultrakill,url:'/games/ultrakill/index.html',category:'ultrakill fun'},
        {name:'Five Nights at Epsteins',icon:IMAGES.epstein,url:'/games/epstein.html',category:'Survive Epstein'},
        {name:'FNaF 1',icon:IMAGES.fnaf1,url:'/games/fnaf.html',category:'Fnaf 1'},
        {name:'FNaF 2',icon:IMAGES.fnaf2,url:'/games/fnaf2.html',category:'fnaf 2'},
        {name:'FNaF 3',icon:IMAGES.fnaf3,url:'/games/fnaf3.html',category:'fnaf 3'},
        {name:'Fnaf 4',icon:IMAGES.fnaf4,url:'/games/fnaf4.html',category:'fnaf 4'},
        {name:'Fnaf 4 Halloween',icon:IMAGES.fnaf4h,url:'/games/fnaf4h.html',category:'fnaf 4 scarier'},
        {name:'Fnaf Sister Location',icon:IMAGES.fnafsister,url:'/games/fnafsister.html',category:'scarier fnaf'},
        {name:'Fnaf Pizza Game',icon:IMAGES.fnafpizza,url:'/games/fnafpizza.html',category:'pizza scary'},
        {name:'Ultimate Custom Night',icon:IMAGES.fnafucn,url:'/games/fnafucn.html',category:'ultimate custom night'},
        {name:'Class of 09',icon:IMAGES.class,url:'/games/classof09.html',category:'very fun'},
        {name:'Undertale',icon:IMAGES.undertale,url:'/games/UNDERTALE.html',category:'fun game'},
        {name:'Hollow Knight',icon:IMAGES.hollow,url:'/games/hollowknight.html',category:'fire game'},
        {name:'People Playground',icon:IMAGES.people,url:'/games/peopleplayground.html',category:'fun'},
        {name:'Gorilla Tag',icon:IMAGES.gtag,url:'/games/gorillatag.html',category:'gorilla'},
        {name:'Bendy and the Ink Machine',icon:IMAGES.bendy,url:'/games/bendy.html',category:'scary'},
        {name:'Alien Hominid',icon:IMAGES.alien,url:'/games/alienhominid.html',category:'alien game'},
        {name:'Bad Time Simulator',icon:IMAGES.sans,url:'/games/badtimesimulator.html',category:'bad time'},
        {name:'Happy Wheels',icon:IMAGES.happy,url:'/games/happywheels.html',category:'gorey'},
    ];

    const apps = [
        {name:'YouTube',icon:'https://i.imgur.com/BqC7P4i.png',url:'https://youtube.com',category:'Video streaming'},
    ];

    const themeNames = {
        purple:'Purple',green:'Green',blue:'Blue',red:'Red',pink:'Pink',
        spooky:'Spooky',sky:'Sky',yellow:'Yellow',galaxy:'Galaxy',blackwhite:'Slate'
    };

    const themes = {
        purple:{primary:'#7c4dff',secondary:'#9333ea',accent:'#a855f7',light:'#c084fc',glow:'rgba(120,70,220,0.4)',bg:'#0f1520',particleColor1:'rgba(124,77,255,0.8)',particleColor2:'rgba(168,85,247,0.6)'},
        green:{primary:'#10b981',secondary:'#059669',accent:'#34d399',light:'#6ee7b7',glow:'rgba(16,185,129,0.4)',bg:'#0a1e16',particleColor1:'rgba(16,185,129,0.8)',particleColor2:'rgba(52,211,153,0.6)'},
        blue:{primary:'#3b82f6',secondary:'#1d4ed8',accent:'#60a5fa',light:'#93c5fd',glow:'rgba(59,130,246,0.4)',bg:'#0a0f1e',particleColor1:'rgba(59,130,246,0.8)',particleColor2:'rgba(96,165,250,0.6)'},
        red:{primary:'#ef4444',secondary:'#dc2626',accent:'#f87171',light:'#fca5a5',glow:'rgba(239,68,68,0.4)',bg:'#1a0a0a',particleColor1:'rgba(239,68,68,0.8)',particleColor2:'rgba(248,113,113,0.6)'},
        pink:{primary:'#ec4899',secondary:'#db2777',accent:'#f472b6',light:'#f9a8d4',glow:'rgba(236,72,153,0.4)',bg:'#1a0a14',particleColor1:'rgba(236,72,153,0.8)',particleColor2:'rgba(244,114,182,0.6)'},
        spooky:{primary:'#ff6b00',secondary:'#ff8c00',accent:'#ffa500',light:'#ffb347',glow:'rgba(255,107,0,0.4)',bg:'#150a04',particleColor1:'rgba(255,107,0,0.8)',particleColor2:'rgba(255,140,0,0.6)'},
        sky:{primary:'#38bdf8',secondary:'#0ea5e9',accent:'#7dd3fc',light:'#bae6fd',glow:'rgba(56,189,248,0.4)',bg:'#0a1420',particleColor1:'rgba(56,189,248,0.8)',particleColor2:'rgba(125,211,252,0.6)'},
        yellow:{primary:'#eab308',secondary:'#ca8a04',accent:'#facc15',light:'#fde047',glow:'rgba(234,179,8,0.4)',bg:'#161200',particleColor1:'rgba(234,179,8,0.8)',particleColor2:'rgba(250,204,21,0.6)'},
        galaxy:{primary:'#9333ea',secondary:'#7c3aed',accent:'#a855f7',light:'#c084fc',glow:'rgba(147,51,234,0.4)',bg:'#060610',particleColor1:'rgba(147,51,234,0.8)',particleColor2:'rgba(168,85,247,0.6)'},
        blackwhite:{primary:'#888888',secondary:'#666666',accent:'#aaaaaa',light:'#cccccc',glow:'rgba(136,136,136,0.4)',bg:'#0f1520',particleColor1:'rgba(136,136,136,0.8)',particleColor2:'rgba(170,170,170,0.6)'}
    };

    let windowZIndex = 5000;
    let openWindows = new Set();
    let minimizedWindows = new Map();
    let windowOrigSize = new Map();

    function openWindow(id) {
        const win = document.getElementById(id);
        win.style.display = 'flex';
        win.classList.add('visible');
        win.style.zIndex = ++windowZIndex;
        openWindows.add(id);
        updateTaskbar();
        makeDraggable(win);
    }

    function closeWindow(id) {
        const win = document.getElementById(id);
        win.classList.remove('visible');
        setTimeout(() => { win.style.display = 'none'; }, 200);
        openWindows.delete(id);
        minimizedWindows.delete(id);
        updateTaskbar();
    }

    function minimizeWindow(id) {
        const win = document.getElementById(id);
        win.style.display = 'none';
        minimizedWindows.set(id, true);
        openWindows.add(id);
        updateTaskbar();
    }

    function maximizeWindow(id) {
        const win = document.getElementById(id);
        if (win.dataset.maximized === 'true') {
            const orig = windowOrigSize.get(id);
            if (orig) {
                win.style.cssText = orig;
                win.dataset.maximized = 'false';
            }
        } else {
            windowOrigSize.set(id, win.style.cssText);
            win.style.position = 'fixed';
            win.style.top = '0';
            win.style.left = '0';
            win.style.right = '0';
            win.style.bottom = '52px';
            win.style.width = '100vw';
            win.style.height = 'calc(100vh - 52px)';
            win.style.transform = 'none';
            win.style.borderRadius = '0';
            win.dataset.maximized = 'true';
        }
    }

    function focusWindow(id) {
        const win = document.getElementById(id);
        if (win) win.style.zIndex = ++windowZIndex;
    }

    function updateTaskbar() {
        const bar = document.getElementById('taskbarApps');
        bar.innerHTML = '';
        openWindows.forEach(id => {
            const win = document.getElementById(id);
            if (!win) return;
            const titleEl = win.querySelector('.window-title');
            const title = titleEl ? titleEl.textContent : id;
            const isMinimized = minimizedWindows.get(id);
            const btn = document.createElement('button');
            btn.className = 'taskbar-app-btn' + (win.style.display !== 'none' ? ' active' : '');
            btn.innerHTML = `<span class="tb-dot"></span>${title}`;
            btn.onclick = () => {
                if (isMinimized || win.style.display === 'none') {
                    win.style.display = 'flex';
                    win.classList.add('visible');
                    minimizedWindows.delete(id);
                    focusWindow(id);
                } else {
                    minimizeWindow(id);
                }
                updateTaskbar();
            };
            bar.appendChild(btn);
        });
    }

    function makeDraggable(win) {
        const titlebar = win.querySelector('.window-titlebar');
        if (!titlebar || titlebar._draggable) return;
        titlebar._draggable = true;
        let startX, startY, startLeft, startTop;

        titlebar.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('wc-btn')) return;
            if (win.dataset.maximized === 'true') return;
            startX = e.clientX;
            startY = e.clientY;
            const rect = win.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            win.style.transform = 'none';
            win.style.left = startLeft + 'px';
            win.style.top = startTop + 'px';
            win.style.zIndex = ++windowZIndex;

            function onMove(e) {
                win.style.left = (startLeft + e.clientX - startX) + 'px';
                win.style.top = (startTop + e.clientY - startY) + 'px';
            }

            function onUp() {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });

        win.addEventListener('mousedown', () => {
            win.style.zIndex = ++windowZIndex;
        });
    }

    document.querySelectorAll('.os-window').forEach(win => makeDraggable(win));

    function selectIcon(el) {
        document.querySelectorAll('.app-icon .app-icon-box').forEach(b => b.style.background = '');
        el.querySelector('.app-icon-box').style.background = 'rgba(124,77,255,0.25)';
    }

    function updateTime() {
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        document.getElementById('timeDisplay').textContent = h + ':' + String(m).padStart(2,'0') + ' ' + ampm;
    }
    updateTime();
    setInterval(updateTime, 1000);

    function setDesktopSubtitle() {
        const hour = new Date().getHours();
        let phrases;
        if (hour >= 0 && hour < 5) phrases = ["you're up late", "hi night owl", "go to sleep.", "why are you awake"];
        else if (hour >= 7 && hour < 9) phrases = ["you're up early", "goodmorning", "wow its morning"];
        else phrases = ["browse games", "desritory", "Have fun!", "Welcome to Freedom.", "Haiiiii :333"];
        document.getElementById('desktopSubtitle').textContent = phrases[Math.floor(Math.random() * phrases.length)];
    }
    setDesktopSubtitle();

    let trayOpen = false;
    function toggleSystemTray() {
        trayOpen = !trayOpen;
        document.getElementById('systemTray').classList.toggle('visible', trayOpen);
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#systemTray') && !e.target.closest('.taskbar-start')) {
            trayOpen = false;
            document.getElementById('systemTray').classList.remove('visible');
        }
    });

    function changeTheme(colorName) {
        const theme = themes[colorName];
        if (!theme) return;
        localStorage.setItem('desritory-theme', colorName);
        document.getElementById('currentTheme').textContent = themeNames[colorName];
        document.body.style.background = theme.bg;
        document.documentElement.style.setProperty('--primary', theme.primary);
        document.documentElement.style.setProperty('--secondary', theme.secondary);
        document.documentElement.style.setProperty('--accent', theme.accent);
        document.documentElement.style.setProperty('--light', theme.light);
        document.documentElement.style.setProperty('--glow', theme.glow);
        document.documentElement.style.setProperty('--bg', theme.bg);
        document.documentElement.style.setProperty('--particle-color-1', theme.particleColor1);
        document.documentElement.style.setProperty('--particle-color-2', theme.particleColor2);
        const sel = document.getElementById('themeSelector');
        if (sel) sel.value = colorName;
    }

    function setSearchEngine(key, btn) {
        localStorage.setItem('desritory-searchengine', key);
        document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function getSearchEngineUrl() {
        return SEARCH_ENGINES[localStorage.getItem('desritory-searchengine') || 'google'] || SEARCH_ENGINES.google;
    }

    (function() {
        const saved = localStorage.getItem('desritory-searchengine') || 'google';
        const btn = document.getElementById('se-' + saved);
        if (btn) { document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    })();

    function toggleStealthMode() {
        const current = localStorage.getItem('desritory-stealth') === 'true';
        const newVal = !current;
        localStorage.setItem('desritory-stealth', newVal);
        applyStealthMode(newVal);
    }

    function applyStealthMode(enabled) {
        const stealthStatus = document.getElementById('stealthStatus');
        if (enabled) {
            document.title = 'Google';
            const favicon = document.querySelector("link[rel*='icon']") || document.createElement('link');
            favicon.type = 'image/x-icon'; favicon.rel = 'shortcut icon';
            favicon.href = 'https://www.google.com/favicon.ico';
            document.getElementsByTagName('head')[0].appendChild(favicon);
            if (stealthStatus) stealthStatus.textContent = 'Enabled';
        } else {
            document.title = 'Desritory V2';
            const favicon = document.querySelector("link[rel*='icon']");
            if (favicon) favicon.href = '';
            if (stealthStatus) stealthStatus.textContent = 'Disabled';
        }
    }

    function launchProxy() {
        const input = document.getElementById('proxySearchInput').value.trim();
        if (!input) return;
        launchProxyUrl(input);
    }

    function launchProxyUrl(url) {
        let finalUrl = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            if (url.includes('.') && !url.includes(' ')) finalUrl = 'https://' + url;
            else finalUrl = getSearchEngineUrl().replace('%s', encodeURIComponent(url));
        }
        const iframe = document.getElementById('proxyIframe');
        iframe.src = `${SCRAMJET_URL}#${encodeURIComponent(finalUrl)}`;
        iframe.style.display = 'block';
        document.getElementById('proxyHome').style.display = 'none';
        openWindow('proxyWindow');
    }

    function initProxy() {
        const iframe = document.getElementById('proxyIframe');
        iframe.src = SCRAMJET_URL;
        iframe.style.display = 'block';
        document.getElementById('proxyHome').style.display = 'none';
    }

    function handleProxySearch(e) { if (e.key === 'Enter') launchProxy(); }
    function handleProxyUrlBar(e) { if (e.key === 'Enter') goToProxyUrl(); }
    function goToProxyUrl() { const v = document.getElementById('proxyUrlBar').value.trim(); if (v) launchProxyUrl(v); }
    function refreshProxy() { const f = document.getElementById('proxyIframe'); f.src = f.src; }
    function proxyGoBack() { document.getElementById('proxyIframe').contentWindow.history.back(); }
    function proxyGoForward() { document.getElementById('proxyIframe').contentWindow.history.forward(); }

    function closeProxyBrowser() {
        document.getElementById('proxyBrowserBar').classList.remove('visible');
        document.getElementById('proxyHome').style.display = 'flex';
        const iframe = document.getElementById('proxyIframe');
        iframe.style.display = 'none';
        iframe.src = '';
    }

    function openGamesWindow() {
        renderGames();
        openWindow('gamesWindow');
    }

    function openAppsWindow() {
        renderApps();
        openWindow('appsWindow');
    }

    function renderGames(filter = '') {
        const list = document.getElementById('gamesList');
        list.innerHTML = '';
        games.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()) || g.category.toLowerCase().includes(filter.toLowerCase()))
            .forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `<img class="game-card-icon" src="${game.icon}" alt="${game.name}"><div class="game-card-info"><div class="game-card-name">${game.name}</div><div class="game-card-cat">${game.category}</div></div>`;
                card.onclick = () => openFullscreen(game.name, game.url);
                list.appendChild(card);
            });
    }

    function renderApps(filter = '') {
        const list = document.getElementById('appsList');
        list.innerHTML = '';
        const filtered = apps.filter(a => a.name.toLowerCase().includes(filter.toLowerCase()));
        if (!filtered.length) {
            list.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.4);">No apps yet. Check back soon!</div>';
            return;
        }
        filtered.forEach(app => {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.innerHTML = `<img class="game-card-icon" src="${app.icon}" alt="${app.name}"><div class="game-card-info"><div class="game-card-name">${app.name}</div><div class="game-card-cat">${app.category}</div></div>`;
            card.onclick = () => openFullscreen(app.name, app.url);
            list.appendChild(card);
        });
    }

    function openFullscreen(name, url) {
        const loadingScreen = document.getElementById('loadingScreen');
        const isSpecialLoad = name === 'Games' && Math.random() < 1/20;
        document.getElementById('loadingText').textContent = isSpecialLoad ? 'probably fine' : `Loading ${name}...`;
        loadingScreen.classList.add('active');
        setTimeout(() => {
            loadingScreen.classList.remove('active');
            document.getElementById('fullscreenTitle').textContent = name;
            document.getElementById('fullscreenIframe').src = url;
            document.getElementById('fullscreenOverlay').classList.add('active');
        }, isSpecialLoad ? 3000 : 600);
    }

    function closeFullscreen() {
        document.getElementById('fullscreenOverlay').classList.remove('active');
        document.getElementById('fullscreenIframe').src = '';
    }

    let username = localStorage.getItem('desritory-username') || '';
    let myOwnerId = localStorage.getItem('desritory-ownerid') || '';
    let isChatOpen = false;
    let messageIds = new Set();
    let messagesCache = {};
    let replyingToMessage = null;
    let selectedImageBase64 = null;
    let typingTimeout = null;
    let currentlyTypingUsers = new Set();
    let unreadMessageCount = 0;
    let lastReadTimestamp = Date.now();
    let messageHistory = [];
    let spamWarningCount = 0;
    let spamWarningTimeout = null;
    let slurTimeoutId = null;
    let slurTimerInterval = null;
    let nameKeepAliveInterval = null;
    let pendingNameRequestId = null;
    let pendingNameRequestResolve = null;
    let chatListenersAttached = false;
    let bufferedMessages = [];
    let pendingIncomingRequestId = null;

    if (!myOwnerId) {
        myOwnerId = 'owner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('desritory-ownerid', myOwnerId);
    }

    function updateNotificationBadge() {
        const badge = document.getElementById('chatNotificationBadge');
        if (unreadMessageCount > 0) {
            badge.textContent = unreadMessageCount > 99 ? '99+' : unreadMessageCount;
            badge.classList.add('active');
        } else {
            badge.classList.remove('active');
        }
    }

    async function resolveUsername(desiredName) {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return desiredName;
        let result;
        try { result = await window.firebaseChat.checkNameAvailable(desiredName); } catch (e) { return desiredName; }
        if (result.available) { await window.firebaseChat.claimName(desiredName, myOwnerId); return desiredName; }
        if (result.ownerId === myOwnerId) return desiredName;
        return new Promise((resolve) => {
            pendingNameRequestResolve = resolve;
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
            pendingNameRequestId = requestId;
            document.getElementById('nameWaitingOverlay').classList.add('active');
            document.getElementById('nameWaitingText').textContent = `Waiting for the current holder of "${desiredName}" to respond...`;
            window.firebaseChat.sendNameRequest(requestId, myOwnerId, desiredName, result.ownerId);
            window.firebaseChat.listenNameRequest(requestId, (data) => {
                if (data.status === 'approved') {
                    document.getElementById('nameWaitingOverlay').classList.remove('active');
                    window.firebaseChat.claimName(desiredName, myOwnerId);
                    window.firebaseChat.cleanupNameRequest(requestId);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    resolve(desiredName);
                } else if (data.status === 'denied') {
                    document.getElementById('nameWaitingOverlay').classList.remove('active');
                    window.firebaseChat.cleanupNameRequest(requestId);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = desiredName + Math.floor(Math.random() * 9000 + 1000);
                    alert(`Request denied. You'll be assigned "${alt}" instead.`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            });
            setTimeout(() => {
                if (pendingNameRequestResolve) {
                    document.getElementById('nameWaitingOverlay').classList.remove('active');
                    window.firebaseChat.cleanupNameRequest(requestId);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = desiredName + Math.floor(Math.random() * 9000 + 1000);
                    alert(`No response. You'll be assigned "${alt}" instead.`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            }, 30000);
        });
    }

    function listenForNameRequests() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return;
        window.firebaseChat.listenForIncomingNameRequests(myOwnerId, (requestId, data) => {
            if (pendingIncomingRequestId) return;
            pendingIncomingRequestId = requestId;
            document.getElementById('nameRequesterDisplay').textContent = 'Someone';
            document.getElementById('nameRequestedDisplay').textContent = data.desiredName;
            document.getElementById('nameRequestModal').classList.add('active');
        });
    }

    function respondToNameRequest(approved) {
        document.getElementById('nameRequestModal').classList.remove('active');
        if (pendingIncomingRequestId) {
            window.firebaseChat.respondToNameRequest(pendingIncomingRequestId, approved);
            pendingIncomingRequestId = null;
        }
    }

    function openChat() {
        if (!username) {
            let desiredName = prompt('Enter your username:');
            if (!desiredName) desiredName = 'Anonymous' + Math.floor(Math.random() * 1000);
            if (window.firebaseChat && window.firebaseChat.isInitialized()) {
                resolveUsername(desiredName).then(resolvedName => {
                    username = resolvedName;
                    localStorage.setItem('desritory-username', username);
                    if (nameKeepAliveInterval) clearInterval(nameKeepAliveInterval);
                    nameKeepAliveInterval = setInterval(() => {
                        if (window.firebaseChat && window.firebaseChat.isInitialized() && username) window.firebaseChat.keepNameAlive(username, myOwnerId);
                    }, 60000);
                    listenForNameRequests();
                    openChatWindow();
                }).catch(() => {
                    username = desiredName;
                    localStorage.setItem('desritory-username', username);
                    openChatWindow();
                });
            } else {
                username = desiredName;
                localStorage.setItem('desritory-username', username);
                openChatWindow();
            }
            return;
        }
        openChatWindow();
    }

    function openChatWindow() {
        isChatOpen = true;
        openWindow('chatWindow');
        unreadMessageCount = 0;
        lastReadTimestamp = Date.now();
        updateNotificationBadge();
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            if (!chatListenersAttached) {
                chatListenersAttached = true;
                window.firebaseChat.listenToMessages((message) => {
                    bufferedMessages.push(message);
                    if (isChatOpen) flushBufferedMessages();
                });
                window.firebaseChat.listenToTyping(handleTypingUpdate);
            } else {
                flushBufferedMessages();
            }
        }
        setTimeout(() => {
            const msgs = document.getElementById('chatMessages');
            msgs.scrollTop = msgs.scrollHeight;
        }, 100);
    }

    function flushBufferedMessages() {
        const toFlush = bufferedMessages.slice();
        bufferedMessages = [];
        for (const msg of toFlush) displayMessage(msg);
    }

    function closeChat() {
        isChatOpen = false;
        closeWindow('chatWindow');
        cancelReply(); removeImage();
        lastReadTimestamp = Date.now();
        if (window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.setTyping(username, false);
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageBase64 = e.target.result;
                const preview = document.getElementById('imagePreview');
                preview.src = selectedImageBase64;
                preview.classList.add('active');
                document.querySelector('.remove-image').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeImage() {
        selectedImageBase64 = null;
        const preview = document.getElementById('imagePreview');
        preview.classList.remove('active'); preview.src = '';
        const rmBtn = document.querySelector('.remove-image');
        if (rmBtn) rmBtn.style.display = 'none';
        document.getElementById('imageInput').value = '';
    }

    function replyToMessage(messageId, msgUsername) {
        replyingToMessage = { id: messageId, username: msgUsername };
        document.getElementById('replyingToBar').classList.add('active');
        document.getElementById('replyingToUser').textContent = msgUsername;
        document.getElementById('chatInput').focus();
    }

    function cancelReply() {
        replyingToMessage = null;
        document.getElementById('replyingToBar').classList.remove('active');
    }

    function handleTyping() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return;
        const input = document.getElementById('chatInput');
        if (typingTimeout) clearTimeout(typingTimeout);
        if (input.value.trim().length > 0) {
            window.firebaseChat.setTyping(username, true);
            typingTimeout = setTimeout(() => window.firebaseChat.setTyping(username, false), 3000);
        } else {
            window.firebaseChat.setTyping(username, false);
        }
    }

    function handleTypingUpdate(typingUsername, isTyping) {
        if (typingUsername === username) return;
        if (isTyping) currentlyTypingUsers.add(typingUsername);
        else currentlyTypingUsers.delete(typingUsername);
        const indicator = document.getElementById('typingIndicator');
        const usersEl = document.getElementById('typingUsers');
        if (currentlyTypingUsers.size === 0) { indicator.classList.remove('active'); return; }
        indicator.classList.add('active');
        const users = Array.from(currentlyTypingUsers);
        if (users.length === 1) usersEl.textContent = `${users[0]} is typing`;
        else if (users.length === 2) usersEl.textContent = `${users[0]} and ${users[1]} are typing`;
        else usersEl.textContent = `${users[0]}, ${users[1]}, and ${users.length - 2} more are typing`;
    }

    function containsSlur(text) { return SLUR_PATTERNS.some(p => p.test(text)); }

    function applyEmojiShortcuts(text) {
        let result = text;
        for (const [s, e] of Object.entries(EMOJI_SHORTCUTS)) {
            result = result.replace(new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), e);
        }
        return result;
    }

    function checkForSpam(message) {
        const now = Date.now();
        const trimmed = message.trim().toLowerCase();
        messageHistory.push({ text: trimmed, timestamp: now });
        messageHistory = messageHistory.filter(m => now - m.timestamp < 3000);
        if (messageHistory.filter(m => m.text === trimmed).length >= 5) { showSpamWarning(); return true; }
        return false;
    }

    function showSpamWarning() {
        const el = document.getElementById('spamWarning');
        const textEl = document.getElementById('spamWarningText');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.querySelector('.chat-send-btn');
        if (chatInput) chatInput.disabled = true;
        if (sendBtn) sendBtn.disabled = true;
        spamWarningCount++;
        textEl.textContent = spamWarningCount === 1 ? "Can you please not spam?" : spamWarningCount === 2 ? "you're very annoying" : "what is wrong with you";
        el.classList.add('active');
        if (spamWarningTimeout) clearTimeout(spamWarningTimeout);
        spamWarningTimeout = setTimeout(() => {
            el.classList.remove('active');
            if (chatInput) chatInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
        }, 5000);
    }

    function showSlurWarning() {
        const el = document.getElementById('slurWarning');
        const timerEl = document.getElementById('slurTimer');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.querySelector('.chat-send-btn');
        if (chatInput) { chatInput.value = ''; chatInput.disabled = true; }
        if (sendBtn) sendBtn.disabled = true;
        let seconds = 10;
        timerEl.textContent = seconds;
        el.classList.add('active');
        if (slurTimerInterval) clearInterval(slurTimerInterval);
        if (slurTimeoutId) clearTimeout(slurTimeoutId);
        slurTimerInterval = setInterval(() => { seconds--; timerEl.textContent = seconds; if (seconds <= 0) clearInterval(slurTimerInterval); }, 1000);
        slurTimeoutId = setTimeout(() => {
            el.classList.remove('active');
            if (chatInput) chatInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
        }, 10000);
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        let message = input.value.trim();
        if (!message && !selectedImageBase64) return;
        if (message && containsSlur(message)) { showSlurWarning(); return; }
        if (message) message = applyEmojiShortcuts(message);
        if (message && checkForSpam(message)) return;
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            const replyTo = replyingToMessage ? { id: replyingToMessage.id, username: replyingToMessage.username, text: messagesCache[replyingToMessage.id]?.text || '' } : null;
            window.firebaseChat.setTyping(username, false);
            if (typingTimeout) clearTimeout(typingTimeout);
            window.firebaseChat.sendMessage(username, message, selectedImageBase64, replyTo)
                .then(() => { input.value = ''; cancelReply(); removeImage(); })
                .catch(() => alert('Failed to send message.'));
        } else {
            alert('Chat not connected.');
        }
    }

    function displayMessage(message) {
        if (messageIds.has(message.id)) return;
        messageIds.add(message.id);
        messagesCache[message.id] = message;
        if (!isChatOpen && message.username !== username && message.timestamp > lastReadTimestamp) {
            unreadMessageCount++;
            updateNotificationBadge();
            return;
        }
        if (!isChatOpen) return;
        const msgs = document.getElementById('chatMessages');
        const shouldScroll = msgs.scrollHeight - msgs.scrollTop - msgs.clientHeight < 100;
        const div = document.createElement('div');
        div.className = 'chat-msg';
        let replyHTML = '';
        if (message.replyTo) replyHTML = `<div class="chat-reply-indicator"><strong>@${escapeHtml(message.replyTo.username)}</strong>: ${escapeHtml((message.replyTo.text || '').substring(0, 50))}</div>`;
        let imgHTML = '';
        if (message.imageUrl) imgHTML = `<img src="${message.imageUrl}" class="chat-msg-image" onclick="window.open('${message.imageUrl}','_blank')">`;
        div.innerHTML = `
            <div class="chat-msg-actions"><button class="chat-action-btn" onclick="replyToMessage('${message.id}','${escapeHtml(message.username)}')"><i class="fas fa-reply"></i> Reply</button></div>
            ${replyHTML}
            <div class="chat-msg-username">${escapeHtml(message.username)}</div>
            <div class="chat-msg-text">${escapeHtml(message.text || '')}</div>
            ${imgHTML}
            <div class="chat-msg-time">${formatTimestamp(message.timestamp)}</div>
        `;
        msgs.appendChild(div);
        while (msgs.children.length > 100) msgs.removeChild(msgs.firstChild);
        if (shouldScroll) msgs.scrollTop = msgs.scrollHeight;
    }

    function handleChatKeyPress(e) { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } }
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text || ''; return d.innerHTML; }
    function formatTimestamp(ts) { if (!ts) return ''; try { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } catch { return ''; } }

    function toggleCloak() {
        const t = document.getElementById('cloakToggle');
        t.classList.toggle('active');
        const enabled = t.classList.contains('active');
        localStorage.setItem('desritory-cloak', enabled);
        if (enabled) {
            document.title = 'Google';
            const fav = document.querySelector("link[rel*='icon']") || document.createElement('link');
            fav.type = 'image/x-icon'; fav.rel = 'shortcut icon'; fav.href = 'https://www.google.com/favicon.ico';
            document.getElementsByTagName('head')[0].appendChild(fav);
        } else { document.title = 'Desritory V2'; }
    }

    function togglePanic() {
        const t = document.getElementById('panicToggle');
        t.classList.toggle('active');
        localStorage.setItem('desritory-panic', t.classList.contains('active'));
    }

    function toggleParticles() {
        const t = document.getElementById('particlesToggle');
        t.classList.toggle('active');
        const enabled = t.classList.contains('active');
        localStorage.setItem('desritory-particles', enabled);
        document.getElementById('particleCanvas').style.display = enabled ? 'block' : 'none';
    }

    function createParticles() {
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

        const particles = [];
        const mouse = { x: null, y: null };
        window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 1.8 + 0.5;
                this.speedX = (Math.random() - 0.5) * 0.4;
                this.speedY = (Math.random() - 0.5) * 0.4;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
                if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (let i = 0; i < 80; i++) particles.push(new Particle());

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const c1 = getComputedStyle(document.documentElement).getPropertyValue('--particle-color-1').trim();
            const c2 = getComputedStyle(document.documentElement).getPropertyValue('--particle-color-2').trim();
            const nearMouse = new Set();

            for (let a = 0; a < particles.length; a++) {
                particles[a].update(); particles[a].draw();
                if (mouse.x !== null) {
                    const dx = particles[a].x - mouse.x;
                    const dy = particles[a].y - mouse.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        nearMouse.add(a);
                        const op = 1 - dist / 150;
                        ctx.strokeStyle = c2.replace('0.6', String(op * 0.7));
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(mouse.x, mouse.y);
                        ctx.stroke();
                    }
                }
            }

            for (let a = 0; a < particles.length; a++) {
                for (let b = a + 1; b < particles.length; b++) {
                    if (nearMouse.has(a) && nearMouse.has(b)) {
                        const dx = particles[a].x - particles[b].x;
                        const dy = particles[a].y - particles[b].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 120) {
                            ctx.strokeStyle = c1.replace('0.8', String((1 - dist / 120) * 0.4));
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(particles[a].x, particles[a].y);
                            ctx.lineTo(particles[b].x, particles[b].y);
                            ctx.stroke();
                        }
                    }
                }
            }
            requestAnimationFrame(animate);
        }
        animate();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeFullscreen();
            document.getElementById('systemTray').classList.remove('visible');
        }
        if (e.key === "'" && localStorage.getItem('desritory-panic') === 'true') window.location.href = 'https://google.com';
    });

    createParticles();
    renderGames();
    renderApps();
    initProxy();

    if (Math.random() < 1 / 10000) {
        document.getElementById('desktopLogo').style.transform = 'rotate(180deg)';
        document.getElementById('desktopLogo').style.transition = 'transform 1s ease';
    }

    const CURRENT_VERSION = '3.0.0';
    const savedVersion = localStorage.getItem('desritory-version');
    if (savedVersion !== CURRENT_VERSION) {
        const su = localStorage.getItem('desritory-username');
        const so = localStorage.getItem('desritory-ownerid');
        localStorage.clear();
        if (su) localStorage.setItem('desritory-username', su);
        if (so) localStorage.setItem('desritory-ownerid', so);
        localStorage.setItem('desritory-version', CURRENT_VERSION);
    }

    const savedTheme = localStorage.getItem('desritory-theme') || 'blackwhite';
    changeTheme(savedTheme);

    if (localStorage.getItem('desritory-stealth') === 'true') applyStealthMode(true);
    if (localStorage.getItem('desritory-cloak') === 'true') { document.getElementById('cloakToggle').classList.add('active'); toggleCloak(); }
    if (localStorage.getItem('desritory-panic') === 'true') document.getElementById('panicToggle').classList.add('active');
    if (localStorage.getItem('desritory-particles') === 'false') { document.getElementById('particlesToggle').classList.remove('active'); document.getElementById('particleCanvas').style.display = 'none'; }

    if (username && window.firebaseChat && window.firebaseChat.isInitialized()) {
        listenForNameRequests();
        nameKeepAliveInterval = setInterval(() => { if (window.firebaseChat && username) window.firebaseChat.keepNameAlive(username, myOwnerId); }, 60000);
    }

    window.addEventListener('beforeunload', () => {
        if (username && window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.releaseName(username);
    });

    document.addEventListener('visibilitychange', () => {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        if (document.visibilityState === 'hidden') window.firebaseChat.releaseName(username);
        if (document.visibilityState === 'visible') window.firebaseChat.claimName(username, myOwnerId);
    });
</script>
</body>
</html>
