<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desritory V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #7c4dff;
            --primary-dim: rgba(124,77,255,0.15);
            --primary-glow: rgba(124,77,255,0.3);
            --bg: #0d0d10;
            --bg2: #111116;
            --bg3: #16161d;
            --surface: rgba(255,255,255,0.04);
            --surface-hover: rgba(255,255,255,0.07);
            --border: rgba(255,255,255,0.07);
            --border-hover: rgba(255,255,255,0.14);
            --text: rgba(255,255,255,0.9);
            --text-dim: rgba(255,255,255,0.45);
            --text-faint: rgba(255,255,255,0.22);
            --sidebar-w: 72px;
            --statusbar-h: 36px;
            --font-size-base: 13px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            font-size: var(--font-size-base);
        }

        
        #layout {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: 1fr var(--statusbar-h);
            height: 100vh;
        }

        
        #sidebar {
            grid-row: 1 / 3;
            background: var(--bg2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 0;
            gap: 2px;
            z-index: 100;
            transition: width 0.25s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
        }

        .sidebar-logo {
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            margin-bottom: 10px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .sidebar-logo:hover { transform: scale(1.1); }

        .sidebar-divider {
            width: 32px; height: 1px;
            background: var(--border);
            margin: 6px 0;
            flex-shrink: 0;
        }

        .nav-item {
            width: 52px; height: 52px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 4px;
            cursor: pointer;
            border-radius: 10px;
            border: 1px solid transparent;
            transition: all 0.18s;
            position: relative;
            color: var(--text-dim);
            flex-shrink: 0;
        }
        .nav-item:hover { background: var(--surface-hover); border-color: var(--border-hover); color: var(--text); }
        .nav-item.active { background: var(--primary-dim); border-color: rgba(124,77,255,0.3); color: var(--primary); }
        .nav-item i { font-size: 17px; line-height: 1; }
        .nav-item span { font-size: 9px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; line-height: 1; }

        .nav-item::after {
            content: attr(data-tip);
            position: absolute;
            left: calc(100% + 10px);
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            color: var(--text);
            font-size: 11px; font-weight: 500;
            padding: 5px 10px;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transform: translateX(-4px);
            transition: all 0.15s;
            z-index: 9999;
        }
        .nav-item:hover::after { opacity: 1; transform: translateX(0); }

        .nav-badge {
            position: absolute;
            top: 6px; right: 6px;
            min-width: 16px; height: 16px;
            background: #ef4444;
            border-radius: 8px;
            font-size: 9px; font-weight: 700;
            display: none; align-items: center; justify-content: center;
            padding: 0 4px; color: white;
            border: 1.5px solid var(--bg2);
        }
        .nav-badge.show { display: flex; }
        .sidebar-spacer { flex: 1; }

        
        #main {
            grid-column: 2; grid-row: 1;
            position: relative; overflow: hidden;
            background: var(--bg);
        }

        
        #statusbar {
            grid-column: 2; grid-row: 2;
            background: var(--bg2);
            border-top: 1px solid var(--border);
            display: flex; align-items: center;
            padding: 0 16px; gap: 16px;
            font-size: 12px; color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }
        .status-item { display: flex; align-items: center; gap: 6px; }
        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
            animation: blink 2s ease-in-out infinite;
        }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.4} }
        .status-sep { color: var(--text-faint); }
        .status-spacer { flex: 1; }
        .status-time { font-weight: 600; color: var(--text); }

        
        #homeScreen {
            display: flex; flex-direction: row;
            align-items: center; justify-content: center;
            height: 100%; gap: 0;
            background: transparent; position: relative;
        }
        .home-center { display: flex; flex-direction: column; align-items: center; gap: 8px; }

        .home-logo-wrap {
            position: relative;
            width: 110px; height: 110px;
            margin-bottom: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .home-logo-ring {
            position: absolute; inset: 0;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--primary);
            border-right-color: var(--primary-glow);
            animation: logoSpin 3s linear infinite;
        }
        .home-logo-ring2 {
            position: absolute; inset: 10px;
            border-radius: 50%;
            border: 1.5px solid transparent;
            border-bottom-color: var(--primary);
            border-left-color: var(--primary-glow);
            animation: logoSpin 2s linear infinite reverse;
        }
        .home-logo-glow {
            position: absolute; inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            animation: logoPulse 2.5s ease-in-out infinite;
        }
        .home-logo-icon {
            font-size: 38px;
            position: relative; z-index: 2;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 12px var(--primary));
        }
        @keyframes logoSpin { to { transform: rotate(360deg); } }
        @keyframes logoPulse { 0%,100%{opacity:0.4;transform:scale(0.95)} 50%{opacity:1;transform:scale(1.05)} }
        @keyframes logoFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

        .home-wordmark {
            font-size: clamp(36px, 5vw, 64px);
            font-weight: 700; letter-spacing: -1px;
            color: var(--text); margin-bottom: 4px;
            animation: wordmarkIn 0.8s cubic-bezier(0.34,1.56,0.64,1) both;
        }
        @keyframes wordmarkIn { from{opacity:0;transform:translateY(16px) scale(0.95)} to{opacity:1;transform:none} }
        .home-wordmark span { color: var(--primary); }
        .home-sub {
            font-size: 13px; color: var(--text-faint);
            letter-spacing: 3px; text-transform: uppercase;
            margin-bottom: 40px;
            animation: wordmarkIn 0.8s 0.1s cubic-bezier(0.34,1.56,0.64,1) both;
        }
        .home-cards { display: flex; gap: 10px; animation: wordmarkIn 0.8s 0.2s cubic-bezier(0.34,1.56,0.64,1) both; }
        .home-card {
            width: 100px; height: 90px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 8px; cursor: pointer;
            transition: all 0.18s;
            color: var(--text-dim);
        }
        .home-card:hover {
            background: var(--surface-hover);
            border-color: var(--border-hover);
            color: var(--text);
            transform: translateY(-2px);
        }
        .home-card i { font-size: 22px; }
        .home-card span { font-size: 11px; font-weight: 600; }

        
        .panel { display: none; flex-direction: column; height: 100%; animation: panelIn 0.2s ease; }
        .panel.active { display: flex; }
        @keyframes panelIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

        .panel-header {
            height: 52px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center;
            padding: 0 20px; gap: 12px;
            flex-shrink: 0;
            background: var(--bg);
        }
        .panel-title { font-size: 15px; font-weight: 600; color: var(--text); }
        .panel-search {
            flex: 1; max-width: 300px;
            padding: 7px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text); font-size: 13px;
            font-family: 'Outfit', sans-serif;
            outline: none; transition: all 0.18s;
            margin-left: auto;
        }
        .panel-search:focus { border-color: var(--primary); background: var(--primary-dim); }
        .panel-search::placeholder { color: var(--text-faint); }
        .panel-body { flex: 1; overflow-y: auto; padding: 16px; background: transparent; }

        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 14px;
        }
        .game-card {
            display: flex; flex-direction: column;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.22s cubic-bezier(0.34, 1.3, 0.64, 1);
            overflow: hidden; position: relative;
        }
        .game-card::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, var(--primary), transparent 60%);
            opacity: 0; transition: opacity 0.22s;
            z-index: 0; pointer-events: none;
        }
        .game-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0,0,0,0.5), 0 0 0 1px var(--primary);
        }
        .game-card:hover::before { opacity: 0.07; }
        .game-card-thumb { width: 100%; height: 120px; object-fit: cover; display: block; background: var(--bg3); }
        .game-card-info { padding: 10px 12px 12px; position: relative; z-index: 1; }
        .game-card-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .game-card-cat { font-size: 11px; color: var(--text-faint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        
        .proxy-home {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 18px; height: 100%;
        }
        .proxy-search-row { display: flex; gap: 8px; width: 100%; max-width: 500px; }
        .proxy-input {
            flex: 1; padding: 11px 15px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text); font-size: 14px;
            font-family: 'Outfit', sans-serif;
            outline: none; transition: all 0.18s;
        }
        .proxy-input:focus { border-color: var(--primary); background: var(--primary-dim); }
        .proxy-input::placeholder { color: var(--text-faint); }
        .proxy-go {
            padding: 11px 22px;
            background: var(--primary);
            border: none; border-radius: 8px;
            color: white; font-size: 14px; font-weight: 600;
            cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }
        .proxy-go:hover { opacity: 0.82; }
        .proxy-quick {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; width: 100%; max-width: 500px;
        }
        .proxy-quick-link {
            padding: 11px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 9px; cursor: pointer;
            display: flex; flex-direction: column;
            align-items: center; gap: 5px;
            transition: all 0.18s;
        }
        .proxy-quick-link:hover { background: var(--surface-hover); border-color: var(--border-hover); transform: translateY(-1px); }
        .proxy-quick-link span:first-child { font-size: 20px; }
        .proxy-quick-link span:last-child { font-size: 11px; color: var(--text-dim); font-weight: 500; }
        .proxy-iframe { width: 100%; height: 100%; border: none; display: none; }

        
        .chat-body { display: flex; flex-direction: column; height: 100%; }
        .chat-setup-screen {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 16px; height: 100%; padding: 40px 24px;
        }
        .chat-setup-title { font-size: 20px; font-weight: 700; }
        .chat-setup-sub { font-size: 12px; color: var(--text-faint); margin-top: -8px; }
        .setup-input {
            width: 100%; max-width: 280px;
            padding: 11px 15px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text); font-size: 14px;
            font-family: 'Outfit', sans-serif;
            outline: none; text-align: center;
            transition: all 0.18s;
        }
        .setup-input:focus { border-color: var(--primary); }
        .setup-input::placeholder { color: var(--text-faint); }
        .setup-btn {
            padding: 11px 36px;
            background: var(--primary);
            border: none; border-radius: 8px;
            color: white; font-size: 14px; font-weight: 600;
            cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }
        .setup-btn:hover { opacity: 0.82; }
        .chat-status {
            padding: 7px 16px;
            font-size: 11px; color: var(--text-faint);
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
        }
        .chat-status.connected { color: #22c55e; }
        .chat-status.error { color: #ef4444; }

        .chat-main-area { display: flex; flex: 1; overflow: hidden; }

        
        #chatUserList {
            width: 160px;
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }
        .user-list-header {
            padding: 10px 12px;
            font-size: 10px; font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-faint);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .user-list-body { flex: 1; overflow-y: auto; padding: 8px; }
        .user-list-item {
            display: flex; align-items: center; gap: 8px;
            padding: 5px 8px; border-radius: 6px;
            font-size: 12px; color: var(--text-dim);
            transition: background 0.15s;
        }
        .user-list-item:hover { background: var(--surface-hover); color: var(--text); }
        .user-avatar {
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--primary-dim);
            border: 1px solid rgba(124,77,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }
        .user-online-dot {
            width: 6px; height: 6px;
            border-radius: 50%; background: #22c55e;
            margin-left: auto; flex-shrink: 0;
        }

        .chat-messages-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .chat-messages {
            flex: 1; overflow-y: auto;
            padding: 14px;
            display: flex; flex-direction: column; gap: 6px;
        }
        .chat-msg {
            padding: 9px 12px;
            background: var(--surface);
            border: 1px solid transparent;
            border-radius: 8px;
            animation: msgIn 0.18s ease;
            position: relative;
            transition: all 0.15s;
        }
        .chat-msg:hover { background: var(--surface-hover); border-color: var(--border); }
        .chat-msg:hover .msg-actions { opacity: 1; }
        .chat-msg:hover .msg-time { opacity: 1; }
        @keyframes msgIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

        
        .msg-reactions {
            display: flex; flex-wrap: wrap; gap: 4px;
            margin-top: 6px;
        }
        .reaction-pill {
            display: flex; align-items: center; gap: 3px;
            padding: 2px 8px;
            background: var(--surface-hover);
            border: 1px solid var(--border-hover);
            border-radius: 20px;
            font-size: 12px; cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }
        .reaction-pill:hover { background: var(--primary-dim); border-color: var(--primary); }
        .reaction-pill.mine { background: var(--primary-dim); border-color: rgba(124,77,255,0.4); }
        .reaction-pill .r-count { font-size: 10px; color: var(--text-dim); }

        .reaction-picker {
            position: absolute;
            bottom: calc(100% + 6px); right: 8px;
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            border-radius: 10px;
            padding: 8px;
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            width: 190px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        .reaction-picker.on { display: flex; }
        .r-opt {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; border-radius: 6px;
            transition: background 0.15s;
        }
        .r-opt:hover { background: var(--surface-hover); }

        .msg-actions {
            position: absolute;
            top: 6px; right: 8px;
            opacity: 0; transition: opacity 0.15s;
            display: flex; gap: 4px;
        }
        .msg-action-btn {
            background: var(--surface-hover);
            border: 1px solid var(--border-hover);
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 10px; color: var(--text);
            cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: all 0.15s;
        }
        .msg-action-btn:hover { background: var(--primary-dim); border-color: var(--primary); color: var(--primary); }

        .msg-reply-bar {
            background: var(--primary-dim);
            border-left: 2px solid var(--primary);
            padding: 4px 8px; margin-bottom: 5px;
            border-radius: 3px; font-size: 11px;
            color: var(--text-faint);
        }
        .msg-reply-bar strong { color: var(--primary); }
        .msg-username { font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 2px; }
        .msg-text { font-size: var(--font-size-base); color: var(--text); word-break: break-word; }
        .msg-image { max-width: 100%; max-height: 180px; border-radius: 6px; margin-top: 6px; cursor: pointer; }
        .msg-time {
            font-size: 10px; color: var(--text-faint);
            margin-top: 3px; opacity: 0;
            transition: opacity 0.15s;
            font-family: 'JetBrains Mono', monospace;
        }

        
        #pinnedMsg {
            display: none;
            padding: 8px 14px;
            background: var(--primary-dim);
            border-bottom: 1px solid rgba(124,77,255,0.2);
            font-size: 12px;
            color: var(--text-dim);
            flex-shrink: 0;
        }
        #pinnedMsg.on { display: flex; align-items: center; gap: 8px; }
        #pinnedMsg i { color: var(--primary); font-size: 12px; }
        #pinnedMsg strong { color: var(--primary); }
        .unpin-btn {
            margin-left: auto;
            background: none; border: none;
            color: var(--text-faint); cursor: pointer;
            font-size: 12px; transition: color 0.15s;
        }
        .unpin-btn:hover { color: var(--text); }

        
        .msg-edit-input {
            width: 100%;
            background: var(--bg3);
            border: 1px solid var(--primary);
            border-radius: 5px;
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            padding: 4px 8px;
            outline: none;
            margin-top: 4px;
        }
        .msg-edit-actions { display: flex; gap: 6px; margin-top: 4px; }
        .msg-edit-save, .msg-edit-cancel {
            padding: 3px 10px; border-radius: 5px;
            font-size: 11px; cursor: pointer;
            font-family: 'Outfit', sans-serif;
            border: 1px solid var(--border-hover);
            transition: all 0.15s;
        }
        .msg-edit-save { background: var(--primary); border-color: var(--primary); color: white; }
        .msg-edit-cancel { background: var(--surface-hover); color: var(--text-dim); }

        .typing-bar { padding: 5px 16px; font-size: 11px; color: var(--text-faint); display: none; }
        .typing-bar.on { display: block; }
        .typing-dots span {
            display: inline-block;
            width: 3px; height: 3px;
            background: var(--primary);
            border-radius: 50%; margin: 0 1px;
            animation: td 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes td { 0%,60%,100%{opacity:0.2;transform:translateY(0)} 30%{opacity:1;transform:translateY(-3px)} }

        .reply-bar {
            display: none;
            background: var(--primary-dim);
            border-left: 2px solid var(--primary);
            padding: 6px 12px; margin: 0 12px 4px;
            border-radius: 4px; font-size: 12px;
            color: var(--text-faint);
            flex-shrink: 0; position: relative;
        }
        .reply-bar.on { display: block; }
        .cancel-reply {
            position: absolute; right: 8px; top: 50%;
            transform: translateY(-50%);
            background: none; border: none;
            color: var(--text-faint); cursor: pointer;
            font-size: 14px; transition: color 0.15s;
        }
        .cancel-reply:hover { color: var(--text); }
        .img-preview-wrap { padding: 0 12px 6px; }
        .img-preview { display: none; max-width: 100px; max-height: 70px; border-radius: 6px; }
        .img-preview.on { display: block; }
        .chat-input-row {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            display: flex; gap: 8px; align-items: center;
            flex-shrink: 0;
        }
        .img-btn {
            width: 34px; height: 34px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-faint);
            font-size: 13px; transition: all 0.18s;
        }
        .img-btn:hover { background: var(--surface-hover); border-color: var(--border-hover); color: var(--text); }
        .chat-input {
            flex: 1; padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text); font-size: 13px;
            font-family: 'Outfit', sans-serif;
            outline: none; transition: border-color 0.18s;
        }
        .chat-input:focus { border-color: var(--primary); }
        .chat-input::placeholder { color: var(--text-faint); }
        .send-btn {
            padding: 8px 16px;
            background: var(--primary);
            border: none; border-radius: 7px;
            color: white; font-size: 13px; font-weight: 600;
            cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: opacity 0.18s;
        }
        .send-btn:hover { opacity: 0.82; }

        
        .settings-body { padding: 20px; }
        .s-section { margin-bottom: 24px; }
        .s-label {
            font-size: 10px; font-weight: 700;
            letter-spacing: 2px; text-transform: uppercase;
            color: var(--text-faint); margin-bottom: 10px;
        }
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 7px; }
        .theme-swatch {
            display: flex; flex-direction: column;
            align-items: center; gap: 5px;
            padding: 9px 5px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 9px; cursor: pointer;
            transition: all 0.18s;
        }
        .theme-swatch:hover { background: var(--surface-hover); border-color: var(--border-hover); transform: translateY(-1px); }
        .theme-swatch.active { border-color: var(--primary); background: var(--primary-dim); }
        .swatch-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.12); }
        .swatch-name { font-size: 9px; color: var(--text-faint); font-weight: 600; }
        .theme-swatch.active .swatch-name { color: var(--text); }
        .se-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px; }
        .se-btn {
            padding: 9px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim); font-size: 12px;
            font-family: 'Outfit', sans-serif;
            cursor: pointer; transition: all 0.18s;
            text-align: center; font-weight: 500;
        }
        .se-btn:hover { background: var(--surface-hover); color: var(--text); }
        .se-btn.active { background: var(--primary-dim); border-color: rgba(124,77,255,0.3); color: var(--primary); }

        
        .font-row {
            display: flex; gap: 7px;
        }
        .font-btn {
            flex: 1; padding: 9px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-family: 'Outfit', sans-serif;
            cursor: pointer; transition: all 0.18s;
            text-align: center; font-weight: 500;
        }
        .font-btn:hover { background: var(--surface-hover); color: var(--text); }
        .font-btn.active { background: var(--primary-dim); border-color: rgba(124,77,255,0.3); color: var(--primary); }

        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 11px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 6px;
            cursor: pointer; transition: background 0.18s;
        }
        .toggle-row:hover { background: var(--surface-hover); }
        .toggle-row-label { font-size: 13px; color: var(--text); }
        .toggle {
            width: 40px; height: 22px;
            background: rgba(255,255,255,0.12);
            border-radius: 11px; position: relative;
            transition: background 0.25s; flex-shrink: 0;
        }
        .toggle.on { background: var(--primary); }
        .toggle-knob {
            position: absolute; top: 3px; left: 3px;
            width: 16px; height: 16px;
            background: white; border-radius: 50%;
            transition: transform 0.25s;
        }
        .toggle.on .toggle-knob { transform: translateX(18px); }

        
        .panic-url-row {
            display: none;
            padding: 10px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 6px;
            gap: 10px; align-items: center;
        }

        
        .update-body { padding: 24px; }
        .update-ver { font-size: 38px; font-weight: 700; color: var(--primary); margin-bottom: 4px; font-family: 'JetBrains Mono', monospace; }
        .update-sub { font-size: 13px; color: var(--text-faint); margin-bottom: 18px; }
        .update-notes { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; font-size: 13px; color: var(--text-dim); line-height: 1.9; }

        
        #fullscreenOverlay {
            position: fixed;
            top: 0; left: var(--sidebar-w); right: 0; bottom: var(--statusbar-h);
            background: var(--bg); z-index: 9000;
            display: none; flex-direction: column;
        }
        #fullscreenOverlay.active { display: flex; }
        .fs-bar {
            height: 44px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center;
            padding: 0 16px; gap: 12px; flex-shrink: 0;
            background: var(--bg2);
        }
        .fs-back {
            padding: 6px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-dim);
            cursor: pointer; font-size: 12px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.18s;
        }
        .fs-back:hover { background: var(--surface-hover); color: var(--text); }
        .fs-title { font-size: 13px; font-weight: 600; color: var(--text-dim); }
        #fullscreenIframe { width: 100%; flex: 1; border: none; }

        
        #loadingScreen {
            display: none; position: fixed; inset: 0;
            background: rgba(13,13,16,0.95); z-index: 10000;
            align-items: center; justify-content: center;
            flex-direction: column; gap: 16px;
        }
        #loadingScreen.on { display: flex; }
        .loader-ring {
            width: 44px; height: 44px;
            border: 2px solid var(--surface-hover);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: var(--text-dim); font-weight: 500; }

        
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(6px);
            z-index: 12000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.on { display: flex; }
        .modal-box {
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            border-radius: 14px; padding: 28px;
            max-width: 380px; width: 90%;
            text-align: center;
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .modal-text { font-size: 13px; color: var(--text-dim); margin-bottom: 22px; line-height: 1.6; }
        .modal-text strong { color: var(--primary); }
        .modal-btns { display: flex; gap: 8px; justify-content: center; }
        .modal-btn {
            padding: 9px 24px; border-radius: 8px;
            border: none; font-size: 13px; font-weight: 600;
            cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: all 0.18s;
        }
        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.primary:hover { opacity: 0.82; }
        .modal-btn.secondary { background: var(--surface-hover); color: var(--text-dim); border: 1px solid var(--border); }
        .modal-btn.secondary:hover { border-color: #ef4444; color: #ef4444; }
        .spinner {
            width: 40px; height: 40px;
            border: 2px solid var(--surface-hover);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin: 0 auto 16px;
        }

        
        .floating-warn {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.92);
            border-radius: 12px; padding: 22px 30px;
            z-index: 14000; opacity: 0; pointer-events: none;
            transition: all 0.25s; text-align: center;
        }
        .floating-warn.on { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all; }
        #spamWarn { background: rgba(239,68,68,0.97); border: 1.5px solid #dc2626; }
        #spamWarnText { font-size: 16px; font-weight: 700; color: white; }
        #slurWarn { background: var(--bg3); border: 1.5px solid var(--primary); box-shadow: 0 0 40px var(--primary-glow); }
        #slurWarn .sw-icon { font-size: 32px; margin-bottom: 10px; }
        #slurWarn .sw-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        #slurWarn .sw-text { font-size: 13px; color: var(--text-dim); margin-bottom: 10px; }
        #slurWarn .sw-timer { font-size: 28px; font-weight: 900; color: var(--primary); font-family: 'JetBrains Mono', monospace; }

        
        #shortcutsHint {
            position: fixed;
            bottom: calc(var(--statusbar-h) + 12px);
            right: 16px;
            background: var(--bg3);
            border: 1px solid var(--border-hover);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 11px;
            color: var(--text-dim);
            z-index: 8000;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s;
            pointer-events: none;
            font-family: 'JetBrains Mono', monospace;
        }
        #shortcutsHint.on { opacity: 1; transform: translateY(0); pointer-events: all; }
        .shortcut-row { display: flex; gap: 16px; margin-bottom: 4px; }
        .shortcut-row:last-child { margin-bottom: 0; }
        .shortcut-key {
            background: var(--surface-hover);
            border: 1px solid var(--border-hover);
            border-radius: 4px; padding: 1px 6px;
            font-size: 10px; color: var(--text);
        }

        
        #bgCanvas {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            pointer-events: none; z-index: 0; display: block;
        }
        #layout { position: relative; z-index: 1; background: transparent; }
        #sidebar { background: rgba(17,17,22,0.88) !important; backdrop-filter: blur(14px); }
        #main { background: transparent !important; }
        #statusbar { background: rgba(17,17,22,0.88) !important; backdrop-filter: blur(14px); }
        .panel-header { background: rgba(13,13,16,0.6) !important; backdrop-filter: blur(8px); }
        .panel { background: transparent; }

        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 2px; }

        .nav-item.stealth-on { background: rgba(124,77,255,0.1); border-color: rgba(124,77,255,0.2); color: var(--primary); }

        
        @media (max-width: 600px) {
            :root { --sidebar-w: 0px; --statusbar-h: 0px; }
            #sidebar { display: none; }
            #layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr;
            }
            #main { grid-column: 1; grid-row: 1; }
            #statusbar { display: none; }
            #mobileNav {
                display: flex !important;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                background: rgba(17,17,22,0.97);
                backdrop-filter: blur(14px);
                border-top: 1px solid var(--border);
                z-index: 200;
                padding: 6px 0 calc(6px + env(safe-area-inset-bottom));
                justify-content: space-around;
            }
            .mnav-item {
                display: flex; flex-direction: column;
                align-items: center; gap: 3px;
                cursor: pointer; padding: 6px 12px;
                border-radius: 8px;
                color: var(--text-dim);
                font-size: 9px; font-weight: 600;
                text-transform: uppercase;
                transition: all 0.18s;
                -webkit-tap-highlight-color: transparent;
            }
            .mnav-item.active { color: var(--primary); }
            .mnav-item i { font-size: 18px; }
            #chatUserList { display: none !important; }
            .panel-header { padding: 0 14px; }
            .panel-body { padding: 10px; }
            .proxy-home { padding: 0 12px; }
            .proxy-quick { grid-template-columns: repeat(3,1fr); gap:6px; }
            .home-wordmark { font-size: clamp(28px,8vw,48px); }
            .home-cards { flex-wrap: wrap; justify-content: center; gap: 8px; }
            .home-card { width: 90px; height: 80px; }
            .games-grid { grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:10px; }
            body { padding-bottom: calc(58px + env(safe-area-inset-bottom)); overflow: hidden; }
            .chat-input-row { padding: 8px; gap: 6px; }
            .settings-body { padding: 14px; }
        }

        #mobileNav { display: none; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div id="mobileNav">
    <div class="mnav-item active" onclick="showPanel('home')"><i class="fas fa-house"></i><span>Home</span></div>
    <div class="mnav-item" onclick="showPanel('proxy')"><i class="fas fa-shield-halved"></i><span>Proxy</span></div>
    <div class="mnav-item" onclick="showPanel('games')"><i class="fas fa-gamepad"></i><span>Games</span></div>
    <div class="mnav-item" onclick="showPanel('chat')"><i class="fas fa-comments"></i><span>Chat</span></div>
    <div class="mnav-item" onclick="showPanel('settings')"><i class="fas fa-gear"></i><span>Settings</span></div>
</div>

<div id="layout">
    <nav id="sidebar">
        <div class="sidebar-logo" onclick="showPanel('home')" title="Desritory">üõ°</div>
        <div class="nav-item active" id="nav-home" onclick="showPanel('home')" data-tip="Home"><i class="fas fa-house"></i><span>Home</span></div>
        <div class="nav-item" id="nav-proxy" onclick="showPanel('proxy')" data-tip="Proxy"><i class="fas fa-shield-halved"></i><span>Proxy</span></div>
        <div class="nav-item" id="nav-games" onclick="showPanel('games')" data-tip="Games"><i class="fas fa-gamepad"></i><span>Games</span></div>
        <div class="nav-item" id="nav-apps" onclick="showPanel('apps')" data-tip="Apps"><i class="fas fa-grid-2"></i><span>Apps</span></div>
        <div class="sidebar-divider"></div>
        <div class="nav-item" id="nav-chat" onclick="showPanel('chat')" data-tip="Chat">
            <i class="fas fa-comments"></i><span>Chat</span>
            <div class="nav-badge" id="chatBadge">0</div>
        </div>
        <div class="sidebar-spacer"></div>
        <div class="nav-item" id="nav-stealth" onclick="toggleStealth()" data-tip="Stealth Mode"><i class="fas fa-user-secret"></i><span>Stealth</span></div>
        <div class="nav-item" id="nav-updates" onclick="showPanel('updates')" data-tip="Updates"><i class="fas fa-bell"></i><span>Updates</span></div>
        <div class="nav-item" id="nav-settings" onclick="showPanel('settings')" data-tip="Settings"><i class="fas fa-gear"></i><span>Settings</span></div>
    </nav>

    <main id="main">

        
        <div class="panel active" id="panel-home">
            <div id="homeScreen">
                <div class="home-center">
                    <div class="home-logo-wrap">
                        <div class="home-logo-glow"></div>
                        <div class="home-logo-ring"></div>
                        <div class="home-logo-ring2"></div>
                        <div class="home-logo-icon">üõ°</div>
                    </div>
                    <div class="home-wordmark">DESRIT<span>O</span>RY <span style="font-size:0.45em;font-weight:600;color:var(--text-faint);letter-spacing:1px;vertical-align:middle;border:1.5px solid var(--border-hover);border-radius:6px;padding:2px 8px;position:relative;top:-4px;">V4</span></div>
                    <div class="home-sub" id="homeSub">Welcome back</div>
                    <div class="home-cards">
                        <div class="home-card" onclick="showPanel('proxy')"><i class="fas fa-shield-halved"></i><span>Proxy</span></div>
                        <div class="home-card" onclick="showPanel('games')"><i class="fas fa-gamepad"></i><span>Games</span></div>
                        <div class="home-card" onclick="showPanel('chat')"><i class="fas fa-comments"></i><span>Chat</span></div>
                        <div class="home-card" onclick="showPanel('settings')"><i class="fas fa-gear"></i><span>Settings</span></div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="panel" id="panel-proxy">
            <div class="panel-header">
                <div class="panel-title">Proxy</div>
                <span style="font-size:11px;color:var(--text-faint);margin-left:auto;font-family:'JetBrains Mono',monospace;">Powered by Scramjet</span>
            </div>
            <div id="proxyHome" style="flex:1;overflow:hidden;">
                <div class="proxy-home">
                    <div style="font-size:13px;color:var(--text-faint);">Browse freely. No restrictions.</div>
                    <div class="proxy-search-row">
                        <input id="proxyInput" class="proxy-input" type="text" placeholder="Search or enter a URL...">
                        <button class="proxy-go" onclick="launchProxy()">Go</button>
                    </div>
                    <div class="proxy-quick">
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://google.com')"><span>üîç</span><span>Google</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://youtube.com')"><span>‚ñ∂Ô∏è</span><span>YouTube</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://discord.com')"><span>üí¨</span><span>Discord</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://github.com')"><span>ü§ñ</span><span>Github</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://spotify.com')"><span>üéµ</span><span>Spotify</span></div>
                        <div class="proxy-quick-link" onclick="launchProxyUrl('https://twitter.com')"><span>üê¶</span><span>Twitter/X</span></div>
                    </div>
                </div>
            </div>
            <iframe id="proxyIframe" class="proxy-iframe"></iframe>
        </div>

        
        <div class="panel" id="panel-games">
            <div class="panel-header">
                <div class="panel-title">Games</div>
                <div style="display:flex;gap:8px;align-items:center;margin-left:auto;">
                    <select id="gameSortSelect" onchange="renderGames(document.getElementById('gamesSearch').value)" style="padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:7px;color:var(--text-dim);font-size:11px;font-family:'Outfit',sans-serif;outline:none;cursor:pointer;">
                        <option value="default">Default</option>
                        <option value="alpha">A ‚Üí Z</option>
                        <option value="recent">Recently Played</option>
                        <option value="category">By Category</option>
                    </select>
                    <input class="panel-search" placeholder="Search games..." oninput="renderGames(this.value)" id="gamesSearch" style="margin-left:0;">
                </div>
            </div>
            <div class="panel-body">
                <div class="games-grid" id="gamesList"></div>
            </div>
        </div>

        
        <div class="panel" id="panel-apps">
            <div class="panel-header">
                <div class="panel-title">Apps</div>
                <input class="panel-search" placeholder="Search apps..." oninput="renderApps(this.value)">
            </div>
            <div class="panel-body">
                <div class="games-grid" id="appsList"></div>
            </div>
        </div>

        
        <div class="panel" id="panel-chat">
            <div class="panel-header">
                <div class="panel-title">Chat Room</div>
                <div id="chatUserLabel" style="margin-left:auto;font-size:11px;color:var(--text-faint);font-family:'JetBrains Mono',monospace;"></div>
            </div>
            <div class="window-content" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
                <div class="chat-setup-screen" id="chatSetup" style="display:none;">
                    <div style="font-size:40px;">üí¨</div>
                    <div class="chat-setup-title">Join the Chat</div>
                    <div class="chat-setup-sub">Pick a username to get started</div>
                    <input type="text" id="chatSetupInput" class="setup-input" placeholder="Your username..." maxlength="20" onkeypress="if(event.key==='Enter')submitUsername()">
                    <button class="setup-btn" onclick="submitUsername()">Join ‚Üí</button>
                </div>
                <div class="chat-body" id="chatBody" style="display:none;">
                    <div class="chat-status" id="chatStatus">Connecting...</div>
                    <div id="pinnedMsg">
                        <i class="fas fa-thumbtack"></i>
                        <span><strong>Pinned:</strong> <span id="pinnedMsgText"></span></span>
                        <button class="unpin-btn" onclick="unpinMessage()">√ó</button>
                    </div>
                    <div class="chat-main-area">
                        <div id="chatUserList">
                            <div class="user-list-header">Online</div>
                            <div class="user-list-body" id="userListBody"></div>
                        </div>
                        <div class="chat-messages-wrap">
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="typing-bar" id="typingBar">
                                <span id="typingUsers"></span>
                                <span class="typing-dots"><span></span><span></span><span></span></span>
                            </div>
                            <div class="reply-bar" id="replyBar">
                                Replying to <strong id="replyToUser"></strong>
                                <button class="cancel-reply" onclick="cancelReply()">√ó</button>
                            </div>
                            <div class="img-preview-wrap">
                                <div style="position:relative;display:inline-block;">
                                    <img id="imgPreview" class="img-preview">
                                    <button onclick="removeImage()" id="removeImgBtn" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--primary);border:none;border-radius:50%;width:16px;height:16px;color:white;cursor:pointer;font-size:10px;align-items:center;justify-content:center;">√ó</button>
                                </div>
                            </div>
                            <div class="chat-input-row">
                                <label for="imageInput" class="img-btn" title="Upload image"><i class="fas fa-image"></i></label>
                                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                                <input type="text" id="chatInput" class="chat-input" placeholder="Message... (try :heart: :fire: :skull:)" onkeypress="handleChatKey(event)" oninput="handleTyping()">
                                <button class="send-btn" onclick="sendMessage()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="panel" id="panel-settings">
            <div class="panel-header"><div class="panel-title">Settings</div></div>
            <div class="panel-body">
                <div class="settings-body">
                    <div class="s-section">
                        <div class="s-label">Theme</div>
                        <div class="theme-grid" id="themeGrid"></div>
                        <div style="margin-top:10px;display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;">
                            <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Custom color</span>
                            <input type="color" id="customColorPicker" value="#7c4dff"
                                style="width:36px;height:28px;border:none;border-radius:6px;cursor:pointer;background:none;padding:0;"
                                oninput="applyCustomColor(this.value)">
                            <span id="customColorHex" style="font-size:11px;color:var(--text-faint);font-family:'JetBrains Mono',monospace;">#7c4dff</span>
                            <button onclick="resetCustomColor()" style="margin-left:auto;padding:4px 10px;background:var(--surface-hover);border:1px solid var(--border-hover);border-radius:6px;color:var(--text-dim);font-size:11px;cursor:pointer;font-family:'Outfit',sans-serif;">Reset</button>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Search Engine</div>
                        <div class="se-row">
                            <button class="se-btn active" id="se-google" onclick="setSE('google',this)">Google</button>
                            <button class="se-btn" id="se-bing" onclick="setSE('bing',this)">Bing</button>
                            <button class="se-btn" id="se-ddg" onclick="setSE('ddg',this)">DuckDuckGo</button>
                            <button class="se-btn" id="se-yahoo" onclick="setSE('yahoo',this)">Yahoo</button>
                            <button class="se-btn" id="se-brave" onclick="setSE('brave',this)">Brave</button>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Chat Font Size</div>
                        <div class="font-row">
                            <button class="font-btn" id="fs-small" onclick="setFontSize('small',this)">Small</button>
                            <button class="font-btn active" id="fs-medium" onclick="setFontSize('medium',this)">Medium</button>
                            <button class="font-btn" id="fs-large" onclick="setFontSize('large',this)">Large</button>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Options</div>
                        <div class="toggle-row" onclick="toggleCloak()">
                            <span class="toggle-row-label">Tab Cloaking</span>
                            <div class="toggle" id="cloakToggle"><div class="toggle-knob"></div></div>
                        </div>
                        <div id="cloakPresetRow" style="display:none;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;gap:10px;align-items:center;flex-wrap:wrap;">
                            <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Cloak Preset</span>
                            <select id="cloakPresetSelect" onchange="applyCloakPreset(this.value)" style="flex:1;padding:7px 10px;background:var(--bg3);border:1px solid var(--border-hover);border-radius:7px;color:var(--text);font-size:12px;font-family:'Outfit',sans-serif;outline:none;cursor:pointer;">
                                <option value="google">Google</option>
                                <option value="docs">Google Docs</option>
                                <option value="canvas">Canvas</option>
                                <option value="khan">Khan Academy</option>
                                <option value="classroom">Google Classroom</option>
                                <option value="desmos">Desmos</option>
                                <option value="wikipedia">Wikipedia</option>
                                <option value="schoology">Schoology</option>
                            </select>
                        </div>
                        <div class="toggle-row" onclick="togglePanic()">
                            <span class="toggle-row-label">Panic Key</span>
                            <div class="toggle" id="panicToggle"><div class="toggle-knob"></div></div>
                        </div>
                        <div id="panicKeyRow" style="display:none;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;gap:10px;align-items:center;flex-wrap:wrap;">
                            <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Key</span>
                            <input id="panicKeyInput" readonly placeholder="Click then press a key..."
                                style="flex:1;padding:7px 10px;background:var(--bg3);border:1px solid var(--border-hover);border-radius:7px;color:var(--primary);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;cursor:pointer;text-align:center;"
                                onclick="startKeyCapture()">
                            <span style="font-size:12px;color:var(--text-dim);flex-shrink:0;">Redirect URL</span>
                            <input id="panicUrlInput" type="text" placeholder="https://google.com"
                                style="flex:2;padding:7px 10px;background:var(--bg3);border:1px solid var(--border-hover);border-radius:7px;color:var(--text);font-size:12px;font-family:'Outfit',sans-serif;outline:none;"
                                onchange="localStorage.setItem('desritory-panic-url',this.value)">
                        </div>
                        <div class="toggle-row" onclick="toggleParticles()">
                            <span class="toggle-row-label">Show Particles</span>
                            <div class="toggle on" id="particlesToggle"><div class="toggle-knob"></div></div>
                        </div>
                        <div class="toggle-row" onclick="toggleSounds()">
                            <span class="toggle-row-label">Notification Sounds</span>
                            <div class="toggle" id="soundToggle"><div class="toggle-knob"></div></div>
                        </div>
                        <div class="toggle-row" onclick="toggleShortcutsHint()">
                            <span class="toggle-row-label">Keyboard Shortcuts <span style="font-size:11px;color:var(--text-faint);">(Ctrl+1‚Äì5, / for search)</span></span>
                            <span style="color:var(--text-faint);font-size:12px;">?</span>
                        </div>
                    </div>
                    <div class="s-section">
                        <div class="s-label">Account</div>
                        <div class="toggle-row" onclick="changeUsername()">
                            <span class="toggle-row-label">Change Username <span id="usernameDisplay" style="color:var(--primary);font-size:11px;"></span></span>
                            <span style="color:var(--text-faint);font-size:12px;">‚Üí</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="panel" id="panel-updates">
            <div class="panel-header"><div class="panel-title">Updates</div></div>
            <div class="panel-body">
                <div class="update-body">
                    <div class="update-ver">v4.0.0</div>
                    <div class="update-sub">What's new in this update</div>
                    <div class="update-notes">
                        ‚Ä¢ Welcome to V4!<br>
                        ‚Ä¢ New sidebar navigation<br>
                        ‚Ä¢ Status bar with live stats at the bottom<br>
                        ‚Ä¢ CHAT UPDATES:<br>
                        ‚Ä¢ Added in tab pop-up for the chat!<br>
                        ‚Ä¢ Timestamps hidden by default, shows on hover<br>
                        ‚Ä¢ Change your username anytime from Settings<br>
                        ‚Ä¢ Message reactions (hover a message ‚Üí üòä)<br>
                        ‚Ä¢ Edit &amp; delete your own messages<br>
                        ‚Ä¢ Pinned messages support<br>
                        ‚Ä¢ Live user list sidebar in chat<br><br>
                        ‚Ä¢ SETTINGS UPDATES:<br>
                        ‚Ä¢ Theme picker now color swatches<br>
                        ‚Ä¢ Notification sounds toggle<br>
                        ‚Ä¢ Particle system saves battery when idle<br>
                        ‚Ä¢ Chat font size: small / medium / large<br>
                        ‚Ä¢ Custom panic redirect URL<br>
                        ‚Ä¢ Keyboard shortcuts (Ctrl+1-5, /)<br>
                        ‚Ä¢ Game sorting: default / A-Z / recent / category<br><br>
                        ‚Ä¢ POLISH:<br>
                        ‚Ä¢ Mobile responsive layout<br>
                        ‚Ä¢ Favicon notification dot for unread chat (i think it works idk)<br>
                        ‚Ä¢ that's all for now
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="statusbar">
        <div class="status-item">
            <div class="status-dot"></div>
            <span>Online</span>
        </div>
        <span class="status-sep">|</span>
        <div class="status-item">
            <i class="fas fa-users" style="font-size:10px;"></i>
            <span id="onlineCount">--</span> online
        </div>
        <span class="status-sep">|</span>
        <div class="status-item" id="stealthStatusBar" style="display:none;">
            <i class="fas fa-user-secret" style="font-size:10px;color:var(--primary);"></i>
            <span style="color:var(--primary);">Stealth</span>
        </div>
        <div class="status-spacer"></div>
        <div class="status-item">
            <span class="status-time" id="timeDisplay">12:00 AM</span>
        </div>
    </div>
</div>

<div id="fullscreenOverlay">
    <div class="fs-bar">
        <button class="fs-back" onclick="closeFullscreen()">‚Üê Back</button>
        <span class="fs-title" id="fsTitle"></span>
    </div>
    <iframe id="fullscreenIframe"></iframe>
</div>

<div id="loadingScreen">
    <div class="loader-ring"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<div class="modal-overlay" id="nameRequestModal">
    <div class="modal-box">
        <div class="modal-title">Name Request</div>
        <div class="modal-text"><strong id="nameRequesterDisplay">Someone</strong> wants to use the name <strong id="nameRequestedDisplay"></strong>. Allow this?</div>
        <div class="modal-btns">
            <button class="modal-btn primary" onclick="respondToNameRequest(true)">Allow</button>
            <button class="modal-btn secondary" onclick="respondToNameRequest(false)">Deny</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="nameWaitingModal">
    <div class="modal-box">
        <div class="spinner"></div>
        <div class="modal-title">Waiting for approval...</div>
        <div class="modal-text" id="nameWaitingText">The user with that name has been notified.</div>
    </div>
</div>

<div class="floating-warn" id="spamWarn"><div id="spamWarnText">Hey, stop spamming!!</div></div>
<div class="floating-warn" id="slurWarn">
    <div class="sw-icon">üö´</div>
    <div class="sw-title">Not allowed.</div>
    <div class="sw-text">That's not cool. Cooldown:</div>
    <div class="sw-timer" id="slurTimer">10</div>
</div>

<div id="shortcutsHint">
    <div class="shortcut-row"><span class="shortcut-key">Ctrl+1</span> Home &nbsp; <span class="shortcut-key">Ctrl+2</span> Proxy</div>
    <div class="shortcut-row"><span class="shortcut-key">Ctrl+3</span> Games &nbsp; <span class="shortcut-key">Ctrl+4</span> Chat</div>
    <div class="shortcut-row"><span class="shortcut-key">Ctrl+5</span> Settings &nbsp; <span class="shortcut-key">/</span> Focus search</div>
    <div class="shortcut-row"><span class="shortcut-key">Esc</span> Close fullscreen</div>
</div>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, push, onChildAdded, onChildChanged, onChildRemoved, limitToLast, query, remove, get, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCtWJWMhHL3ZZ8cyG6oYLJLLWRpqLHrdA",
        authDomain: "desritory-chat.firebaseapp.com",
        databaseURL: "https://desritory-chat-default-rtdb.firebaseio.com",
        projectId: "desritory-chat",
        storageBucket: "desritory-chat.firebasestorage.app",
        messagingSenderId: "799268069839",
        appId: "1:799268069839:web:4bcbfa0389603054bf32ba"
    };

    let db = null, isInit = false;
    let messagesRef, typingRef, presenceRef, activeNamesRef, nameRequestsRef, pinnedRef, chatUsersRef;

    const sessionUid = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        messagesRef    = ref(db, 'messages');
        typingRef      = ref(db, 'typing');
        presenceRef    = ref(db, 'presence');
        activeNamesRef = ref(db, 'activeNames');
        nameRequestsRef= ref(db, 'nameRequests');
        pinnedRef      = ref(db, 'pinned');
        chatUsersRef   = ref(db, 'chatUsers');
        isInit = true;

        const pRef = ref(db, `presence/${sessionUid}`);
        set(pRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {});
        onDisconnect(pRef).remove();
        setInterval(() => { if (isInit) set(pRef, { online: true, lastSeen: serverTimestamp() }).catch(() => {}); }, 30000);
        onValue(ref(db, 'presence'), snap => {
            const el = document.getElementById('onlineCount');
            if (el) el.textContent = snap.val() ? Object.keys(snap.val()).length : 0;
        });

        const cuRef = ref(db, `chatUsers/${sessionUid}`);
        set(cuRef, { username: localStorage.getItem('desritory-username') || '...', timestamp: serverTimestamp() }).catch(() => {});
        onDisconnect(cuRef).remove();

        window._updateChatUserName = (name) => {
            set(cuRef, { username: name, timestamp: serverTimestamp() }).catch(() => {});
        };

    } catch (e) {
        console.error('Firebase error:', e);
        setChatStatus('error', 'üî¥ Firebase not configured');
    }

    function safeKey(s) { return s.replace(/[.#$[\]/]/g, '_'); }

    window.firebaseChat = {
        sendMessage: (u, t, img=null, reply=null) => {
            if (!isInit) return Promise.reject();
            const d = { username: u, text: t, timestamp: serverTimestamp() };
            if (img) d.imageUrl = img;
            if (reply) d.replyTo = reply;
            return push(messagesRef, d);
        },
        listenToMessages: (cb) => {
            if (!isInit) return;
            onChildAdded(query(messagesRef, limitToLast(50)), snap => { const m = snap.val(); m.id = snap.key; cb(m); });
        },
        setTyping: (u, on) => {
            if (!isInit) return Promise.reject();
            const r = ref(db, `typing/${safeKey(u)}`);
            return on ? set(r, { username: u, timestamp: serverTimestamp() }) : remove(r);
        },
        listenToTyping: (cb) => {
            if (!isInit) return;
            onChildAdded(typingRef,   s => { const d=s.val(); if(d) cb(d.username,true);  });
            onChildChanged(typingRef, s => { const d=s.val(); if(d) cb(d.username,true);  });
            onChildRemoved(typingRef, s => { const d=s.val(); if(d) cb(d.username,false); });
        },
        isInitialized: () => isInit,
        checkNameAvailable: async (name) => {
            if (!isInit) return { available: true };
            const snap = await get(ref(db, `activeNames/${safeKey(name.toLowerCase())}`));
            if (!snap.exists()) return { available: true };
            const d = snap.val();
            if (Date.now() - d.lastSeen > 120000) { await remove(ref(db, `activeNames/${safeKey(name.toLowerCase())}`)); return { available: true }; }
            return { available: false, ownerId: d.ownerId };
        },
        claimName: (name, oid) => {
            if (!isInit) return Promise.resolve();
            const r = ref(db, `activeNames/${safeKey(name.toLowerCase())}`);
            onDisconnect(r).remove();
            return set(r, { ownerId: oid, lastSeen: serverTimestamp(), displayName: name });
        },
        keepNameAlive: (name, oid) => {
            if (!isInit) return;
            set(ref(db, `activeNames/${safeKey(name.toLowerCase())}`), { ownerId: oid, lastSeen: serverTimestamp(), displayName: name }).catch(() => {});
        },
        releaseName: (name) => {
            if (!isInit) return;
            remove(ref(db, `activeNames/${safeKey(name.toLowerCase())}`)).catch(() => {});
        },
        sendNameRequest: (rid, reqTemp, desired, targetOid) => {
            if (!isInit) return Promise.reject();
            return set(ref(db, `nameRequests/${rid}`), { requesterTemp: reqTemp, desiredName: desired, targetOwnerId: targetOid, status: 'pending', timestamp: serverTimestamp() });
        },
        listenNameRequest: (rid, cb) => {
            if (!isInit) return;
            onValue(ref(db, `nameRequests/${rid}`), s => { if (s.exists()) cb(s.val()); });
        },
        listenForIncomingNameRequests: (oid, cb) => {
            if (!isInit) return;
            const seen = new Set();
            onValue(nameRequestsRef, snap => {
                snap.forEach(child => {
                    const d = child.val();
                    if (d && d.targetOwnerId === oid && d.status === 'pending' && !seen.has(child.key)) {
                        seen.add(child.key);
                        cb(child.key, d);
                    }
                });
            });
        },
        respondToNameRequest: (rid, approved) => {
            if (!isInit) return Promise.reject();
            return set(ref(db, `nameRequests/${rid}`), { status: approved ? 'approved' : 'denied', timestamp: serverTimestamp() });
        },
        cleanupNameRequest: (rid) => {
            if (!isInit) return;
            remove(ref(db, `nameRequests/${rid}`)).catch(() => {});
        },

        _rKey: (emoji, uname) => encodeURIComponent(emoji).replace(/%/g,'p') + '__' + uname.replace(/[.#$[\]/]/g,'_'),
        addReaction: (msgId, emoji, uname) => {
            if (!isInit) return Promise.reject();
            return set(ref(db, `reactions/${msgId}/${window.firebaseChat._rKey(emoji,uname)}`), { emoji, username: uname });
        },
        removeReaction: (msgId, emoji, uname) => {
            if (!isInit) return Promise.reject();
            return remove(ref(db, `reactions/${msgId}/${window.firebaseChat._rKey(emoji,uname)}`));
        },
        listenToReactions: (msgId, cb) => {
            if (!isInit) return () => {};
            return onValue(ref(db, `reactions/${msgId}`), snap => { cb(snap.val() || {}); });
        },

        editMessage: (msgId, newText) => {
            if (!isInit) return Promise.reject();
            return update(ref(db, `messages/${msgId}`), { text: newText, edited: true });
        },
        deleteMessage: (msgId) => {
            if (!isInit) return Promise.reject();
            return remove(ref(db, `messages/${msgId}`));
        },

        pinMessage: (msgId, text, uname) => {
            if (!isInit) return Promise.reject();
            return set(pinnedRef, { msgId, text, username: uname, timestamp: serverTimestamp() });
        },
        unpin: () => { if (isInit) remove(pinnedRef).catch(() => {}); },
        listenToPinned: (cb) => {
            if (!isInit) return;
            onValue(pinnedRef, snap => { cb(snap.exists() ? snap.val() : null); });
        },

        setChatUser: (uname) => {
            if (window._updateChatUserName) window._updateChatUserName(uname);
        },
        listenChatUsers: (cb) => {
            if (!isInit) return;
            onValue(chatUsersRef, snap => { cb(snap.val() || {}); });
        }
    };

    if (isInit) setChatStatus('connected', 'üü¢ Connected ‚Äî Real-time chat active');

    function setChatStatus(cls, txt) {
        const el = document.getElementById('chatStatus');
        if (el) { el.className = 'chat-status ' + cls; el.textContent = txt; }
    }
</script>

<script>
    const EMOJI_MAP = {
        ':sob:':'üò≠',':cry:':'üò¢',':smile:':'üòä',':laugh:':'üòÇ',':lol:':'üòÇ',
        ':rofl:':'ü§£',':heart:':'‚ù§Ô∏è',':broken_heart:':'üíî',':fire:':'üî•',
        ':100:':'üíØ',':thumbsup:':'üëç',':thumbsdown:':'üëé',':ok:':'üëå',
        ':wave:':'üëã',':clap:':'üëè',':pray:':'üôè',':skull:':'üíÄ',':eyes:':'üëÄ',
        ':thinking:':'ü§î',':shrug:':'ü§∑',':facepalm:':'ü§¶',':wink:':'üòâ',
        ':sunglasses:':'üòé',':cool:':'üòé',':angry:':'üò†',':rage:':'üò§',
        ':sad:':'üòû',':pensive:':'üòî',':shocked:':'üò±',':scream:':'üò±',
        ':sweat:':'üòÖ',':nervous:':'üò¨',':smirk:':'üòè',':tongue:':'üòõ',
        ':kiss:':'üòò',':love:':'ü•∞',':sparkles:':'‚ú®',':star:':'‚≠ê',
        ':rainbow:':'üåà',':sun:':'‚òÄÔ∏è',':moon:':'üåô',':snowflake:':'‚ùÑÔ∏è',
        ':pizza:':'üçï',':burger:':'üçî',':taco:':'üåÆ',':cat:':'üê±',
        ':dog:':'üê∂',':penguin:':'üêß',':frog:':'üê∏',':ghost:':'üëª',
        ':alien:':'üëΩ',':robot:':'ü§ñ',':poop:':'üí©',':clown:':'ü§°',
        ':crown:':'üëë',':gem:':'üíé',':rocket:':'üöÄ',':boom:':'üí•',
        ':party:':'üéâ',':tada:':'üéâ',':music:':'üéµ',':headphones:':'üéß',
        ':coffee:':'‚òï',':gaming:':'üéÆ',':sus:':'üìÆ',':pepe:':'üê∏',
        ':nerd:':'ü§ì',':monocle:':'üßê',':dead:':'üíÄ',':based:':'üòé',
        ':goat:':'üêê',':real:':'üíØ',':cap:':'üß¢',':nocap:':'üíØ',
    };

    const REACTION_EMOJIS = ['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò°','üëç','üëé','üî•','üíØ','üíÄ','ü§Ø','üòé'];

    const SLUR_PATTERNS = [
        /n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+[g9]{2,}[e3]*r?/gi,
        /n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+g{2,}/gi,
        /n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]gg[ae3]/gi,
        /f[a@]+g{2,}[o0]t/gi,/f[a@]+g[s$]/gi,/fagg?[o0]t/gi,/fag/gi,
        /k[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+k[e3]/gi,
        /sp[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+c/gi,
        /ch[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+nk/gi,
        /w[e3]+tb[a@]+ck/gi,/cr[a@]+ck[e3]+r/gi,/r[e3]+t[a@]+rd/gi,
        /c[o0]{2,}n/gi,
        /j[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+gg[a@]+b[o0]+[o0]/gi,
        /n1gger/gi,/n1gg3r/gi,
        /r3gg[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]n/gi,
        /[a-z0-9]n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]gger/gi,
        /[a-z0-9]n1gger/gi,/[a-z0-9]n1gg3r/gi,
        /n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]gg[ae3r]/gi,
        /n[iIl√ç√≠√å√¨√é√Æ√è√Øƒ¨ƒ≠ƒ™ƒ´ƒÆƒØƒ∞ƒ±ƒ®ƒ©·ªà·ªâ·ªä·ªã–Ü—ñ”ÄŒôŒπ«Ä…©‚Ñê‚Ñë!1|]+g+[e3r]+/gi,
    ];

    const SEARCH_ENGINES = {
        google: 'https://www.google.com/search?q=%s',
        bing: 'https://www.bing.com/search?q=%s',
        ddg: 'https://duckduckgo.com/?q=%s',
        yahoo: 'https://search.yahoo.com/search?p=%s',
        brave: 'https://search.brave.com/search?q=%s',
    };

    const SCRAMJET_URL = 'https://scramjet-app-production-a204.up.railway.app';

    const IMAGES = {
        jhbetr:'https://i.imgur.com/IZ0wJQb.jpeg',minecraft:'https://i.imgur.com/ppi20I9.png',
        gd:'https://i.imgur.com/fpc76U0.jpeg',lacey:'https://i.imgur.com/KEYn8gZ.png',
        ultrakill:'https://i.imgur.com/wgmTwWM.jpeg',epstein:'https://i.imgur.com/OiAiMSl.png',
        fnaf1:'https://i.imgur.com/11OJGXJ.jpeg',fnaf2:'https://i.imgur.com/OfpGVct.jpeg',
        fnaf3:'https://i.imgur.com/ZcwnBE4.png',fnaf4:'https://i.imgur.com/Ew1nrVj.png',
        hollow:'https://i.imgur.com/iaSgADM.jpeg',fnaf4h:'https://i.imgur.com/MvYx18h.png',
        fnafsister:'https://i.imgur.com/bLD2AQ1.png',fnafpizza:'https://i.imgur.com/xU4nL4x.png',
        fnafucn:'https://i.imgur.com/uIPUty9.png',people:'https://i.imgur.com/BgcqQ1w.png',
        gtag:'https://i.imgur.com/LziGRnF.png',bendy:'https://i.imgur.com/N63N7D7.png',
        alien:'https://i.imgur.com/e0IXj6f.png',sans:'https://i.imgur.com/396NH6D.png',
        happy:'https://i.imgur.com/0ocMSU3.png',undertale:'https://i.imgur.com/vOKZyyK.png',
        class:'https://i.imgur.com/4ofYraf.png',
        endo:'https://cdn.jsdelivr.net/gh/gn-math/covers@main/286.png',
        raft: 'https://cdn.jsdelivr.net/gh/gn-math/covers@main/457.png',
        fallout:'https://cdn.jsdelivr.net/gh/gn-math/covers@main/585.png',
        granny:'https://cdn.jsdelivr.net/gh/gn-math/covers@main/90.png',
        slender:'https://cdn.jsdelivr.net/gh/gn-math/covers@main/451.png',
    };

    const games = [
        {name:'Subway Surfers NY',icon:'https://playernation.graphicon.org/resources/semag/subway-surfers-ny/NewYorkIcon.png',url:'https://playernation.graphicon.org/resources/semag/subway-surfers-ny/index.html',category:'Runner'},
        {name:'GTA Vice City',icon:'https://i.imgur.com/Zli9nme.png',url:'https://playernation.graphicon.org/resources/semag/gtavc/index.html',category:'Action'},
        {name:'Doki Doki Literature Club',icon:'https://playernation.graphicon.org/resources/semag/ddlc/icons/web-icon.png',url:'https://playernation.graphicon.org/resources/semag/ddlc/index.html',category:'Visual Novel'},
        {name:'DDLC Plus',icon:'https://i.imgur.com/b8DhT4P.jpeg',url:'https://playernation.graphicon.org/resources/semag/ddlcplus/index.html',category:'Visual Novel'},
        {name:'JHBETR',icon:IMAGES.jhbetr,url:'https://jhbetr.github.io/',category:'amazing game play it'},
        {name:'Minecraft',icon:IMAGES.minecraft,url:'/games/minecraft.html',category:'minecraft'},
        {name:'Geometry Dash',icon:IMAGES.gd,url:'/games/gdlite/index.html',category:'BROKEN AUDIO'},
        {name:'Lacey Games',icon:IMAGES.lacey,url:'/games/laceygames/index.html',category:'lacey games'},
        {name:'ULTRAKILL',icon:IMAGES.ultrakill,url:'/games/ultrakill/index.html',category:'ultrakill'},
        {name:'Five Nights at Epsteins',icon:IMAGES.epstein,url:'/games/epstein.html',category:'Survive Epstein'},
        {name:'FNaF 1',icon:IMAGES.fnaf1,url:'/games/fnaf.html',category:'Fnaf 1'},
        {name:'FNaF 2',icon:IMAGES.fnaf2,url:'/games/fnaf2.html',category:'fnaf 2'},
        {name:'FNaF 3',icon:IMAGES.fnaf3,url:'/games/fnaf3.html',category:'fnaf 3'},
        {name:'FNaF 4',icon:IMAGES.fnaf4,url:'/games/fnaf4.html',category:'fnaf 4'},
        {name:'FNaF 4 Halloween',icon:IMAGES.fnaf4h,url:'/games/fnaf4h.html',category:'fnaf 4 scarier'},
        {name:'Sister Location',icon:IMAGES.fnafsister,url:'/games/fnafsister.html',category:'scarier fnaf'},
        {name:'FNaF Pizza',icon:IMAGES.fnafpizza,url:'/games/fnafpizza.html',category:'pizza scary'},
        {name:'UCN',icon:IMAGES.fnafucn,url:'/games/fnafucn.html',category:'ultimate custom night'},
        {name:'Class of 09',icon:IMAGES.class,url:'/games/classof09.html',category:'very fun'},
        {name:'Undertale',icon:IMAGES.undertale,url:'/games/UNDERTALE.html',category:'fun game'},
        {name:'Hollow Knight',icon:IMAGES.hollow,url:'/games/hollowknight.html',category:'fire game'},
        {name:'People Playground',icon:IMAGES.people,url:'/games/peopleplayground.html',category:'fun'},
        {name:'Gorilla Tag',icon:IMAGES.gtag,url:'/games/gorillatag.html',category:'gorilla'},
        {name:'Bendy and the Ink Machine',icon:IMAGES.bendy,url:'/games/bendy.html',category:'scary'},
        {name:'Alien Hominid',icon:IMAGES.alien,url:'/games/alienhominid.html',category:'alien game'},
        {name:'Bad Time Simulator',icon:IMAGES.sans,url:'/games/badtimesimulator.html',category:'bad time'},
        {name:'Happy Wheels',icon:IMAGES.happy,url:'/games/happywheels.html',category:'gorey'},
        {name:'Slender and the Eight Pages',icon:IMAGES.slender,url:'/games/slender.html',category: 'oohh scaryyy'},
        {name:'Endoparasitic',icon:IMAGES.endo,url:'/games/endo.html',category: 'pretty gorey at the beginning'},
        {name:'Fallout',icon:IMAGES.fallout,url:'/games/fallout.html',category: 'Fun'},
        {name:'Raft',icon:IMAGES.raft,url:'/games/raft.html',category: 'also fun'},
        {name:'Granny',icon:IMAGES.granny,url:'/games/granny.html',category: 'scaryyy'},
    ];

    const apps = [
        {name:'ZIP file unzipper',icon:'',url:'/games/zipfile.html',category:'Unzip any file on your chromebook'},
    ];

    const themes = {
        purple:{primary:'#7c4dff',bg:'#0d0d10'},
        green:{primary:'#10b981',bg:'#040f0a'},
        blue:{primary:'#3b82f6',bg:'#040a14'},
        red:{primary:'#ef4444',bg:'#100606'},
        pink:{primary:'#ec4899',bg:'#100610'},
        spooky:{primary:'#ff6b00',bg:'#0e0600'},
        sky:{primary:'#38bdf8',bg:'#04101a'},
        yellow:{primary:'#eab308',bg:'#100d00'},
        galaxy:{primary:'#9333ea',bg:'#050410'},
        slate:{primary:'#888',bg:'#0d0d10'},
    };
    const themeNames = {purple:'Purple',green:'Green',blue:'Blue',red:'Red',pink:'Pink',spooky:'Spooky',sky:'Sky',yellow:'Yellow',galaxy:'Galaxy',slate:'Slate'};

    const CLOAK_PRESETS = {
        google:    { title: 'Google',           favicon: 'https://www.google.com/favicon.ico' },
        docs:      { title: 'Google Docs',      favicon: 'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico' },
        canvas:    { title: 'Canvas',           favicon: 'https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico' },
        khan:      { title: 'Khan Academy',     favicon: 'https://cdn.kastatic.org/images/favicon.ico' },
        classroom: { title: 'Google Classroom', favicon: 'https://ssl.gstatic.com/classroom/favicon.png' },
        desmos:    { title: 'Desmos',           favicon: 'https://www.desmos.com/favicon.ico' },
        wikipedia: { title: 'Wikipedia',        favicon: 'https://en.wikipedia.org/favicon.ico' },
        schoology: { title: 'Schoology',        favicon: 'https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico' },
    };

    let currentPanel = 'home';
    let username = localStorage.getItem('desritory-username') || '';
    let myOwnerId = localStorage.getItem('desritory-ownerid') || ('owner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
    localStorage.setItem('desritory-ownerid', myOwnerId);

    let isChatOpen = false, messageIds = new Set(), messagesCache = {};
    let replyingToMessage = null, selectedImageBase64 = null;
    let typingTimeout = null, currentlyTypingUsers = new Set();
    let unreadCount = 0, lastReadTimestamp = Date.now();
    let msgHistory = [], spamWarnCount = 0, spamWarnTimeout = null;
    let slurTO = null, slurInterval = null;
    let nameKeepAlive = null, pendingNameRequestResolve = null, pendingNameRequestId = null;
    let chatListenersAttached = false, bufferedMessages = [], pendingIncomingId = null;
    let recentlyPlayed = JSON.parse(localStorage.getItem('desritory-recent') || '[]');
    let faviconCanvas = null, faviconCtx = null, faviconLink = null;
    let showingShortcuts = false;

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.mnav-item').forEach(n => n.classList.remove('active'));

        const panel = document.getElementById('panel-' + id);
        if (panel) panel.classList.add('active');
        const nav = document.getElementById('nav-' + id);
        if (nav) nav.classList.add('active');

        const mnavItems = document.querySelectorAll('.mnav-item');
        const panelOrder = ['home','proxy','games','chat','settings'];
        const idx = panelOrder.indexOf(id);
        if (idx >= 0 && mnavItems[idx]) mnavItems[idx].classList.add('active');

        currentPanel = id;
        if (id === 'chat') openChat();
    }

    function updateTime() {
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        document.getElementById('timeDisplay').textContent = `${h}:${String(m).padStart(2,'0')} ${ampm}`;
    }
    updateTime();
    setInterval(updateTime, 1000);

    function setHomeSub() {
        const h = new Date().getHours();
        let phrases;
        if (h >= 0 && h < 5) phrases = ["you're up late", "hi night owl", "go to sleep.", "why are you awake"];
        else if (h >= 7 && h < 9) phrases = ["you're up early", "good morning", "wow it's morning"];
        else phrases = ["we're just better.", "i <3 s0rrow.", "Welcome to Freedom.", "uhhhh no?", "i love music"];
        document.getElementById('homeSub').textContent = phrases[Math.floor(Math.random() * phrases.length)];
    }
    setHomeSub();

    function launchProxy() {
        const inp = document.getElementById('proxyInput');
        if (inp) launchProxyUrl(inp.value.trim());
    }

    function launchProxyUrl(url) {
        if (!url) return;
        let finalUrl = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            if (url.includes('.') && !url.includes(' ')) finalUrl = 'https://' + url;
            else finalUrl = getSE().replace('%s', encodeURIComponent(url));
        }
        const iframe = document.getElementById('proxyIframe');
        iframe.src = `${SCRAMJET_URL}#${encodeURIComponent(finalUrl)}`;
        iframe.style.display = 'block';
        document.getElementById('proxyHome').style.display = 'none';
        showPanel('proxy');
    }

    document.getElementById('proxyInput').addEventListener('keypress', e => { if (e.key === 'Enter') launchProxy(); });

    const proxyIframe = document.getElementById('proxyIframe');
    proxyIframe.src = SCRAMJET_URL;
    proxyIframe.style.display = 'block';
    document.getElementById('proxyHome').style.display = 'none';

    function getSE() {
        return SEARCH_ENGINES[localStorage.getItem('desritory-se') || 'google'] || SEARCH_ENGINES.google;
    }

    function renderGames(filter = '') {
        const list = document.getElementById('gamesList');
        const sort = document.getElementById('gameSortSelect')?.value || 'default';
        list.innerHTML = '';

        let filtered = games.filter(g =>
            g.name.toLowerCase().includes(filter.toLowerCase()) ||
            g.category.toLowerCase().includes(filter.toLowerCase())
        );

        if (sort === 'alpha') {
            filtered = [...filtered].sort((a,b) => a.name.localeCompare(b.name));
        } else if (sort === 'recent') {
            filtered = [...filtered].sort((a,b) => {
                const ai = recentlyPlayed.indexOf(a.name);
                const bi = recentlyPlayed.indexOf(b.name);
                if (ai === -1 && bi === -1) return 0;
                if (ai === -1) return 1;
                if (bi === -1) return -1;
                return ai - bi;
            });
        } else if (sort === 'category') {
            filtered = [...filtered].sort((a,b) => a.category.localeCompare(b.category));
        }

        filtered.forEach(game => {
            const card = document.createElement('div');
            card.className = 'game-card';
            const isRecent = recentlyPlayed.includes(game.name);
            card.innerHTML = `
                <img class="game-card-thumb" src="${game.icon}" alt="${game.name}" onerror="this.style.background='var(--bg3)'">
                <div class="game-card-info">
                    <div class="game-card-name">${game.name}${isRecent ? ' <span style="font-size:9px;color:var(--primary);margin-left:4px;">‚ñ∂ Recent</span>' : ''}</div>
                    <div class="game-card-cat">${game.category}</div>
                </div>`;
            card.onclick = () => {
                recentlyPlayed = [game.name, ...recentlyPlayed.filter(n => n !== game.name)].slice(0, 10);
                localStorage.setItem('desritory-recent', JSON.stringify(recentlyPlayed));
                openFullscreen(game.name, game.url);
            };
            list.appendChild(card);
        });
    }

    function renderApps(filter = '') {
        const list = document.getElementById('appsList');
        list.innerHTML = '';
        const filtered = apps.filter(a => a.name.toLowerCase().includes(filter.toLowerCase()));
        if (!filtered.length) {
            list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-faint);">No apps yet.</div>';
            return;
        }
        filtered.forEach(app => {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.innerHTML = `
                <img class="game-card-thumb" src="${app.icon}" alt="${app.name}" onerror="this.style.background='var(--bg3)'">
                <div class="game-card-info">
                    <div class="game-card-name">${app.name}</div>
                    <div class="game-card-cat">${app.category}</div>
                </div>`;
            card.onclick = () => openFullscreen(app.name, app.url);
            list.appendChild(card);
        });
    }

    function openFullscreen(name, url) {
        const ls = document.getElementById('loadingScreen');
        document.getElementById('loadingText').textContent = `Loading ${name}...`;
        ls.classList.add('on');
        setTimeout(() => {
            ls.classList.remove('on');
            document.getElementById('fsTitle').textContent = name;
            document.getElementById('fullscreenIframe').src = url;
            document.getElementById('fullscreenOverlay').classList.add('active');
        }, 600);
    }

    function closeFullscreen() {
        document.getElementById('fullscreenOverlay').classList.remove('active');
        document.getElementById('fullscreenIframe').src = '';
    }

    function toggleStealth() {
        const cur = localStorage.getItem('desritory-stealth') === 'true';
        const nv = !cur;
        localStorage.setItem('desritory-stealth', nv);
        applyStealth(nv);
        document.getElementById('nav-stealth').classList.toggle('stealth-on', nv);
    }

    function applyStealth(on) {
        const bar = document.getElementById('stealthStatusBar');
        if (on) {
            document.title = 'Google';
            let fav = document.querySelector("link[rel*='icon']") || document.createElement('link');
            fav.rel = 'shortcut icon'; fav.href = 'https://www.google.com/favicon.ico';
            document.head.appendChild(fav);
            if (bar) bar.style.display = 'flex';
        } else {
            document.title = 'Desritory V4';
            const fav = document.querySelector("link[rel*='icon']");
            if (fav) fav.href = '';
            if (bar) bar.style.display = 'none';
        }
    }

    function buildThemeGrid() {
        const grid = document.getElementById('themeGrid');
        grid.innerHTML = '';
        const saved = localStorage.getItem('desritory-theme') || 'slate';
        Object.entries(themes).forEach(([key, theme]) => {
            const el = document.createElement('div');
            el.className = 'theme-swatch' + (key === saved ? ' active' : '');
            el.dataset.theme = key;
            el.innerHTML = `<div class="swatch-dot" style="background:${theme.primary};box-shadow:0 0 8px ${theme.primary}66;"></div><div class="swatch-name">${themeNames[key]}</div>`;
            el.onclick = () => {
                document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                applyTheme(key);
            };
            grid.appendChild(el);
        });
    }

    function applyTheme(key) {
        const t = themes[key];
        if (!t) return;
        localStorage.setItem('desritory-theme', key);
        document.documentElement.style.setProperty('--primary', t.primary);
        document.documentElement.style.setProperty('--primary-dim', t.primary + '20');
        document.documentElement.style.setProperty('--primary-glow', t.primary + '44');
        document.body.style.background = t.bg;
        document.documentElement.style.setProperty('--bg', t.bg);
        document.querySelectorAll('.theme-swatch').forEach(s => s.classList.toggle('active', s.dataset.theme === key));
        const picker = document.getElementById('customColorPicker');
        if (picker) picker.value = t.primary.length === 7 ? t.primary : '#888888';
        const hexEl = document.getElementById('customColorHex');
        if (hexEl) hexEl.textContent = t.primary;
    }

    function applyCustomColor(hex) {
        document.documentElement.style.setProperty('--primary', hex);
        document.documentElement.style.setProperty('--primary-dim', hex + '20');
        document.documentElement.style.setProperty('--primary-glow', hex + '44');
        localStorage.setItem('desritory-custom-color', hex);
        const hexEl = document.getElementById('customColorHex');
        if (hexEl) hexEl.textContent = hex;
        document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
    }

    function resetCustomColor() {
        localStorage.removeItem('desritory-custom-color');
        const savedTheme = localStorage.getItem('desritory-theme') || 'slate';
        applyTheme(savedTheme);
        const picker = document.getElementById('customColorPicker');
        if (picker) picker.value = themes[savedTheme]?.primary || '#888888';
        const hexEl = document.getElementById('customColorHex');
        if (hexEl) hexEl.textContent = themes[savedTheme]?.primary || '#888888';
    }

    function setSE(key, btn) {
        localStorage.setItem('desritory-se', key);
        document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function setFontSize(size, btn) {
        const map = { small: '11px', medium: '13px', large: '15px' };
        document.documentElement.style.setProperty('--font-size-base', map[size]);
        localStorage.setItem('desritory-fontsize', size);
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function toggleCloak() {
        const t = document.getElementById('cloakToggle');
        t.classList.toggle('on');
        const on = t.classList.contains('on');
        localStorage.setItem('desritory-cloak', on);
        const presetRow = document.getElementById('cloakPresetRow');
        if (presetRow) presetRow.style.display = on ? 'flex' : 'none';
        if (on) {
            const saved = localStorage.getItem('desritory-cloak-preset') || 'google';
            document.getElementById('cloakPresetSelect').value = saved;
            applyCloakPreset(saved);
        } else {
            document.title = 'Desritory V4';
            const fav = document.querySelector("link[rel*='icon']");
            if (fav) fav.href = '';
        }
    }

    function applyCloakPreset(key) {
        const preset = CLOAK_PRESETS[key];
        if (!preset) return;
        localStorage.setItem('desritory-cloak-preset', key);
        document.title = preset.title;
        let fav = document.querySelector("link[rel*='icon']") || document.createElement('link');
        fav.rel = 'shortcut icon'; fav.href = preset.favicon;
        document.head.appendChild(fav);
    }

    function togglePanic() {
        const t = document.getElementById('panicToggle');
        t.classList.toggle('on');
        const on = t.classList.contains('on');
        localStorage.setItem('desritory-panic', on);
        const row = document.getElementById('panicKeyRow');
        if (row) row.style.display = on ? 'flex' : 'none';
    }

    function startKeyCapture() {
        const inp = document.getElementById('panicKeyInput');
        inp.value = '...';
        inp.style.borderColor = 'var(--primary)';
        inp.style.color = 'var(--text-faint)';
        function onKey(e) {
            e.preventDefault();
            const key = e.key;
            if (['Control','Shift','Alt','Meta'].includes(key)) return;
            localStorage.setItem('desritory-panic-key', key);
            inp.value = key === ' ' ? 'Space' : key;
            inp.style.borderColor = 'var(--border-hover)';
            inp.style.color = 'var(--primary)';
            window.removeEventListener('keydown', onKey, true);
        }
        window.addEventListener('keydown', onKey, true);
    }

    function toggleParticles() {
        const t = document.getElementById('particlesToggle');
        t.classList.toggle('on');
        const on = t.classList.contains('on');
        localStorage.setItem('desritory-particles', on);
        document.getElementById('bgCanvas').style.display = on ? 'block' : 'none';
    }

    function toggleSounds() {
        const t = document.getElementById('soundToggle');
        t.classList.toggle('on');
        localStorage.setItem('desritory-sounds', t.classList.contains('on'));
    }

    function toggleShortcutsHint() {
        showingShortcuts = !showingShortcuts;
        document.getElementById('shortcutsHint').classList.toggle('on', showingShortcuts);
    }

    function changeUsername() {
        if (username && window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.releaseName(username);
        username = '';
        localStorage.removeItem('desritory-username');
        updateUsernameDisplay();
        showPanel('chat');
    }

    function updateUsernameDisplay() {
        const el = document.getElementById('usernameDisplay');
        if (el) el.textContent = username ? `(${username})` : '';
        const label = document.getElementById('chatUserLabel');
        if (label) label.textContent = username ? `@${username}` : '';
    }

    function openChat() {
        isChatOpen = true;
        unreadCount = 0;
        lastReadTimestamp = Date.now();
        updateBadge();
        updateFaviconDot();
        updateUsernameDisplay();
        if (!username) {
            document.getElementById('chatSetup').style.display = 'flex';
            document.getElementById('chatBody').style.display = 'none';
            setTimeout(() => document.getElementById('chatSetupInput')?.focus(), 150);
        } else {
            document.getElementById('chatSetup').style.display = 'none';
            document.getElementById('chatBody').style.display = 'flex';
            initChatListeners();
        }
    }

    function submitUsername() {
        let desired = document.getElementById('chatSetupInput').value.trim() || ('Anon' + Math.floor(Math.random() * 1000));
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            resolveUsername(desired).then(resolved => {
                username = resolved;
                localStorage.setItem('desritory-username', username);
                updateUsernameDisplay();
                startNameKeepAlive();
                listenForNameRequests();
                window.firebaseChat.setChatUser(username);
                document.getElementById('chatSetup').style.display = 'none';
                document.getElementById('chatBody').style.display = 'flex';
                initChatListeners();
            }).catch(() => finishJoin(desired));
        } else {
            finishJoin(desired);
        }
    }

    function finishJoin(name) {
        username = name;
        localStorage.setItem('desritory-username', username);
        updateUsernameDisplay();
        if (window.firebaseChat) window.firebaseChat.setChatUser(username);
        document.getElementById('chatSetup').style.display = 'none';
        document.getElementById('chatBody').style.display = 'flex';
        initChatListeners();
    }

    function initChatListeners() {
        if (chatListenersAttached) { flushBuffered(); return; }
        chatListenersAttached = true;
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            window.firebaseChat.listenToMessages(msg => {
                bufferedMessages.push(msg);
                if (isChatOpen) flushBuffered();
            });
            window.firebaseChat.listenToTyping(handleTypingUpdate);
            window.firebaseChat.listenToPinned(data => {
                const el = document.getElementById('pinnedMsg');
                if (data) {
                    document.getElementById('pinnedMsgText').textContent = data.text;
                    el.classList.add('on');
                } else {
                    el.classList.remove('on');
                }
            });
            window.firebaseChat.listenChatUsers(data => {
                const body = document.getElementById('userListBody');
                if (!body) return;
                body.innerHTML = '';
                const users = Object.values(data).filter(u => u.username && u.username !== '...');
                if (!users.length) {
                    body.innerHTML = '<div style="padding:8px;font-size:11px;color:var(--text-faint);">No users yet</div>';
                    return;
                }
                users.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'user-list-item';
                    const initial = (u.username || '?')[0].toUpperCase();
                    item.innerHTML = `<div class="user-avatar">${initial}</div><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(u.username)}</span><div class="user-online-dot"></div>`;
                    body.appendChild(item);
                });
            });
        }
        setTimeout(() => { const m = document.getElementById('chatMessages'); if (m) m.scrollTop = m.scrollHeight; }, 100);
    }

    function flushBuffered() {
        const msgs = bufferedMessages.slice(); bufferedMessages = [];
        msgs.forEach(displayMessage);
    }

    async function resolveUsername(name) {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return name;
        let result;
        try { result = await window.firebaseChat.checkNameAvailable(name); } catch { return name; }
        if (result.available) { await window.firebaseChat.claimName(name, myOwnerId); return name; }
        if (result.ownerId === myOwnerId) return name;
        return new Promise(resolve => {
            pendingNameRequestResolve = resolve;
            const rid = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
            pendingNameRequestId = rid;
            document.getElementById('nameWaitingModal').classList.add('on');
            document.getElementById('nameWaitingText').textContent = `Waiting for holder of "${name}" to respond...`;
            window.firebaseChat.sendNameRequest(rid, myOwnerId, name, result.ownerId);
            window.firebaseChat.listenNameRequest(rid, data => {
                if (data.status === 'approved') {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.claimName(name, myOwnerId);
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    resolve(name);
                } else if (data.status === 'denied') {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = name + Math.floor(Math.random() * 9000 + 1000);
                    alert(`Denied. You'll be assigned "${alt}".`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            });
            setTimeout(() => {
                if (pendingNameRequestResolve) {
                    document.getElementById('nameWaitingModal').classList.remove('on');
                    window.firebaseChat.cleanupNameRequest(rid);
                    pendingNameRequestId = null; pendingNameRequestResolve = null;
                    const alt = name + Math.floor(Math.random() * 9000 + 1000);
                    alert(`No response. You'll be assigned "${alt}".`);
                    window.firebaseChat.claimName(alt, myOwnerId);
                    resolve(alt);
                }
            }, 30000);
        });
    }

    function startNameKeepAlive() {
        if (nameKeepAlive) clearInterval(nameKeepAlive);
        nameKeepAlive = setInterval(() => {
            if (window.firebaseChat && window.firebaseChat.isInitialized() && username)
                window.firebaseChat.keepNameAlive(username, myOwnerId);
        }, 60000);
    }

    function listenForNameRequests() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized()) return;
        window.firebaseChat.listenForIncomingNameRequests(myOwnerId, (rid, data) => {
            if (pendingIncomingId) return;
            pendingIncomingId = rid;
            document.getElementById('nameRequesterDisplay').textContent = 'Someone';
            document.getElementById('nameRequestedDisplay').textContent = data.desiredName;
            document.getElementById('nameRequestModal').classList.add('on');
        });
    }

    function respondToNameRequest(approved) {
        document.getElementById('nameRequestModal').classList.remove('on');
        if (pendingIncomingId) { window.firebaseChat.respondToNameRequest(pendingIncomingId, approved); pendingIncomingId = null; }
    }

    function updateBadge() {
        const badge = document.getElementById('chatBadge');
        if (unreadCount > 0) { badge.textContent = unreadCount > 99 ? '99+' : unreadCount; badge.classList.add('show'); }
        else badge.classList.remove('show');
    }

    function updateFaviconDot() {
        try {
            if (!faviconCanvas) {
                faviconCanvas = document.createElement('canvas');
                faviconCanvas.width = 32; faviconCanvas.height = 32;
                faviconCtx = faviconCanvas.getContext('2d');
                faviconLink = document.querySelector("link[rel*='icon']") || document.createElement('link');
                faviconLink.rel = 'shortcut icon';
                document.head.appendChild(faviconLink);
            }
            faviconCtx.clearRect(0, 0, 32, 32);
            faviconCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#7c4dff';
            faviconCtx.beginPath();
            faviconCtx.arc(16, 16, 14, 0, Math.PI * 2);
            faviconCtx.fill();
            faviconCtx.fillStyle = 'white';
            faviconCtx.font = 'bold 14px Outfit, sans-serif';
            faviconCtx.textAlign = 'center';
            faviconCtx.textBaseline = 'middle';
            faviconCtx.fillText('D', 16, 17);
            if (unreadCount > 0 && currentPanel !== 'chat') {
                faviconCtx.fillStyle = '#ef4444';
                faviconCtx.beginPath();
                faviconCtx.arc(26, 6, 7, 0, Math.PI * 2);
                faviconCtx.fill();
                faviconCtx.fillStyle = 'white';
                faviconCtx.font = 'bold 8px Outfit, sans-serif';
                faviconCtx.fillText(unreadCount > 9 ? '9+' : unreadCount, 26, 7);
            }
            if (localStorage.getItem('desritory-cloak') !== 'true' && localStorage.getItem('desritory-stealth') !== 'true') {
                faviconLink.href = faviconCanvas.toDataURL('image/png');
            }
        } catch(e) {}
    }

    function displayMessage(message) {
        if (messageIds.has(message.id)) return;
        messageIds.add(message.id);
        messagesCache[message.id] = message;

        if (!isChatOpen && message.username !== username && message.timestamp > lastReadTimestamp) {
            unreadCount++;
            updateBadge();
            updateFaviconDot();
            playNotif();
            return;
        }
        if (!isChatOpen) return;

        const area = document.getElementById('chatMessages');
        if (!area) return;
        const shouldScroll = area.scrollHeight - area.scrollTop - area.clientHeight < 100;

        const div = document.createElement('div');
        div.className = 'chat-msg';
        div.dataset.msgId = message.id;
        div.dataset.msgUser = message.username;

        const isOwn = message.username === username;
        let replyHtml = '';
        if (message.replyTo) replyHtml = `<div class="msg-reply-bar"><strong>@${esc(message.replyTo.username)}</strong>: ${esc((message.replyTo.text||'').substring(0,50))}</div>`;
        let imgHtml = '';
        if (message.imageUrl) imgHtml = `<img src="${message.imageUrl}" class="msg-image" onclick="window.open('${message.imageUrl}','_blank')">`;

        const actionsHtml = `
            <div class="msg-actions">
                <button class="msg-action-btn" onclick="showReactionPicker('${message.id}', this)">üòä</button>
                <button class="msg-action-btn" onclick="replyTo('${message.id}','${esc(message.username)}')">‚Ü©</button>
                ${isOwn ? `<button class="msg-action-btn" onclick="editMsg('${message.id}')">‚úèÔ∏è</button>` : ''}
                ${isOwn ? `<button class="msg-action-btn" onclick="deleteMsg('${message.id}')">üóëÔ∏è</button>` : ''}
                <button class="msg-action-btn" onclick="pinMsg('${message.id}')">üìå</button>
            </div>
        `;

        div.innerHTML = `
            ${actionsHtml}
            ${replyHtml}
            <div class="msg-username">${esc(message.username)}${message.edited ? ' <span style="font-size:9px;color:var(--text-faint);">(edited)</span>' : ''}</div>
            <div class="msg-text" id="msgtext-${message.id}">${esc(message.text||'')}</div>
            ${imgHtml}
            <div class="msg-reactions" id="reactions-${message.id}"></div>
            <div class="msg-time">${fmtTime(message.timestamp)}</div>
            <div class="reaction-picker" id="picker-${message.id}">
                ${REACTION_EMOJIS.map(e => `<div class="r-opt" onclick="toggleReaction('${message.id}','${e}')">${e}</div>`).join('')}
            </div>
        `;

        area.appendChild(div);
        while (area.children.length > 100) area.removeChild(area.firstChild);
        if (shouldScroll) area.scrollTop = area.scrollHeight;

        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            window.firebaseChat.listenToReactions(message.id, (data) => {
                renderReactions(message.id, data);
            });
        }
    }

    function renderReactions(msgId, data) {
        const el = document.getElementById('reactions-' + msgId);
        if (!el) return;
        if (!reactionState[msgId]) reactionState[msgId] = {};
        const grouped = {};
        Object.values(data).forEach(r => {
            if (!r.emoji || !r.username) return;
            if (!grouped[r.emoji]) grouped[r.emoji] = [];
            grouped[r.emoji].push(r.username);
            if (r.username === username) reactionState[msgId][r.emoji] = true;
        });
        Object.keys(reactionState[msgId]).forEach(e => {
            if (!grouped[e] || !grouped[e].includes(username)) reactionState[msgId][e] = false;
        });
        el.innerHTML = Object.entries(grouped).map(([emoji, users]) => {
            const mine = reactionState[msgId][emoji] === true;
            const safeEmoji = emoji.replace(/'/g, "\'");
            return `<div class="reaction-pill ${mine ? 'mine' : ''}" onclick="toggleReaction('${msgId}','${safeEmoji}')" title="${users.join(', ')}">${emoji} <span class="r-count">${users.length}</span></div>`;
        }).join('');
    }

    function showReactionPicker(msgId, btn) {
        document.querySelectorAll('.reaction-picker.on').forEach(p => {
            if (p.id !== 'picker-' + msgId) p.classList.remove('on');
        });
        document.getElementById('picker-' + msgId)?.classList.toggle('on');
    }

    document.addEventListener('click', e => {
        if (!e.target.closest('.reaction-picker') && !e.target.closest('.msg-action-btn')) {
            document.querySelectorAll('.reaction-picker.on').forEach(p => p.classList.remove('on'));
        }
    });

    const reactionState = {};
    function toggleReaction(msgId, emoji) {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        const alreadyReacted = reactionState[msgId] && reactionState[msgId][emoji];
        if (alreadyReacted) {
            window.firebaseChat.removeReaction(msgId, emoji, username);
        } else {
            window.firebaseChat.addReaction(msgId, emoji, username);
        }
        document.getElementById('picker-' + msgId)?.classList.remove('on');
    }

    function editMsg(msgId) {
        const textEl = document.getElementById('msgtext-' + msgId);
        if (!textEl) return;
        const orig = messagesCache[msgId]?.text || textEl.textContent;
        textEl.innerHTML = `
            <input class="msg-edit-input" value="${esc(orig)}" id="edit-input-${msgId}">
            <div class="msg-edit-actions">
                <button class="msg-edit-save" onclick="saveEdit('${msgId}')">Save</button>
                <button class="msg-edit-cancel" onclick="cancelEdit('${msgId}','${esc(orig)}')">Cancel</button>
            </div>
        `;
        document.getElementById('edit-input-' + msgId)?.focus();
    }

    function saveEdit(msgId) {
        const inp = document.getElementById('edit-input-' + msgId);
        if (!inp) return;
        const newText = inp.value.trim();
        if (!newText) return;
        if (window.firebaseChat) {
            window.firebaseChat.editMessage(msgId, newText).then(() => {
                const textEl = document.getElementById('msgtext-' + msgId);
                if (textEl) textEl.innerHTML = esc(newText);
                if (messagesCache[msgId]) messagesCache[msgId].text = newText;
            });
        }
    }

    function cancelEdit(msgId, orig) {
        const textEl = document.getElementById('msgtext-' + msgId);
        if (textEl) textEl.innerHTML = orig;
    }

    function deleteMsg(msgId) {
        if (!window.firebaseChat) return;
        window.firebaseChat.deleteMessage(msgId).then(() => {
            const div = document.querySelector(`[data-msg-id="${msgId}"]`);
            if (div) div.remove();
            messageIds.delete(msgId);
            delete messagesCache[msgId];
        });
    }

    function pinMsg(msgId) {
        const msg = messagesCache[msgId];
        if (!msg || !window.firebaseChat) return;
        window.firebaseChat.pinMessage(msgId, (msg.text||'').substring(0, 80), msg.username);
    }

    function unpinMessage() {
        if (window.firebaseChat) window.firebaseChat.unpin();
    }

    function replyTo(id, user) {
        replyingToMessage = { id, username: user };
        document.getElementById('replyBar').classList.add('on');
        document.getElementById('replyToUser').textContent = user;
        document.getElementById('chatInput').focus();
    }

    function cancelReply() {
        replyingToMessage = null;
        document.getElementById('replyBar').classList.remove('on');
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = e => {
                selectedImageBase64 = e.target.result;
                const p = document.getElementById('imgPreview');
                p.src = selectedImageBase64; p.classList.add('on');
                document.getElementById('removeImgBtn').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeImage() {
        selectedImageBase64 = null;
        const p = document.getElementById('imgPreview');
        p.classList.remove('on'); p.src = '';
        document.getElementById('removeImgBtn').style.display = 'none';
        document.getElementById('imageInput').value = '';
    }

    function handleTyping() {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        const inp = document.getElementById('chatInput');
        if (typingTimeout) clearTimeout(typingTimeout);
        if (inp.value.trim().length > 0) {
            window.firebaseChat.setTyping(username, true);
            typingTimeout = setTimeout(() => window.firebaseChat.setTyping(username, false), 3000);
        } else {
            window.firebaseChat.setTyping(username, false);
        }
    }

    function handleTypingUpdate(u, on) {
        if (u === username) return;
        if (on) currentlyTypingUsers.add(u); else currentlyTypingUsers.delete(u);
        const bar = document.getElementById('typingBar');
        const el = document.getElementById('typingUsers');
        if (!currentlyTypingUsers.size) { bar.classList.remove('on'); return; }
        bar.classList.add('on');
        const arr = Array.from(currentlyTypingUsers);
        if (arr.length === 1) el.textContent = `${arr[0]} is typing`;
        else if (arr.length === 2) el.textContent = `${arr[0]} and ${arr[1]} are typing`;
        else el.textContent = `${arr[0]}, ${arr[1]}, and ${arr.length - 2} more are typing`;
    }

    function handleChatKey(e) { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } }

    function containsSlur(t) { return SLUR_PATTERNS.some(p => { p.lastIndex = 0; return p.test(t); }); }

    function applyEmoji(t) {
        let r = t;
        for (const [s, e] of Object.entries(EMOJI_MAP)) r = r.replace(new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), e);
        return r;
    }

    function isGibberish(msg) {
        if (msg.length < 5) return false;
        const lower = msg.toLowerCase().replace(/\s+/g, '');
        if (lower.length < 5) return false;
        const letters = lower.match(/[a-z]/g) || [];
        if (letters.length < 4) return false;
        const vowels = lower.match(/[aeiou]/g) || [];
        if (vowels.length / letters.length < 0.05) return true;
        if (/aa{4,}|bb{4,}|cc{4,}|dd{4,}|ee{4,}|ff{4,}|gg{4,}|hh{4,}|ii{4,}|jj{4,}|kk{4,}|ll{4,}|mm{4,}|nn{4,}|oo{4,}|pp{4,}|qq{4,}|rr{4,}|ss{4,}|tt{4,}|uu{4,}|vv{4,}|ww{4,}|xx{4,}|yy{4,}|zz{4,}/.test(lower)) return true;
        if (/[^aeiou\s]{9,}/.test(lower)) return true;
        const uniq = new Set(letters).size;
        if (letters.length >= 8 && uniq <= 2) return true;
        return false;
    }

    function checkSpam(msg) {
        const now = Date.now();
        const trimmed = msg.trim().toLowerCase();
        msgHistory.push({ text: trimmed, timestamp: now });
        msgHistory = msgHistory.filter(m => now - m.timestamp < 3000);
        if (msgHistory.filter(m => m.text === trimmed).length >= 5) { showSpamWarn(); return true; }
        const recent = msgHistory.filter(m => now - m.timestamp < 4000);
        if (recent.length >= 3 && recent.filter(m => isGibberish(m.text)).length >= 3) { showSpamWarn(); return true; }
        return false;
    }

    function showSpamWarn() {
        const el = document.getElementById('spamWarn');
        const txt = document.getElementById('spamWarnText');
        const inp = document.getElementById('chatInput');
        const btn = document.querySelector('.send-btn');
        if (inp) inp.disabled = true;
        if (btn) btn.disabled = true;
        spamWarnCount++;
        txt.textContent = spamWarnCount === 1 ? "Can you please not spam?" : spamWarnCount === 2 ? "you're very annoying" : "what is wrong with you";
        el.classList.add('on');
        if (spamWarnTimeout) clearTimeout(spamWarnTimeout);
        spamWarnTimeout = setTimeout(() => {
            el.classList.remove('on');
            if (inp) inp.disabled = false;
            if (btn) btn.disabled = false;
        }, 5000);
    }

    function showSlurWarn() {
        const el = document.getElementById('slurWarn');
        const timerEl = document.getElementById('slurTimer');
        const inp = document.getElementById('chatInput');
        const btn = document.querySelector('.send-btn');
        if (inp) { inp.value = ''; inp.disabled = true; }
        if (btn) btn.disabled = true;
        let sec = 10;
        timerEl.textContent = sec;
        el.classList.add('on');
        if (slurInterval) clearInterval(slurInterval);
        if (slurTO) clearTimeout(slurTO);
        slurInterval = setInterval(() => { sec--; timerEl.textContent = sec; if (sec <= 0) clearInterval(slurInterval); }, 1000);
        slurTO = setTimeout(() => {
            el.classList.remove('on');
            if (inp) inp.disabled = false;
            if (btn) btn.disabled = false;
        }, 10000);
    }

    function playNotif() {
        if (localStorage.getItem('desritory-sounds') !== 'true') return;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.value = 880; o.type = 'sine';
            g.gain.setValueAtTime(0.1, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            o.start(); o.stop(ctx.currentTime + 0.3);
        } catch(e) {}
    }

    function sendMessage() {
        const inp = document.getElementById('chatInput');
        let msg = inp.value.trim();
        if (!msg && !selectedImageBase64) return;
        if (msg && msg.length > 200) {
            const el = document.getElementById('spamWarn');
            const txt = document.getElementById('spamWarnText');
            txt.textContent = "Sorry, this message is above the character text limit.";
            el.classList.add('on');
            if (spamWarnTimeout) clearTimeout(spamWarnTimeout);
            spamWarnTimeout = setTimeout(() => { el.classList.remove('on'); }, 4000);
            return;
        }
        if (msg && containsSlur(msg)) { showSlurWarn(); return; }
        if (msg) msg = applyEmoji(msg);
        if (msg && checkSpam(msg)) return;
        if (window.firebaseChat && window.firebaseChat.isInitialized()) {
            const reply = replyingToMessage ? { id: replyingToMessage.id, username: replyingToMessage.username, text: messagesCache[replyingToMessage.id]?.text || '' } : null;
            window.firebaseChat.setTyping(username, false);
            if (typingTimeout) clearTimeout(typingTimeout);
            window.firebaseChat.sendMessage(username, msg, selectedImageBase64, reply)
                .then(() => { inp.value = ''; cancelReply(); removeImage(); })
                .catch(() => alert('Failed to send.'));
        } else {
            alert('Chat not connected.');
        }
    }

    function esc(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }
    function fmtTime(ts) { if (!ts) return ''; try { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } catch { return ''; } }

    function initBackground() {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resize();
        window.addEventListener('resize', () => {
            resize();
            particles.forEach(p => {
                if (p.x > canvas.width) p.x = Math.random() * canvas.width;
                if (p.y > canvas.height) p.y = Math.random() * canvas.height;
            });
        });

        const CONFIG = { count: 80, minR: 2, maxR: 4, speed: 0.6, linkDist: 150, mouseDist: 180, dotOpacity: 0.75, lineOpacity: 0.25, mouseLineOpacity: 0.5 };
        const mouse = { x: -9999, y: -9999, active: false };
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
        window.addEventListener('mouseleave', () => { mouse.active = false; mouse.x = -9999; mouse.y = -9999; });

        function getPrimaryRGB() {
            const hex = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#7c4dff';
            const m = hex.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
            if (m) return [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)];
            return [124, 77, 255];
        }

        function makeParticle() {
            const angle = Math.random() * Math.PI * 2;
            const speed = (Math.random() * 0.5 + 0.2) * CONFIG.speed;
            return { x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * (CONFIG.maxR - CONFIG.minR) + CONFIG.minR, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, opacity: Math.random() * 0.3 + CONFIG.dotOpacity };
        }

        const particles = Array.from({ length: CONFIG.count }, makeParticle);

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const [r, g, b] = getPrimaryRGB();
            const W = canvas.width, H = canvas.height;
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
                if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
            });
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < CONFIG.linkDist) {
                        ctx.strokeStyle = `rgba(${r},${g},${b},${CONFIG.lineOpacity * (1 - dist/CONFIG.linkDist)})`;
                        ctx.lineWidth = 0.8;
                        ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke();
                    }
                }
            }
            if (mouse.active) {
                particles.forEach(p => {
                    const dx = p.x - mouse.x, dy = p.y - mouse.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < CONFIG.mouseDist) {
                        ctx.strokeStyle = `rgba(${r},${g},${b},${CONFIG.mouseLineOpacity * (1 - dist/CONFIG.mouseDist)})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(mouse.x, mouse.y); ctx.stroke();
                    }
                });
            }
            particles.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fillStyle = `rgba(255,255,255,${p.opacity})`; ctx.fill(); });
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            closeFullscreen();
            document.querySelectorAll('.reaction-picker.on').forEach(p => p.classList.remove('on'));
        }

        if (localStorage.getItem('desritory-panic') === 'true') {
            const panicKey = localStorage.getItem('desritory-panic-key') || "'";
            if (e.key === panicKey && !e.ctrlKey) {
                const url = localStorage.getItem('desritory-panic-url') || 'https://google.com';
                window.location.href = url;
                return;
            }
        }

        if (e.ctrlKey && !e.shiftKey && !e.altKey) {
            const panels = ['home','proxy','games','chat','settings'];
            const num = parseInt(e.key);
            if (num >= 1 && num <= 5) {
                e.preventDefault();
                showPanel(panels[num - 1]);
                return;
            }
        }

        if (e.key === '/' && !e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
            e.preventDefault();
            if (currentPanel === 'games') {
                document.getElementById('gamesSearch')?.focus();
            } else if (currentPanel === 'proxy') {
                document.getElementById('proxyInput')?.focus();
            } else {
                showPanel('proxy');
                setTimeout(() => document.getElementById('proxyInput')?.focus(), 100);
            }
        }
    });

    const CURRENT_VERSION = '4.0.0';
    const savedVersion = localStorage.getItem('desritory-version');
    if (savedVersion !== CURRENT_VERSION) {
        const su = localStorage.getItem('desritory-username');
        const so = localStorage.getItem('desritory-ownerid');
        localStorage.clear();
        if (su) localStorage.setItem('desritory-username', su);
        if (so) localStorage.setItem('desritory-ownerid', so);
        localStorage.setItem('desritory-version', CURRENT_VERSION);
    }

    applyTheme(localStorage.getItem('desritory-theme') || 'slate');
    buildThemeGrid();
    renderGames();
    renderApps();
    updateUsernameDisplay();

    if (localStorage.getItem('desritory-stealth') === 'true') {
        applyStealth(true);
        document.getElementById('nav-stealth').classList.add('stealth-on');
    }

    const savedSE = localStorage.getItem('desritory-se') || 'google';
    const seBtn = document.getElementById('se-' + savedSE);
    if (seBtn) { document.querySelectorAll('.se-btn').forEach(b => b.classList.remove('active')); seBtn.classList.add('active'); }

    if (localStorage.getItem('desritory-cloak') === 'true') {
        document.getElementById('cloakToggle').classList.add('on');
        const savedPreset = localStorage.getItem('desritory-cloak-preset') || 'google';
        const presetRow = document.getElementById('cloakPresetRow');
        const presetSelect = document.getElementById('cloakPresetSelect');
        if (presetRow) presetRow.style.display = 'flex';
        if (presetSelect) presetSelect.value = savedPreset;
        applyCloakPreset(savedPreset);
    }

    if (localStorage.getItem('desritory-panic') === 'true') {
        document.getElementById('panicToggle').classList.add('on');
        const row = document.getElementById('panicKeyRow');
        const inp = document.getElementById('panicKeyInput');
        const urlInp = document.getElementById('panicUrlInput');
        if (row) row.style.display = 'flex';
        if (inp) inp.value = localStorage.getItem('desritory-panic-key') || "'";
        if (urlInp) urlInp.value = localStorage.getItem('desritory-panic-url') || 'https://google.com';
    } else {
        const urlInp = document.getElementById('panicUrlInput');
        if (urlInp) urlInp.value = localStorage.getItem('desritory-panic-url') || 'https://google.com';
    }

    const savedFS = localStorage.getItem('desritory-fontsize') || 'medium';
    const fsBtn = document.getElementById('fs-' + savedFS);
    if (fsBtn) {
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
        fsBtn.classList.add('active');
        const map = { small: '11px', medium: '13px', large: '15px' };
        document.documentElement.style.setProperty('--font-size-base', map[savedFS]);
    }

    const savedCustomColor = localStorage.getItem('desritory-custom-color');
    if (savedCustomColor) {
        applyCustomColor(savedCustomColor);
        const picker = document.getElementById('customColorPicker');
        if (picker) picker.value = savedCustomColor;
        const hexEl = document.getElementById('customColorHex');
        if (hexEl) hexEl.textContent = savedCustomColor;
    } else {
        const currentTheme = localStorage.getItem('desritory-theme') || 'slate';
        const picker = document.getElementById('customColorPicker');
        if (picker) picker.value = themes[currentTheme]?.primary || '#888888';
        const hexEl = document.getElementById('customColorHex');
        if (hexEl) hexEl.textContent = themes[currentTheme]?.primary || '#888888';
    }

    if (localStorage.getItem('desritory-sounds') === 'true') document.getElementById('soundToggle').classList.add('on');
    if (localStorage.getItem('desritory-particles') === 'false') {
        document.getElementById('particlesToggle').classList.remove('on');
        document.getElementById('bgCanvas').style.display = 'none';
    }

    initBackground();
    updateFaviconDot();

    window.addEventListener('beforeunload', () => {
        if (username && window.firebaseChat && window.firebaseChat.isInitialized()) window.firebaseChat.releaseName(username);
    });

    document.addEventListener('visibilitychange', () => {
        if (!window.firebaseChat || !window.firebaseChat.isInitialized() || !username) return;
        if (document.visibilityState === 'hidden') window.firebaseChat.releaseName(username);
        if (document.visibilityState === 'visible') window.firebaseChat.claimName(username, myOwnerId);
    });
</script>
</body>
</html>
